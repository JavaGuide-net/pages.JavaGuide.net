import{_ as s,o as n,h as a,Q as p}from"./chunks/framework.da611722.js";const l="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAArQAAAApCAYAAADEWbpuAAAAAXNSR0ICQMB9xQAAAAlwSFlzAAASdAAAEnQB3mYfeAAAABl0RVh0U29mdHdhcmUATWljcm9zb2Z0IE9mZmljZX/tNXEAAAmtSURBVHja7d2/bxNpHsdxO5ug00lIWwA6ThSnbYiIQEsTRJzdCxIlDS0piNDG2aVIQ4G24URHA3byT1Bcdxs7zQHNXbXSXYlwkJCuvWK1Ym91SuKZfZ7xjDN+/Dwz4x9Bnuf7/kjfBTxPZh7HX9uvTB7PVp4+fVqhKIqiKIqiqLJW9J9bt27tXr58+d9U+Us/ljR28bpz58739I0ftby8/NdKpVKlr4vVxsbG2uLi4r/onfLXtWvX/l6v139PXxer7e3tRfV9+5HeKX8tLS39U/X+Jf3aHz24Fy5c+O/Lly/DN2/eUCUu/Rjqx5IXrOKlnxCNRoP+8aCq1WoIaIvX2traXxRqg9evX9M/Ja/z58//+vDhwy/o62J19+7d+7dv3/7l1atX9E/J6+rVqx/X19dvh2F4AtoPHz6EpNzRjyGgHR20+klByh9AOzponzx5EqjQPCXPpUuXPgLa0UB77969n7vdLs1T8qyurv50//59QOtbAC2glRxAC2ilBtACWqkBtJ4G0AJayQG0gFZqAC2glRpA62kALaCVHEALaKUG0AJaqQG0ngbQAlrJAbSAVmoALaCVGkDraQAtoJUcQAtopQbQAlqpAbSeBtACWskBtIBWagAtoJUaQOtpAC2glRxAC2ilBtACWqkBtJ4G0AJayQG0gFZqAC2glRpA62kALaCVHEALaKUG0AJaqQG0ngbQAlrJAbSAVmoALaCVGkDraQAtoJUcQAtopQbQAlqpAbSeBtACWskBtIBWagAtoJWaMUF7EIYrlTCsrER/7addV7c3k3+o7ZXhaqe/3lL1ds6xbfut52xPjlt07nljbPMvMIfM++vap+N71TzI/C4B2lkCbVsLK7tfhraragWDvdgJMvq1mjEm2W4cPwjz5+DsWbXPmhrfDk7mULPNYas3hyAcHFc199ky5jNZAO0sglb1zdyc0U+bYdgNMrar2lPQCFTfrKptVdVf71Lw2Ff9VWvG+8gb04m3u46fMQdbbbZS87Lt07ZN1Yt3U+11M4DWZ9Duh+H8Z0YvfhOGR6qnvppXz5Ujo7fU+IX54d7922E87qD3dekeffE27t/3Yfi1sU0f6/DYU9CurKTeVC3gM9Glt5tIPGgab+45qWeht8hx8+Y+wv1rjzFH5/117dN2e9tAOqCdadDWqzk9W3X3bMfoxcDVr9WMMfH2djDeHHXPVk0AO0A7NAcDtNFxWqf6hq4DaGcQtFtz8WMf2J8HNbW9YWBPY3ROA7XT2x71V+MEoTbQOsfEoG113f2XNceDHTWXugHgg4x92rYpYHymbts7PrXnAKD1GLTfKmDWfwjDY7N53ltAG9/WeDvYs/vfqR6sheHbo/jvdQdSY9DuHZ766/W0Mhlo2wYgkzfQCG0GXNNfl37zHgW0zv3mbU8fN2fuRe5fFmgLzXFS0Ko0DWwbAbQzAtqJe7ad6kUN346jX6sZY+Lb9RnfwDGHas4ci4K23en92Z9DCrTJcTqn/+oIaGcMtBEG1Zvou2DE7TEKG61eX7XeDcLXBlrnmBzQ9ufQzZijC7THBUGrsrOq5tMw9jO9AFpPQft+NwznNURtvWYBbTR+1TI+hqo+E9tJxhzZ96nH/aBAW5LVGBOCNn7TTICWvIGmbzNjnr0cBbRZ+83bXk/9qjRr7kXun20ZQBq9WXPMA+3QPh2gzTkOoJ0R0E7cs8348Q96OExgaQWta4xlyUH6h8pkDkFGzxYGbXoOwSBozbO1O7WTZQ6t6b65A9oZA+1+3BMuxGVtj86aNuIfyrq9PkpgaQWta4xlyUH6jPD+lgWs6ZbPAK11nw7Q5h1nwgBaT0GbnE09cpxNNUGbNf67hZMzvbtfq3H6dfimAVvLkoPnb0+tb6eRyUGbxmJR0I57hnZSHNiAaM69yP3LOkM7KWiLnqEFtOUCbTDG9nr6DG08YCv+lb0LtNYxOUsOpg1a2xxsoO0f33H7BAG0noG2mZyhjXEYIXdP/dsBWuuYnDO0k4C28JKDENAC2jGfQ2OC9tABWnMpQgLb58YaWjlLDtJIW1H/bhZbctA23iw/1ZKDdoG5F7l/s7LkIOMDdIB2hpYcZP2avb/d9rhXT5a9JFBMxreabtAOjckBbaE5jgja/hwaqSUHO/bjAFpBSw66I26P19YmywgSHCbj9xpu0A6NOc0lB93RlhxsudYSTx5Ay5KDwfFHw6/dXzmgqhG8qp4vR91QLmgTYOlT0mnwmeCKxtSH3yxH/VCYuXa0aUA087h5cx/h/rXHmOM0QGv7cJ0RQDsjoNXRZysjsAX2nq1Vhz+IovutmrrKRRqjzZqlX6sZY3LW0Pbn2LDPcRzQRm/ctd6vq9JY1cdJliOk+xnQ+g3a6LGfG/ywVtQjO3EvxPjTZ1TTc9D4i87cWjAabauk9nmQM6bgh8Jccxx7De3x4Icks9A8hQBaT0Gro8+s1p7H4Iyzu9vr7QSp/U0xSDf10oL0eH0mdtN+5lZvM0Erag2tedvQpa9clyoKc4CXc2znpb7yjjvC3J1jbMdIAzNjjqOsoY32WfD7aATQzhBo+5e0yujZmuuyXhYo9q8o0Cw4xnapLPMHIsuYdM+OA9r0HAbOUNWGLxHGZbv8B61tvelm+ge5ApfAGsBoclWDRsExtst2GZf4yppjBNqt/DW0/X0eFLhM2PQDaD0GrW1d6zcarJ3h22++sN+evvSWPiM7P+e4LJftsl03HR8gKzVoyawH0M4SaMmnDqCdRdCSTxFA6zNoSVZmELQZ/9OFjMtUkcEAWkArOYAW0EoNoAW0UsMZWk8DaAGt5ABaQCs1gBbQSg2g9TSAFtBKDqAFtFIDaAGt1ABaTwNoAa3kAFpAKzWAFtBKDaD1NIAW0EoOoAW0UgNoAa3UAFpPA2gBreQAWkArNYAW0EoNoPU0gBbQSg6gBbRSA2gBrdQAWk8DaAGt5ABaQCs1gBbQSg2g9TSAFtBKDqAFtFIDaAGt1ABaTwNoAa3kAFpAKzWAFtBKDaD1NIAW0EoOoAW0UgNoAa3UAFpPA2gBreQAWkArNYAW0EoNoPU0gBbQSg6gBbRSA2jHA+3x8THNU/IMgfbixYv/uX79+s83btz4iSpv6cdQP5a8YBWvpaWlf1y5cuUj/VP+WlhYOAS0o4FWQehXeqf8debMmaPt7e0/0tfFQXvu3Ln/LS8v0z8lr7Nnz/5/fX39BLSPHj3608bGxhpV/tKPJS9Yxevx48d/oG/8KPWGvkhPj9T7n9M3flS9Xv+Sni5ez549+92DBw/+TO/4URqz+nGluSmKoiiKoqhS128No3Px1moxggAAAABJRU5ErkJggg==",o="/assets/JavaGuide_Zookeeper_实践与原理_Server_Client_Watcher事件.647ef332.png",e="/assets/JavaGuide_Zookeeper_实践与原理_Processor_链式处理.a95cd3ef.png",r="/assets/JavaGuide_Zookeeper_实践与原理_Watcher_Server_处理流程详细图.155ebe94.png",C=JSON.parse('{"title":"zookeeper的实践与原理 | JavaGuide","description":"","frontmatter":{"head":[["link",{"rel":"canonical","href":"https://javaguide.net/百万架构师/协调服务-zookeeper/zookeeper的实践与原理.html"}],["meta",{"name":"keywords","content":"zookeeper的实践与原理 , JavaGuide , JavaGuide官网, Java面试指南, Java基础, 多线程, JVM, 虚拟机, 数据库, MySQL, Spring, Redis, MyBatis, 系统设计, 分布式, RPC, 高可用, 高并发"}],["meta",{"name":"og:url","content":"https://JavaGuide.net"}],["meta",{"name":"og:type","content":"website"}],["meta",{"name":"og:image","content":"https://javaguide.net/JavaGuide-og.png"}],["meta",{"name":"og:title","content":"zookeeper的实践与原理 | JavaGuide | Java面试指南 | JavaGuide官网"}],["meta",{"name":"og:description","content":"zookeeper的实践与原理 | JavaGuide | Java面试指南 | JavaGuide官网 | 「JavaGuide.net」一份涵盖大部分 Java 程序员所需要掌握的核心知识。准备 Java 面试，首选 JavaGuide.net ！"}],["meta",{"name":"twitter:site","content":"https://javaguide.net"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:creator","content":"nogeek.cn"}],["meta",{"name":"twitter:title","content":"zookeeper的实践与原理 | JavaGuide | Java面试指南 | JavaGuide官网"}],["meta",{"name":"twitter:description","content":"zookeeper的实践与原理 | JavaGuide | Java面试指南 | JavaGuide官网 | 「JavaGuide.net」一份涵盖大部分 Java 程序员所需要掌握的核心知识。准备 Java 面试，首选 JavaGuide.net ！"}],["meta",{"name":"twitter:image","content":"https://javaguide.net/JavaGuide-og.png"}],["meta",{"name":"baidu-site-verification","content":"codeva-MXEPYsXKGk"}],["meta",{"name":"msvalidate.01","content":"9F2D57CFC59E8031212A166878638B15"}]]},"headers":[],"relativePath":"百万架构师/协调服务-zookeeper/zookeeper的实践与原理.md","filePath":"百万架构师/协调服务-zookeeper/zookeeper的实践与原理.md","lastUpdated":1740370683000}'),t={name:"百万架构师/协调服务-zookeeper/zookeeper的实践与原理.md"},c=p(`<ol><li><p>数据存储</p></li><li><p>基于 Java API初探zookeeper的使用</p></li><li><p>深入分析Watcher机制的实现原理</p></li><li><p>Curator客户端的使用，简单高效</p></li></ol><h1 id="数据存储" tabindex="-1">数据存储 <a class="header-anchor" href="#数据存储" aria-label="Permalink to &quot;数据存储&quot;">​</a></h1><p>​ 基于znode，基于文件系统风格的，树形结构的文件模型，和内存数据库差不多，基于增删改查的命令去操作数据库，整个数据库包括整个树形结构的内容，比如说我们的节点目录，节点路径和权限信息，而且zookeeper它会定时去把这些信息数据存储到磁盘上。</p><p>​ 使用DataTree管理整个数据存储，主要用来存储节点路径和数据的内容。底层是一个典型的基于ConcurrentHashMap的一个存储结构。</p><h3 id="事务日志" tabindex="-1">事务日志 <a class="header-anchor" href="#事务日志" aria-label="Permalink to &quot;事务日志&quot;">​</a></h3><p>创造一个节点或者进行事务操作的时候，都会记录一个事务日志，</p><p><code>zoo.cfg</code> 文件中 ， datadir</p><h3 id="快照日志" tabindex="-1">快照日志 <a class="header-anchor" href="#快照日志" aria-label="Permalink to &quot;快照日志&quot;">​</a></h3><p>它会记录zookeeper的某个时刻的快照，记录整个zookeeper全量数据的内容，类似于我们数据备份的一个概念，并且他会把这些文件放在指定的目录下去做一个存储，也是基于datadir这样一个路径去做一个存储</p><h3 id="运行时日志" tabindex="-1">运行时日志 <a class="header-anchor" href="#运行时日志" aria-label="Permalink to &quot;运行时日志&quot;">​</a></h3><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">bin/zookeeper.out</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">bin/zookeeper.out</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>我们可以通过它来看zookeeper运行时的一些情况。</p><p>实际应用过程中，我们会把事务日志单独挂载到一个磁盘上，我们的每一个请求，事务请求都会做一个输入日志的记录，那这个磁盘的读写的性能，将影响到zookeeper本身的操作性能。</p><h1 id="基于java-api初探zookeeper的使用" tabindex="-1">基于Java API初探zookeeper的使用 <a class="header-anchor" href="#基于java-api初探zookeeper的使用" aria-label="Permalink to &quot;基于Java API初探zookeeper的使用&quot;">​</a></h1><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">zkCli.sh</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">zkCli.sh</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>基于控制台</p><div class="language-xml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">dependency</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">   &lt;</span><span style="color:#85E89D;">groupId</span><span style="color:#E1E4E8;">&gt;com.apache.zookeeper&lt;/</span><span style="color:#85E89D;">groupId</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">   &lt;</span><span style="color:#85E89D;">artifactId</span><span style="color:#E1E4E8;">&gt;zookeeper&lt;/</span><span style="color:#85E89D;">artifactId</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">   &lt;</span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">&gt;3.4.8&lt;/</span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">dependency</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">&lt;</span><span style="color:#22863A;">dependency</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">   &lt;</span><span style="color:#22863A;">groupId</span><span style="color:#24292E;">&gt;com.apache.zookeeper&lt;/</span><span style="color:#22863A;">groupId</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">   &lt;</span><span style="color:#22863A;">artifactId</span><span style="color:#24292E;">&gt;zookeeper&lt;/</span><span style="color:#22863A;">artifactId</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">   &lt;</span><span style="color:#22863A;">version</span><span style="color:#24292E;">&gt;3.4.8&lt;/</span><span style="color:#22863A;">version</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">&lt;/</span><span style="color:#22863A;">dependency</span><span style="color:#24292E;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>引入包以后就可以使用相应的API去做相应的操作，</p><h3 id="代码" tabindex="-1">代码 <a class="header-anchor" href="#代码" aria-label="Permalink to &quot;代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConnectionDemo</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            ZooKeeper zooKeeper </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ZooKeeper</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">&quot;192.168.136.130:2181&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(zooKeeper.</span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (IOException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (InterruptedException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConnectionDemo</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            ZooKeeper zooKeeper </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ZooKeeper</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#032F62;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#032F62;">&quot;192.168.136.130:2181&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(zooKeeper.</span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (IOException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (InterruptedException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="控制台" tabindex="-1">控制台 <a class="header-anchor" href="#控制台" aria-label="Permalink to &quot;控制台&quot;">​</a></h3><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">log4j:WARN No appenders could be found </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">logger</span><span style="color:#E1E4E8;"> (org.apache.zookeeper.ZooKeeper).</span></span>
<span class="line"><span style="color:#E1E4E8;">log4j:WARN Please initialize the log4j system properly.</span></span>
<span class="line"><span style="color:#E1E4E8;">log4j:WARN See http:</span><span style="color:#6A737D;">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span>
<span class="line"><span style="color:#E1E4E8;">CONNECTING</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">log4j:WARN No appenders could be found </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">logger</span><span style="color:#24292E;"> (org.apache.zookeeper.ZooKeeper).</span></span>
<span class="line"><span style="color:#24292E;">log4j:WARN Please initialize the log4j system properly.</span></span>
<span class="line"><span style="color:#24292E;">log4j:WARN See http:</span><span style="color:#6A737D;">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span>
<span class="line"><span style="color:#24292E;">CONNECTING</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>连接以后</p><p>显示连接状态为 connecting 等待以后connected</p><p>引入watcher机制，new watcher() 直接输出链接状态 connected</p><p><img src="`+l+`" alt="JavaGuide_Zookeeper_实践与原理_Client四个状态.png"></p><p>连接，</p><h3 id="代码-1" tabindex="-1">代码 <a class="header-anchor" href="#代码-1" aria-label="Permalink to &quot;代码&quot;">​</a></h3><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConnectionDemo</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            ZooKeeper zooKeeper </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ZooKeeper</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">&quot;192.168.136.130:2181&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(zooKeeper.</span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            Thread.</span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(zooKeeper.</span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            zooKeeper.</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (IOException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (InterruptedException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConnectionDemo</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            ZooKeeper zooKeeper </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ZooKeeper</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#032F62;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#032F62;">&quot;192.168.136.130:2181&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(zooKeeper.</span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            Thread.</span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(zooKeeper.</span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            zooKeeper.</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (IOException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (InterruptedException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="控制台-1" tabindex="-1">控制台 <a class="header-anchor" href="#控制台-1" aria-label="Permalink to &quot;控制台&quot;">​</a></h3><div class="language-verilog vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">verilog</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">log4j:WARN No appenders could be found </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> logger (org.apache.zookeeper.ZooKeeper).</span></span>
<span class="line"><span style="color:#E1E4E8;">log4j:WARN Please initialize the log4j system properly.</span></span>
<span class="line"><span style="color:#E1E4E8;">log4j:WARN See http:</span><span style="color:#6A737D;">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span>
<span class="line"><span style="color:#E1E4E8;">CONNECTING</span></span>
<span class="line"><span style="color:#E1E4E8;">CONNECTED</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">log4j:WARN No appenders could be found </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> logger (org.apache.zookeeper.ZooKeeper).</span></span>
<span class="line"><span style="color:#24292E;">log4j:WARN Please initialize the log4j system properly.</span></span>
<span class="line"><span style="color:#24292E;">log4j:WARN See http:</span><span style="color:#6A737D;">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span>
<span class="line"><span style="color:#24292E;">CONNECTING</span></span>
<span class="line"><span style="color:#24292E;">CONNECTED</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Stat 对应控制台的各项属性</p><h2 id="watcher实现保证连接成功" tabindex="-1">Watcher实现保证连接成功 <a class="header-anchor" href="#watcher实现保证连接成功" aria-label="Permalink to &quot;Watcher实现保证连接成功&quot;">​</a></h2><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConnectionDemo</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> CountDownLatch  countDownLatch </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CountDownLatch</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            ZooKeeper zooKeeper </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ZooKeeper</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">&quot;192.168.136.130:2181&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Watcher</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#6A737D;">// 为了保证连接的成功状态</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">process</span><span style="color:#E1E4E8;">(WatchedEvent </span><span style="color:#FFAB70;">watchedEvent</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      </span><span style="color:#6A737D;">// 连接成功以后触发watcher事件</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(Event.KeeperState.SyncConnected </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> watchedEvent.</span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">()){</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          </span><span style="color:#6A737D;">// 如果收到了服务端的响应事件，连接成功</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          </span><span style="color:#6A737D;">// 连接成功以后做一个递减。</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          countDownLatch.</span><span style="color:#B392F0;">countDown</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      }</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  }</span></span>
<span class="line"><span style="color:#E1E4E8;">                              });</span></span>
<span class="line"><span style="color:#E1E4E8;">            countDownLatch.</span><span style="color:#B392F0;">await</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(zooKeeper.</span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">());</span><span style="color:#6A737D;">//CONNECTED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            zooKeeper.</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (IOException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (InterruptedException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConnectionDemo</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> CountDownLatch  countDownLatch </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CountDownLatch</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            ZooKeeper zooKeeper </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ZooKeeper</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#032F62;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#032F62;">&quot;192.168.136.130:2181&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Watcher</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#6A737D;">// 为了保证连接的成功状态</span></span>
<span class="line"><span style="color:#24292E;">                                  @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">process</span><span style="color:#24292E;">(WatchedEvent </span><span style="color:#E36209;">watchedEvent</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                                      </span><span style="color:#6A737D;">// 连接成功以后触发watcher事件</span></span>
<span class="line"><span style="color:#24292E;">                                      </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(Event.KeeperState.SyncConnected </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> watchedEvent.</span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">()){</span></span>
<span class="line"><span style="color:#24292E;">                                          </span><span style="color:#6A737D;">// 如果收到了服务端的响应事件，连接成功</span></span>
<span class="line"><span style="color:#24292E;">                                          </span><span style="color:#6A737D;">// 连接成功以后做一个递减。</span></span>
<span class="line"><span style="color:#24292E;">                                          countDownLatch.</span><span style="color:#6F42C1;">countDown</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                                      }</span></span>
<span class="line"><span style="color:#24292E;">                                  }</span></span>
<span class="line"><span style="color:#24292E;">                              });</span></span>
<span class="line"><span style="color:#24292E;">            countDownLatch.</span><span style="color:#6F42C1;">await</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(zooKeeper.</span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">());</span><span style="color:#6A737D;">//CONNECTED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            zooKeeper.</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (IOException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (InterruptedException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="控制台-2" tabindex="-1">控制台 <a class="header-anchor" href="#控制台-2" aria-label="Permalink to &quot;控制台&quot;">​</a></h3><div class="language-verilog vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">verilog</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">log4j:WARN No appenders could be found </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> logger (org.apache.zookeeper.ZooKeeper).</span></span>
<span class="line"><span style="color:#E1E4E8;">log4j:WARN Please initialize the log4j system properly.</span></span>
<span class="line"><span style="color:#E1E4E8;">log4j:WARN See http:</span><span style="color:#6A737D;">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span>
<span class="line"><span style="color:#E1E4E8;">CONNECTED</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">log4j:WARN No appenders could be found </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> logger (org.apache.zookeeper.ZooKeeper).</span></span>
<span class="line"><span style="color:#24292E;">log4j:WARN Please initialize the log4j system properly.</span></span>
<span class="line"><span style="color:#24292E;">log4j:WARN See http:</span><span style="color:#6A737D;">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span>
<span class="line"><span style="color:#24292E;">CONNECTED</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数都需要传进去version</p><p><code>Stat.getVersion()</code></p><h2 id="增删改查" tabindex="-1">增删改查 <a class="header-anchor" href="#增删改查" aria-label="Permalink to &quot;增删改查&quot;">​</a></h2><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ConnectionDemo</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> CountDownLatch  countDownLatch </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CountDownLatch</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">           ZooKeeper zooKeeper </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ZooKeeper</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                             </span><span style="color:#9ECBFF;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                             </span><span style="color:#9ECBFF;">&quot;192.168.136.130:2181&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                             </span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Watcher</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">                                 </span><span style="color:#6A737D;">// 为了保证连接的成功状态</span></span>
<span class="line"><span style="color:#E1E4E8;">                                 @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">                                 </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">process</span><span style="color:#E1E4E8;">(WatchedEvent </span><span style="color:#FFAB70;">watchedEvent</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                                     </span><span style="color:#6A737D;">// 连接成功以后触发watcher事件</span></span>
<span class="line"><span style="color:#E1E4E8;">                                     </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(Event.KeeperState.SyncConnected </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> watchedEvent.</span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">()){</span></span>
<span class="line"><span style="color:#E1E4E8;">                                         </span><span style="color:#6A737D;">// 如果收到了服务端的响应事件，连接成功</span></span>
<span class="line"><span style="color:#E1E4E8;">                                         </span><span style="color:#6A737D;">// 连接成功以后做一个递减。</span></span>
<span class="line"><span style="color:#E1E4E8;">                                         countDownLatch.</span><span style="color:#B392F0;">countDown</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                                     }</span></span>
<span class="line"><span style="color:#E1E4E8;">                                 }</span></span>
<span class="line"><span style="color:#E1E4E8;">                             });</span></span>
<span class="line"><span style="color:#E1E4E8;">           countDownLatch.</span><span style="color:#B392F0;">await</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">           System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(zooKeeper.</span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">());</span><span style="color:#6A737D;">//CONNECTED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">// 添加节点</span></span>
<span class="line"><span style="color:#E1E4E8;">           zooKeeper.</span><span style="color:#B392F0;">create</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/java-con-darian&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;232&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getBytes</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">                            ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">           Stat stat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Stat</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">//Stat和我们在控制台看到的属性是一样的。</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">// 得到节点的值</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">byte</span><span style="color:#E1E4E8;">[] dataBytes </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zooKeeper.</span><span style="color:#B392F0;">getData</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/java-con-darian&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, stat);</span></span>
<span class="line"><span style="color:#E1E4E8;">           System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">String</span><span style="color:#E1E4E8;">(dataBytes));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">           Thread.</span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">// 修改节点的值，乐观锁的概念</span></span>
<span class="line"><span style="color:#E1E4E8;">           zooKeeper.</span><span style="color:#B392F0;">setData</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/java-con-darian&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;55&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getBytes</span><span style="color:#E1E4E8;">(),stat.</span><span style="color:#B392F0;">getVersion</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">byte</span><span style="color:#E1E4E8;">[] updateBytes </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zooKeeper.</span><span style="color:#B392F0;">getData</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/java-con-darian&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, stat);</span></span>
<span class="line"><span style="color:#E1E4E8;">           System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">String</span><span style="color:#E1E4E8;">(updateBytes));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">           zooKeeper.</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/java-con-darian&quot;</span><span style="color:#E1E4E8;">, stat.</span><span style="color:#B392F0;">getVersion</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">           zooKeeper.</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">// 当前线程进行阻塞</span></span>
<span class="line"><span style="color:#E1E4E8;">           System.in.</span><span style="color:#B392F0;">read</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (IOException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">           e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">       } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (InterruptedException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">           e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">       } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (KeeperException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">           e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ConnectionDemo</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> CountDownLatch  countDownLatch </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CountDownLatch</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">           ZooKeeper zooKeeper </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ZooKeeper</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                             </span><span style="color:#032F62;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                             </span><span style="color:#032F62;">&quot;192.168.136.130:2181&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                             </span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Watcher</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">                                 </span><span style="color:#6A737D;">// 为了保证连接的成功状态</span></span>
<span class="line"><span style="color:#24292E;">                                 @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">                                 </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">process</span><span style="color:#24292E;">(WatchedEvent </span><span style="color:#E36209;">watchedEvent</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                                     </span><span style="color:#6A737D;">// 连接成功以后触发watcher事件</span></span>
<span class="line"><span style="color:#24292E;">                                     </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(Event.KeeperState.SyncConnected </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> watchedEvent.</span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">()){</span></span>
<span class="line"><span style="color:#24292E;">                                         </span><span style="color:#6A737D;">// 如果收到了服务端的响应事件，连接成功</span></span>
<span class="line"><span style="color:#24292E;">                                         </span><span style="color:#6A737D;">// 连接成功以后做一个递减。</span></span>
<span class="line"><span style="color:#24292E;">                                         countDownLatch.</span><span style="color:#6F42C1;">countDown</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                                     }</span></span>
<span class="line"><span style="color:#24292E;">                                 }</span></span>
<span class="line"><span style="color:#24292E;">                             });</span></span>
<span class="line"><span style="color:#24292E;">           countDownLatch.</span><span style="color:#6F42C1;">await</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">           System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(zooKeeper.</span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">());</span><span style="color:#6A737D;">//CONNECTED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">// 添加节点</span></span>
<span class="line"><span style="color:#24292E;">           zooKeeper.</span><span style="color:#6F42C1;">create</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/java-con-darian&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;232&quot;</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">                            ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">           Stat stat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Stat</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">//Stat和我们在控制台看到的属性是一样的。</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">// 得到节点的值</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">byte</span><span style="color:#24292E;">[] dataBytes </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zooKeeper.</span><span style="color:#6F42C1;">getData</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/java-con-darian&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, stat);</span></span>
<span class="line"><span style="color:#24292E;">           System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(dataBytes));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">           Thread.</span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">// 修改节点的值，乐观锁的概念</span></span>
<span class="line"><span style="color:#24292E;">           zooKeeper.</span><span style="color:#6F42C1;">setData</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/java-con-darian&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;55&quot;</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">(),stat.</span><span style="color:#6F42C1;">getVersion</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">byte</span><span style="color:#24292E;">[] updateBytes </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zooKeeper.</span><span style="color:#6F42C1;">getData</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/java-con-darian&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, stat);</span></span>
<span class="line"><span style="color:#24292E;">           System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(updateBytes));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">           zooKeeper.</span><span style="color:#6F42C1;">delete</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/java-con-darian&quot;</span><span style="color:#24292E;">, stat.</span><span style="color:#6F42C1;">getVersion</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">           zooKeeper.</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">// 当前线程进行阻塞</span></span>
<span class="line"><span style="color:#24292E;">           System.in.</span><span style="color:#6F42C1;">read</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (IOException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">           e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">       } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (InterruptedException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">           e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">       } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (KeeperException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">           e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h3 id="控制台-3" tabindex="-1">控制台 <a class="header-anchor" href="#控制台-3" aria-label="Permalink to &quot;控制台&quot;">​</a></h3><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">CONNECTED</span></span>
<span class="line"><span style="color:#79B8FF;">232</span></span>
<span class="line"><span style="color:#79B8FF;">55</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">CONNECTED</span></span>
<span class="line"><span style="color:#005CC5;">232</span></span>
<span class="line"><span style="color:#005CC5;">55</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h1 id="事件机制" tabindex="-1">事件机制 <a class="header-anchor" href="#事件机制" aria-label="Permalink to &quot;事件机制&quot;">​</a></h1><p>我们对一个节点发起订阅以后，那么对这个节点发起的任何变化，它都会有一个触发，发给触发前绑定的客户端，相当于一个发布订阅的功能。</p><p>通过watcher机制，保证刚开始的连接状态是connected.</p><p>Watcher机制是zookeeper里边非常重要的一个特性，那么我们在zookeeper上创建节点的时候，我们可以绑定监听事件，比如说，我们可以监听节点的变更，删除，子节点变更的一些事件，通过这些事件，可以实现zookeeper的分布式锁 ，集群管理的一些功能。</p><p>Watcher特性：当数据发生变化的时候，zookeeper会产生一个watcher事件，并且发送到客户端，但客户端只会收到一次通知，如果后续这个节点再次发生变化，那么之前设置的watcher的客户端不会再次收到消息（watcher机制是一次性操作）。可以通过循环监听达到永久的监听效果。</p><h3 id="如何注册事件机制" tabindex="-1">如何注册事件机制 <a class="header-anchor" href="#如何注册事件机制" aria-label="Permalink to &quot;如何注册事件机制&quot;">​</a></h3><p>通过三个操作来绑定事件：getData、Exists、getChildren</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>getData</td><td>通过一个节点获得一个节点的数据</td></tr><tr><td>Exists</td><td>判断这个节点是否存在</td></tr><tr><td>getChildren</td><td>可以拿到当前节点的所有子节点</td></tr></tbody></table><p>​ 通过设置节点的路径，相当于给节点绑定了事件</p><h3 id="如何触发事件" tabindex="-1">如何触发事件？ <a class="header-anchor" href="#如何触发事件" aria-label="Permalink to &quot;如何触发事件？&quot;">​</a></h3><p>​ 凡是事务类型的操作，都会触发监听操作 <code>create</code> / <code>delete</code> / <code>setData</code></p><p><code>zookeeper.exists(event.getPath().true);</code></p><p><code>true</code> ：默认使用全局的默认事件。</p><h4 id="代码-2" tabindex="-1">代码 <a class="header-anchor" href="#代码-2" aria-label="Permalink to &quot;代码&quot;">​</a></h4><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">WatcherDemo</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> CountDownLatch countDownLatch </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CountDownLatch</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ZooKeeper zooKeeper </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ZooKeeper</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">&quot;192.168.136.130:2181&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                              </span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Watcher</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#6A737D;">// 为了保证连接的成功状态</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">process</span><span style="color:#E1E4E8;">(WatchedEvent </span><span style="color:#FFAB70;">watchedEvent</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;全局的默认的watcher事件：&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                         </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> watchedEvent.</span><span style="color:#B392F0;">getType</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                         </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-----&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                         </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> watchedEvent.</span><span style="color:#B392F0;">getPath</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      </span><span style="color:#6A737D;">// 连接成功以后触发watcher事件</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Event.KeeperState.SyncConnected </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> watchedEvent.</span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          </span><span style="color:#6A737D;">// 如果收到了服务端的响应事件，连接成功</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          </span><span style="color:#6A737D;">// 连接成功以后做一个递减。</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          countDownLatch.</span><span style="color:#B392F0;">countDown</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                                      }</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  }</span></span>
<span class="line"><span style="color:#E1E4E8;">                              });</span></span>
<span class="line"><span style="color:#E1E4E8;">            countDownLatch.</span><span style="color:#B392F0;">await</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            zooKeeper.</span><span style="color:#B392F0;">create</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/zk-tmp-darian&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;1&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getBytes</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">                             ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// exists   getdata getchildren</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 绑定事件</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 我们在创建zookeeper的时候创建了一个默认的匿名内部类，</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 如果说设置成 true 的话，所有的事件都会触发到内部类里边</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// zooKeeper.exists(&quot;/zi-tmp-darian&quot;,true);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 绑定自己的watcher事件</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 通过 exists 绑定事件</span></span>
<span class="line"><span style="color:#E1E4E8;">            Stat stat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zooKeeper.</span><span style="color:#B392F0;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/zk-tmp-darian&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Watcher</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">                @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">process</span><span style="color:#E1E4E8;">(WatchedEvent </span><span style="color:#FFAB70;">watchedEvent</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(watchedEvent.</span><span style="color:#B392F0;">getType</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;---&gt;&gt;&gt;&gt;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> watchedEvent.</span><span style="color:#B392F0;">getPath</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#6A737D;">// 通过再一次绑定事件去实现永久监听的一个效果</span></span>
<span class="line"><span style="color:#E1E4E8;">                        zooKeeper.</span><span style="color:#B392F0;">exists</span><span style="color:#E1E4E8;">(watchedEvent.</span><span style="color:#B392F0;">getPath</span><span style="color:#E1E4E8;">(), </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (KeeperException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (InterruptedException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                        e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                    }</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 通过修改食物类型操作来触发监听事件</span></span>
<span class="line"><span style="color:#E1E4E8;">            stat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zooKeeper.</span><span style="color:#B392F0;">setData</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/zk-tmp-darian&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;222&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getBytes</span><span style="color:#E1E4E8;">(), stat.</span><span style="color:#B392F0;">getVersion</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            Thread.</span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            zooKeeper.</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/zk-tmp-darian&quot;</span><span style="color:#E1E4E8;">, stat.</span><span style="color:#B392F0;">getVersion</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            System.in.</span><span style="color:#B392F0;">read</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (InterruptedException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (IOException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (KeeperException </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            e.</span><span style="color:#B392F0;">printStackTrace</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">WatcherDemo</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> CountDownLatch countDownLatch </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CountDownLatch</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ZooKeeper zooKeeper </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ZooKeeper</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#032F62;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#032F62;">&quot;192.168.136.130:2181&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                              </span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Watcher</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#6A737D;">// 为了保证连接的成功状态</span></span>
<span class="line"><span style="color:#24292E;">                                  @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">process</span><span style="color:#24292E;">(WatchedEvent </span><span style="color:#E36209;">watchedEvent</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                                      System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;全局的默认的watcher事件：&quot;</span></span>
<span class="line"><span style="color:#24292E;">                                                         </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> watchedEvent.</span><span style="color:#6F42C1;">getType</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">                                                         </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-----&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span></span>
<span class="line"><span style="color:#24292E;">                                                         </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> watchedEvent.</span><span style="color:#6F42C1;">getPath</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">                                      </span><span style="color:#6A737D;">// 连接成功以后触发watcher事件</span></span>
<span class="line"><span style="color:#24292E;">                                      </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Event.KeeperState.SyncConnected </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> watchedEvent.</span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">                                          </span><span style="color:#6A737D;">// 如果收到了服务端的响应事件，连接成功</span></span>
<span class="line"><span style="color:#24292E;">                                          </span><span style="color:#6A737D;">// 连接成功以后做一个递减。</span></span>
<span class="line"><span style="color:#24292E;">                                          countDownLatch.</span><span style="color:#6F42C1;">countDown</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                                      }</span></span>
<span class="line"><span style="color:#24292E;">                                  }</span></span>
<span class="line"><span style="color:#24292E;">                              });</span></span>
<span class="line"><span style="color:#24292E;">            countDownLatch.</span><span style="color:#6F42C1;">await</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            zooKeeper.</span><span style="color:#6F42C1;">create</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/zk-tmp-darian&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;1&quot;</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">(),</span></span>
<span class="line"><span style="color:#24292E;">                             ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// exists   getdata getchildren</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 绑定事件</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 我们在创建zookeeper的时候创建了一个默认的匿名内部类，</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 如果说设置成 true 的话，所有的事件都会触发到内部类里边</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// zooKeeper.exists(&quot;/zi-tmp-darian&quot;,true);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 绑定自己的watcher事件</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 通过 exists 绑定事件</span></span>
<span class="line"><span style="color:#24292E;">            Stat stat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zooKeeper.</span><span style="color:#6F42C1;">exists</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/zk-tmp-darian&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Watcher</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">                @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">process</span><span style="color:#24292E;">(WatchedEvent </span><span style="color:#E36209;">watchedEvent</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                    System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(watchedEvent.</span><span style="color:#6F42C1;">getType</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;---&gt;&gt;&gt;&gt;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> watchedEvent.</span><span style="color:#6F42C1;">getPath</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#6A737D;">// 通过再一次绑定事件去实现永久监听的一个效果</span></span>
<span class="line"><span style="color:#24292E;">                        zooKeeper.</span><span style="color:#6F42C1;">exists</span><span style="color:#24292E;">(watchedEvent.</span><span style="color:#6F42C1;">getPath</span><span style="color:#24292E;">(), </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (KeeperException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (InterruptedException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">                        e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                    }</span></span>
<span class="line"><span style="color:#24292E;">                }</span></span>
<span class="line"><span style="color:#24292E;">            });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 通过修改食物类型操作来触发监听事件</span></span>
<span class="line"><span style="color:#24292E;">            stat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zooKeeper.</span><span style="color:#6F42C1;">setData</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/zk-tmp-darian&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;222&quot;</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">(), stat.</span><span style="color:#6F42C1;">getVersion</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            Thread.</span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            zooKeeper.</span><span style="color:#6F42C1;">delete</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/zk-tmp-darian&quot;</span><span style="color:#24292E;">, stat.</span><span style="color:#6F42C1;">getVersion</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            System.in.</span><span style="color:#6F42C1;">read</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (InterruptedException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (IOException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (KeeperException </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            e.</span><span style="color:#6F42C1;">printStackTrace</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><h4 id="控制台-4" tabindex="-1">控制台 <a class="header-anchor" href="#控制台-4" aria-label="Permalink to &quot;控制台&quot;">​</a></h4><div class="language-verilog vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">verilog</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">全局的默认的watcher事件：None</span><span style="color:#F97583;">-----&gt;&gt;&gt;&gt;&gt;&gt;</span><span style="color:#E1E4E8;">null</span></span>
<span class="line"><span style="color:#E1E4E8;">NodeDataChanged</span><span style="color:#F97583;">---&gt;&gt;&gt;&gt;/</span><span style="color:#E1E4E8;">zk</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">tmp</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">darian</span></span>
<span class="line"><span style="color:#E1E4E8;">全局的默认的watcher事件：NodeDeleted</span><span style="color:#F97583;">-----&gt;&gt;&gt;&gt;&gt;&gt;/</span><span style="color:#E1E4E8;">zk</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">tmp</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">darian</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">全局的默认的watcher事件：None</span><span style="color:#D73A49;">-----&gt;&gt;&gt;&gt;&gt;&gt;</span><span style="color:#24292E;">null</span></span>
<span class="line"><span style="color:#24292E;">NodeDataChanged</span><span style="color:#D73A49;">---&gt;&gt;&gt;&gt;/</span><span style="color:#24292E;">zk</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">tmp</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">darian</span></span>
<span class="line"><span style="color:#24292E;">全局的默认的watcher事件：NodeDeleted</span><span style="color:#D73A49;">-----&gt;&gt;&gt;&gt;&gt;&gt;/</span><span style="color:#24292E;">zk</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">tmp</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">darian</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h1 id="watcher事件机制" tabindex="-1">Watcher事件机制： <a class="header-anchor" href="#watcher事件机制" aria-label="Permalink to &quot;Watcher事件机制：&quot;">​</a></h1><h3 id="事件类型" tabindex="-1">事件类型 <a class="header-anchor" href="#事件类型" aria-label="Permalink to &quot;事件类型&quot;">​</a></h3><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>None（-1）</td><td>客户端链接状态发生变化的时候，会收到none的事件</td></tr><tr><td>NodeCreated（1）</td><td>创建节点的事件。比如说zk-persis-mic</td></tr><tr><td>NodeDeleted（2）</td><td>删除节点的事件。</td></tr><tr><td>NodeDataChanged（3）</td><td>节点数据发生变更</td></tr><tr><td>NodeChildrenChanged（4）</td><td>子节点被创建、被删除、会发生事件触发</td></tr></tbody></table><p>​</p><h3 id="触发条件" tabindex="-1">触发条件 <a class="header-anchor" href="#触发条件" aria-label="Permalink to &quot;触发条件&quot;">​</a></h3><table><thead><tr><th></th><th>zk-persis-mic（监听事件）</th><th>zk-persis-mic/child（监听事件）</th></tr></thead><tbody><tr><td>create(/zk-persis-mic)</td><td>NodeCreated（exists/getData）</td><td>无</td></tr><tr><td>delete(/zk-persis-mic)</td><td>NodeDelete（exists/getData）</td><td>无</td></tr><tr><td>setData(/zk-persis-mic)</td><td>NodeDataChanged（exists/getData）</td><td>无</td></tr><tr><td>create(/zk-persis-mic/children)</td><td>NodeChildrenChanged(getChildren)</td><td>NodeCreated</td></tr><tr><td>delete(/zk-persis-mic/children)</td><td>NodeChildrenChanged(getChildren)</td><td>NodeDelete</td></tr><tr><td>setData(/zk-persis-mic/children)</td><td></td><td>NodeDataChanged</td></tr></tbody></table><h2 id="事件的实现原理" tabindex="-1">事件的实现原理 <a class="header-anchor" href="#事件的实现原理" aria-label="Permalink to &quot;事件的实现原理&quot;">​</a></h2><p>通过 <code>#exists</code>方法去绑定的事件</p><p>入口就是 <code>#exists</code></p><p>Zookeeper 类中的 <code>#exists</code> 方法</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> Stat </span><span style="color:#B392F0;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String path, Watcher watcher)</span></span>
<span class="line"><span style="color:#E1E4E8;">   throws KeeperException, InterruptedException{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String clientPath </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> path;</span></span>
<span class="line"><span style="color:#E1E4E8;">   PathUtils.</span><span style="color:#B392F0;">validatePath</span><span style="color:#E1E4E8;">(clientPath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">// the watch contains the un-chroot path</span></span>
<span class="line"><span style="color:#E1E4E8;">   WatchRegistration wcb </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (watcher </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">       wcb </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ExistsWatchRegistration</span><span style="color:#E1E4E8;">(watcher, clientPath);</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> String serverPath </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">prependChroot</span><span style="color:#E1E4E8;">(clientPath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   RequestHeader h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RequestHeader</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   h.</span><span style="color:#B392F0;">setType</span><span style="color:#E1E4E8;">(ZooDefs.OpCode.exists);</span></span>
<span class="line"><span style="color:#E1E4E8;">   ExistsRequest request </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ExistsRequest</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   request.</span><span style="color:#B392F0;">setPath</span><span style="color:#E1E4E8;">(serverPath);</span></span>
<span class="line"><span style="color:#E1E4E8;">   request.</span><span style="color:#B392F0;">setWatch</span><span style="color:#E1E4E8;">(watcher </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">   SetDataResponse response </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SetDataResponse</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   ReplyHeader r </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> cnxn.</span><span style="color:#B392F0;">submitRequest</span><span style="color:#E1E4E8;">(h, request, response, wcb);</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (r.</span><span style="color:#B392F0;">getErr</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (r.</span><span style="color:#B392F0;">getErr</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> KeeperException.Code.NONODE.</span><span style="color:#B392F0;">intValue</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> KeeperException.</span><span style="color:#B392F0;">create</span><span style="color:#E1E4E8;">(KeeperException.Code.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(r.</span><span style="color:#B392F0;">getErr</span><span style="color:#E1E4E8;">()),</span></span>
<span class="line"><span style="color:#E1E4E8;">               clientPath);</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> response.</span><span style="color:#B392F0;">getStat</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getCzxid</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> response.</span><span style="color:#B392F0;">getStat</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> Stat </span><span style="color:#6F42C1;">exists</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String path, Watcher watcher)</span></span>
<span class="line"><span style="color:#24292E;">   throws KeeperException, InterruptedException{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String clientPath </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> path;</span></span>
<span class="line"><span style="color:#24292E;">   PathUtils.</span><span style="color:#6F42C1;">validatePath</span><span style="color:#24292E;">(clientPath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">// the watch contains the un-chroot path</span></span>
<span class="line"><span style="color:#24292E;">   WatchRegistration wcb </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (watcher </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">       wcb </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ExistsWatchRegistration</span><span style="color:#24292E;">(watcher, clientPath);</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> String serverPath </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">prependChroot</span><span style="color:#24292E;">(clientPath);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   RequestHeader h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RequestHeader</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   h.</span><span style="color:#6F42C1;">setType</span><span style="color:#24292E;">(ZooDefs.OpCode.exists);</span></span>
<span class="line"><span style="color:#24292E;">   ExistsRequest request </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ExistsRequest</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   request.</span><span style="color:#6F42C1;">setPath</span><span style="color:#24292E;">(serverPath);</span></span>
<span class="line"><span style="color:#24292E;">   request.</span><span style="color:#6F42C1;">setWatch</span><span style="color:#24292E;">(watcher </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">   SetDataResponse response </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SetDataResponse</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   ReplyHeader r </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> cnxn.</span><span style="color:#6F42C1;">submitRequest</span><span style="color:#24292E;">(h, request, response, wcb);</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (r.</span><span style="color:#6F42C1;">getErr</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (r.</span><span style="color:#6F42C1;">getErr</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> KeeperException.Code.NONODE.</span><span style="color:#6F42C1;">intValue</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> KeeperException.</span><span style="color:#6F42C1;">create</span><span style="color:#24292E;">(KeeperException.Code.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(r.</span><span style="color:#6F42C1;">getErr</span><span style="color:#24292E;">()),</span></span>
<span class="line"><span style="color:#24292E;">               clientPath);</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> response.</span><span style="color:#6F42C1;">getStat</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getCzxid</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> response.</span><span style="color:#6F42C1;">getStat</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>我们client在zookeeper server上注册一个事件</p><p>ZkWatcher Manager 上保存客户端的事件注册</p><p><img src="`+o+'" alt="JavaGuide_Zookeeper_实践与原理_Server_Client_Watcher事件.png"></p><p>源码地址：Zookeeper核心类中exists(</p><p>分析原理：</p><p>在客户端调用里边就是实例化，</p><p>调用增删改查方法</p><p>一定有一个机制去对这个队列去做一个数据的处理</p><p><code>OutgoingQueue</code></p><p>有一个入队肯定有一个出队</p><p>数据不是放到队列中就完事了，肯定需要有机制去对队列做一个出队列</p><p>判断是引导流程走向的一个方式！</p><p>Ctrl + alt + B 点到方法上，可以看到有几个实现</p><p><code>NettyServerCnxn</code></p><p>服务端处理请求的<code>类</code></p><p><code>#receiveMessage()</code> 方法</p><p>通过链式的process对请求去做一个链式的处理，把不同的业务去做一个分离</p><p>预处理 &gt; 同步处理 &gt; finally处理</p><p><img src="'+e+'" alt="JavaGuide_Zookeeper_实践与原理_Processor_链式处理.png"></p><p>PIPE（管道模式）</p><p>Linux 的管道的处理，一个请求过来，进入不同的管道，做不同的处理，最终返回一个结果。</p><p>类似于链式风格的一种设计。</p><p>Zookeeper中大部分都在用多线程的方式异步化流程。</p><p>一定有一个线程去处理队列 <code>submittRequests</code>。</p><p><code>Hashmap&lt;watcher, String path&gt;</code></p><p><img src="'+r+`" alt="JavaGuide_Zookeeper_实践与原理_Watcher_Server_处理流程详细图.png"></p><h1 id="curator的操作" tabindex="-1">Curator的操作 <a class="header-anchor" href="#curator的操作" aria-label="Permalink to &quot;Curator的操作&quot;">​</a></h1><p>主要是对我们数据节点操作的一个封装</p><p>​ 原生操作会有很多不便之处，虽然说灵活性比较好，但是我们要做一些事情，比如说，要去绑定事件很复杂，我们要去创建一个连接也很复杂，那怎么去简化？</p><p>​ Netflix公司开源了一个zookeeper客户端，他跟原生的客户端相比，它是一个更高层次的抽象，他不光是API层次的一个抽象，同时还封装了一套基于应用场景的API，也就是说zookeeper它本身能够实现分布式锁，leader选举这些功能，那么curator对这些功能做了一些封装，我们直接调用API就好了。就可以完成leader选举的这样一个机制，那么我们怎么实现这样一个功能。</p><p>基于fluent风格的一个机制</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">CuratorFramework curatorFamework </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> CuratorFrameworkFactory</span></span>
<span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">builder</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">connectString</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">sessionTimeoutMS</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">retryPolicy</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ExponetialBackoffRetry</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">namespace</span><span style="color:#E1E4E8;">(“curator”)</span></span>
<span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">build</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 结果： /curator/mic/node1</span></span>
<span class="line"><span style="color:#6A737D;">// 原生api中，必须是逐层创建，也就是父节点必须存在，子节点才能创建</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">CuratorFramework curatorFamework </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> CuratorFrameworkFactory</span></span>
<span class="line"><span style="color:#24292E;">.</span><span style="color:#6F42C1;">builder</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">.</span><span style="color:#6F42C1;">connectString</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">.</span><span style="color:#6F42C1;">sessionTimeoutMS</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">.</span><span style="color:#6F42C1;">retryPolicy</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ExponetialBackoffRetry</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">.</span><span style="color:#6F42C1;">namespace</span><span style="color:#24292E;">(“curator”)</span></span>
<span class="line"><span style="color:#24292E;">.</span><span style="color:#6F42C1;">build</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 结果： /curator/mic/node1</span></span>
<span class="line"><span style="color:#6A737D;">// 原生api中，必须是逐层创建，也就是父节点必须存在，子节点才能创建</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="curator的增删改查" tabindex="-1">Curator的增删改查 <a class="header-anchor" href="#curator的增删改查" aria-label="Permalink to &quot;Curator的增删改查&quot;">​</a></h2><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> com.gupao.study.vip;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.curator.framework.CuratorFramework;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.curator.framework.CuratorFrameworkFactory;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.curator.retry.ExponentialBackoffRetry;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.zookeeper.CreateMode;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.zookeeper.data.Stat;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;类说明 :</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;属性说明：</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;作者：Darian</span></span>
<span class="line"><span style="color:#6A737D;">**/</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CuratorDemo</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="color:#E1E4E8;">       CuratorFramework curatorFramework </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> CuratorFrameworkFactory</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">builder</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">connectString</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#9ECBFF;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#9ECBFF;">&quot;192.168.136.130:2181&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">sessionTimeoutMs</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">// 一个重试机制，递减的重试机制</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">retryPolicy</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ExponentialBackoffRetry</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">// 指定命名空间，我们会把某个业务放在一个大的命名空间下面</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">// 因为我们要区分每个场景下的业务划分</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">namespace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/curator&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">build</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       curatorFramework.</span><span style="color:#B392F0;">start</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 创建结果： /curator/darian/node1</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 原生的 API 中，必须是逐层创建，也就是父节点必须存在，子节点才能创建</span></span>
<span class="line"><span style="color:#E1E4E8;">       curatorFramework.</span><span style="color:#B392F0;">create</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">creatingParentContainersIfNeeded</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">withMode</span><span style="color:#E1E4E8;">(CreateMode.PERSISTENT)</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">forPath</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/darian/node1&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;2&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getBytes</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 查询节点，得到节点的 Stat 信息</span></span>
<span class="line"><span style="color:#E1E4E8;">       Stat stat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Stat</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">       curatorFramework.</span><span style="color:#B392F0;">getData</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">storingStatIn</span><span style="color:#E1E4E8;">(stat)</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">forPath</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/darian/node1&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 更新操作</span></span>
<span class="line"><span style="color:#E1E4E8;">       curatorFramework.</span><span style="color:#B392F0;">setData</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">withVersion</span><span style="color:#E1E4E8;">(stat.</span><span style="color:#B392F0;">getVersion</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">forPath</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/darian/node1&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;232&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getBytes</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 去删除某个节点</span></span>
<span class="line"><span style="color:#E1E4E8;">       curatorFramework.</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">deletingChildrenIfNeeded</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">forPath</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/darian/node1&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> com.gupao.study.vip;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.curator.framework.CuratorFramework;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.curator.framework.CuratorFrameworkFactory;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.curator.retry.ExponentialBackoffRetry;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.zookeeper.CreateMode;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.zookeeper.data.Stat;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;类说明 :</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;属性说明：</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;作者：Darian</span></span>
<span class="line"><span style="color:#6A737D;">**/</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CuratorDemo</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">       CuratorFramework curatorFramework </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> CuratorFrameworkFactory</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">builder</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">connectString</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#032F62;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#032F62;">&quot;192.168.136.130:2181&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">sessionTimeoutMs</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">// 一个重试机制，递减的重试机制</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">retryPolicy</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ExponentialBackoffRetry</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">// 指定命名空间，我们会把某个业务放在一个大的命名空间下面</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">// 因为我们要区分每个场景下的业务划分</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">namespace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/curator&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">build</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       curatorFramework.</span><span style="color:#6F42C1;">start</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 创建结果： /curator/darian/node1</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 原生的 API 中，必须是逐层创建，也就是父节点必须存在，子节点才能创建</span></span>
<span class="line"><span style="color:#24292E;">       curatorFramework.</span><span style="color:#6F42C1;">create</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">creatingParentContainersIfNeeded</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">withMode</span><span style="color:#24292E;">(CreateMode.PERSISTENT)</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">forPath</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/darian/node1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;2&quot;</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 查询节点，得到节点的 Stat 信息</span></span>
<span class="line"><span style="color:#24292E;">       Stat stat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Stat</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">       curatorFramework.</span><span style="color:#6F42C1;">getData</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">storingStatIn</span><span style="color:#24292E;">(stat)</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">forPath</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/darian/node1&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 更新操作</span></span>
<span class="line"><span style="color:#24292E;">       curatorFramework.</span><span style="color:#6F42C1;">setData</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">withVersion</span><span style="color:#24292E;">(stat.</span><span style="color:#6F42C1;">getVersion</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">forPath</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/darian/node1&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;232&quot;</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 去删除某个节点</span></span>
<span class="line"><span style="color:#24292E;">       curatorFramework.</span><span style="color:#6F42C1;">delete</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">deletingChildrenIfNeeded</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">forPath</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/darian/node1&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] args) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	CuratorFramework.</span><span style="color:#B392F0;">create</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">creatingPatentsIfNeeded</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">withMode</span><span style="color:#E1E4E8;">(CreateMode.PERSISTENT)</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">forPath</span><span style="color:#E1E4E8;">(“</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mic</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">node1”,”</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">”.</span><span style="color:#B392F0;">getBytes</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">//删除</span></span>
<span class="line"><span style="color:#E1E4E8;">  curatorFramework</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">deletingChildrenIfNeeded</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">forPath</span><span style="color:#E1E4E8;">(“</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mic</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">node1”);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	Stat stat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Stat</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">	curatorFramework</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">getData</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">storingStatIn</span><span style="color:#E1E4E8;">(stat).</span><span style="color:#B392F0;">forPath</span><span style="color:#E1E4E8;">(“</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mic</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">node1”)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">	curatorFramework</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">setData</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">withVersion</span><span style="color:#E1E4E8;">(sta.</span><span style="color:#B392F0;">getVersion</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">forPath</span><span style="color:#E1E4E8;">(“</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mic</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">node1”,”xx”.getBytes);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  curatorFramework.</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();    </span><span style="color:#6A737D;">//关闭连接</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] args) {</span></span>
<span class="line"><span style="color:#24292E;">	CuratorFramework.</span><span style="color:#6F42C1;">create</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">creatingPatentsIfNeeded</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">withMode</span><span style="color:#24292E;">(CreateMode.PERSISTENT)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">forPath</span><span style="color:#24292E;">(“</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mic</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">node1”,”</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">”.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">//删除</span></span>
<span class="line"><span style="color:#24292E;">  curatorFramework</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">delete</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">deletingChildrenIfNeeded</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">forPath</span><span style="color:#24292E;">(“</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mic</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">node1”);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	Stat stat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Stat</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">	curatorFramework</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">getData</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">storingStatIn</span><span style="color:#24292E;">(stat).</span><span style="color:#6F42C1;">forPath</span><span style="color:#24292E;">(“</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mic</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">node1”)</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">	curatorFramework</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">setData</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">withVersion</span><span style="color:#24292E;">(sta.</span><span style="color:#6F42C1;">getVersion</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">forPath</span><span style="color:#24292E;">(“</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mic</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">node1”,”xx”.getBytes);</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  curatorFramework.</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();    </span><span style="color:#6A737D;">//关闭连接</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>curator 事件的高度封装，</p><p>一定有一个节点特性</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>PathChildCache</td><td>监听一个节点下子节点的创建、删除、更新<br>（CHILD-ADDED,CHILD_UPDATE,CHILD_REMOVED）</td></tr><tr><td>NodeCache</td><td>监听一个节点的更新和创建时间<br>（Receive Event:/mic）</td></tr><tr><td>TreeCache</td><td>zonghe1PathChildCache和NodeCache的特性</td></tr></tbody></table><h2 id="curator的watcher机制" tabindex="-1">Curator的watcher机制 <a class="header-anchor" href="#curator的watcher机制" aria-label="Permalink to &quot;Curator的watcher机制&quot;">​</a></h2><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> com.gupao.study.vip;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.curator.framework.CuratorFramework;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.curator.framework.CuratorFrameworkFactory;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.curator.framework.recipes.cache.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.curator.retry.ExponentialBackoffRetry;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;类说明 : 事件的高度封装</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;p&gt;</span></span>
<span class="line"><span style="color:#6A737D;">* curator封装了三种事件的机制</span></span>
<span class="line"><span style="color:#6A737D;">* PathChildCache   监听一个节点下节点的创建、删除、更新</span></span>
<span class="line"><span style="color:#6A737D;">* NodeCache        监听一个节点的更新和创建事件</span></span>
<span class="line"><span style="color:#6A737D;">* TreeCache        综合 PatchChildCache 和 NodeCache 的特性</span></span>
<span class="line"><span style="color:#6A737D;">*</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;属性说明：</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;作者：Darian</span></span>
<span class="line"><span style="color:#6A737D;">**/</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CuratorWatcherDemo</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">[] </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="color:#E1E4E8;">       CuratorFramework curatorFramework </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> CuratorFrameworkFactory</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">builder</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">connectString</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#9ECBFF;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#9ECBFF;">&quot;192.168.136.130:2181&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">sessionTimeoutMs</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">retryPolicy</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ExponentialBackoffRetry</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">namespace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;curator&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">           .</span><span style="color:#B392F0;">build</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       curatorFramework.</span><span style="color:#B392F0;">start</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 当前节点的创建、删除事件监听</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// addListenerWithNodeCache(curatorFramework, &quot;/darian&quot;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 子节点的增加、修改、删除的事件监听</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// addlistenerWithPathChildCache(curatorFramework,&quot;/darian&quot;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 综合节点的监听事件</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#B392F0;">addListerWithTreeCache</span><span style="color:#E1E4E8;">(curatorFramework, </span><span style="color:#9ECBFF;">&quot;/darian&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       System.in.</span><span style="color:#B392F0;">read</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">   /**</span></span>
<span class="line"><span style="color:#6A737D;">    * NodeCache + PathChildrenCache</span></span>
<span class="line"><span style="color:#6A737D;">    **/</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addListerWithTreeCache</span><span style="color:#E1E4E8;">(CuratorFramework </span><span style="color:#FFAB70;">curatorFramework</span><span style="color:#E1E4E8;">, String </span><span style="color:#FFAB70;">path</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> TreeCache treeCache </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TreeCache</span><span style="color:#E1E4E8;">(curatorFramework,path);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       TreeCacheListener treeCacheListener </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TreeCacheListener</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">           @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">childEvent</span><span style="color:#E1E4E8;">(CuratorFramework </span><span style="color:#FFAB70;">curatorFramework</span><span style="color:#E1E4E8;">, TreeCacheEvent </span><span style="color:#FFAB70;">treeCacheEvent</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="color:#E1E4E8;">               System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(treeCacheEvent.</span><span style="color:#B392F0;">getType</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&quot;--&gt;&gt;&quot;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">treeCacheEvent.</span><span style="color:#B392F0;">getData</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">           }</span></span>
<span class="line"><span style="color:#E1E4E8;">       };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       treeCache.</span><span style="color:#B392F0;">getListenable</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">addListener</span><span style="color:#E1E4E8;">(treeCacheListener);</span></span>
<span class="line"><span style="color:#E1E4E8;">       treeCache.</span><span style="color:#B392F0;">start</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">/*</span></span>
<span class="line"><span style="color:#6A737D;">       INITIALIZED--&gt;&gt;null</span></span>
<span class="line"><span style="color:#6A737D;">NODE_ADDED--&gt;&gt;ChildData{path=&#39;/darian&#39;, stat=51539607621,51539607621,1531222950294,1531222950294,0,0,0,0,1,0,51539607621</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_ADDED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607622,51539607622,1531222969992,1531222969992,0,0,0,0,1,0,51539607622</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_ADDED--&gt;&gt;ChildData{path=&#39;/darian/node1/node1&#39;, stat=51539607623,51539607623,1531222989856,1531222989856,0,0,0,0,1,0,51539607623</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_REMOVED--&gt;&gt;ChildData{path=&#39;/darian/node1/node1&#39;, stat=51539607623,51539607623,1531222989856,1531222989856,0,0,0,0,1,0,51539607623</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_UPDATED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607622,51539607625,1531222969992,1531223116477,1,2,0,0,1,0,51539607624</span></span>
<span class="line"><span style="color:#6A737D;">, data=[50]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_REMOVED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607622,51539607625,1531222969992,1531223116477,1,2,0,0,1,0,51539607624</span></span>
<span class="line"><span style="color:#6A737D;">, data=[50]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_REMOVED--&gt;&gt;ChildData{path=&#39;/darian&#39;, stat=51539607621,51539607621,1531222950294,1531222950294,0,2,0,0,1,0,51539607626</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">   /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 监听对应节点下的子节点的变化</span></span>
<span class="line"><span style="color:#6A737D;">    * 创建</span></span>
<span class="line"><span style="color:#6A737D;">    * 删除</span></span>
<span class="line"><span style="color:#6A737D;">    * 更新</span></span>
<span class="line"><span style="color:#6A737D;">    */</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addlistenerWithPathChildCache</span><span style="color:#E1E4E8;">(CuratorFramework </span><span style="color:#FFAB70;">curatorFramework</span><span style="color:#E1E4E8;">, String </span><span style="color:#FFAB70;">path</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> PathChildrenCache pathChildrenCache </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">PathChildrenCache</span><span style="color:#E1E4E8;">(curatorFramework, path, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">       PathChildrenCacheListener pathChildrenCacheListener </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">PathChildrenCacheListener</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">           @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">childEvent</span><span style="color:#E1E4E8;">(CuratorFramework </span><span style="color:#FFAB70;">curatorFramework</span><span style="color:#E1E4E8;">, PathChildrenCacheEvent </span><span style="color:#FFAB70;">pathChildrenCacheEvent</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="color:#E1E4E8;">               System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;receive Event:&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> pathChildrenCacheEvent.</span><span style="color:#B392F0;">getType</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;--&gt;&gt;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> pathChildrenCacheEvent.</span><span style="color:#B392F0;">getData</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">           }</span></span>
<span class="line"><span style="color:#E1E4E8;">       };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       pathChildrenCache.</span><span style="color:#B392F0;">getListenable</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">addListener</span><span style="color:#E1E4E8;">(pathChildrenCacheListener);</span></span>
<span class="line"><span style="color:#E1E4E8;">       pathChildrenCache.</span><span style="color:#B392F0;">start</span><span style="color:#E1E4E8;">(PathChildrenCache.StartMode.NORMAL);</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">/*</span></span>
<span class="line"><span style="color:#6A737D;">receive Event:CONNECTION_RECONNECTED--&gt;&gt;null</span></span>
<span class="line"><span style="color:#6A737D;">receive Event:CHILD_ADDED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607611,51539607611,1531222192297,1531222192297,0,0,0,0,1,0,51539607611</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">receive Event:CHILD_REMOVED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607611,51539607611,1531222192297,1531222192297,0,0,0,0,1,0,51539607611</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">   /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 监听这个节点的变化</span></span>
<span class="line"><span style="color:#6A737D;">    * 创建</span></span>
<span class="line"><span style="color:#6A737D;">    * 更新</span></span>
<span class="line"><span style="color:#6A737D;">    **/</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">addListenerWithNodeCache</span><span style="color:#E1E4E8;">(CuratorFramework </span><span style="color:#FFAB70;">curatorFramework</span><span style="color:#E1E4E8;">, String </span><span style="color:#FFAB70;">path</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> NodeCache nodeCache </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NodeCache</span><span style="color:#E1E4E8;">(curatorFramework, path, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       NodeCacheListener nodeCacheListener </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NodeCacheListener</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">           @</span><span style="color:#F97583;">Override</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">nodeChanged</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">throws</span><span style="color:#E1E4E8;"> Exception {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">               System.out.</span><span style="color:#B392F0;">println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Receive Event:&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> nodeCache.</span><span style="color:#B392F0;">getCurrentData</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">getPath</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">           }</span></span>
<span class="line"><span style="color:#E1E4E8;">       };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       nodeCache.</span><span style="color:#B392F0;">getListenable</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">addListener</span><span style="color:#E1E4E8;">(nodeCacheListener);</span></span>
<span class="line"><span style="color:#E1E4E8;">       nodeCache.</span><span style="color:#B392F0;">start</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> com.gupao.study.vip;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.curator.framework.CuratorFramework;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.curator.framework.CuratorFrameworkFactory;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.curator.framework.recipes.cache.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.curator.retry.ExponentialBackoffRetry;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;类说明 : 事件的高度封装</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;p&gt;</span></span>
<span class="line"><span style="color:#6A737D;">* curator封装了三种事件的机制</span></span>
<span class="line"><span style="color:#6A737D;">* PathChildCache   监听一个节点下节点的创建、删除、更新</span></span>
<span class="line"><span style="color:#6A737D;">* NodeCache        监听一个节点的更新和创建事件</span></span>
<span class="line"><span style="color:#6A737D;">* TreeCache        综合 PatchChildCache 和 NodeCache 的特性</span></span>
<span class="line"><span style="color:#6A737D;">*</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;属性说明：</span></span>
<span class="line"><span style="color:#6A737D;">* &lt;br&gt;作者：Darian</span></span>
<span class="line"><span style="color:#6A737D;">**/</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CuratorWatcherDemo</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">[] </span><span style="color:#E36209;">args</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">       CuratorFramework curatorFramework </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> CuratorFrameworkFactory</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">builder</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">connectString</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.136.128:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#032F62;">&quot;192.168.136.129:2181,&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#032F62;">&quot;192.168.136.130:2181&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">sessionTimeoutMs</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">retryPolicy</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ExponentialBackoffRetry</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">namespace</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;curator&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">           .</span><span style="color:#6F42C1;">build</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       curatorFramework.</span><span style="color:#6F42C1;">start</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 当前节点的创建、删除事件监听</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// addListenerWithNodeCache(curatorFramework, &quot;/darian&quot;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 子节点的增加、修改、删除的事件监听</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// addlistenerWithPathChildCache(curatorFramework,&quot;/darian&quot;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 综合节点的监听事件</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6F42C1;">addListerWithTreeCache</span><span style="color:#24292E;">(curatorFramework, </span><span style="color:#032F62;">&quot;/darian&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       System.in.</span><span style="color:#6F42C1;">read</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">   /**</span></span>
<span class="line"><span style="color:#6A737D;">    * NodeCache + PathChildrenCache</span></span>
<span class="line"><span style="color:#6A737D;">    **/</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addListerWithTreeCache</span><span style="color:#24292E;">(CuratorFramework </span><span style="color:#E36209;">curatorFramework</span><span style="color:#24292E;">, String </span><span style="color:#E36209;">path</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> TreeCache treeCache </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TreeCache</span><span style="color:#24292E;">(curatorFramework,path);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       TreeCacheListener treeCacheListener </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TreeCacheListener</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">           @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">childEvent</span><span style="color:#24292E;">(CuratorFramework </span><span style="color:#E36209;">curatorFramework</span><span style="color:#24292E;">, TreeCacheEvent </span><span style="color:#E36209;">treeCacheEvent</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">               System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(treeCacheEvent.</span><span style="color:#6F42C1;">getType</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&quot;--&gt;&gt;&quot;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">treeCacheEvent.</span><span style="color:#6F42C1;">getData</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">           }</span></span>
<span class="line"><span style="color:#24292E;">       };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       treeCache.</span><span style="color:#6F42C1;">getListenable</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">addListener</span><span style="color:#24292E;">(treeCacheListener);</span></span>
<span class="line"><span style="color:#24292E;">       treeCache.</span><span style="color:#6F42C1;">start</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">/*</span></span>
<span class="line"><span style="color:#6A737D;">       INITIALIZED--&gt;&gt;null</span></span>
<span class="line"><span style="color:#6A737D;">NODE_ADDED--&gt;&gt;ChildData{path=&#39;/darian&#39;, stat=51539607621,51539607621,1531222950294,1531222950294,0,0,0,0,1,0,51539607621</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_ADDED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607622,51539607622,1531222969992,1531222969992,0,0,0,0,1,0,51539607622</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_ADDED--&gt;&gt;ChildData{path=&#39;/darian/node1/node1&#39;, stat=51539607623,51539607623,1531222989856,1531222989856,0,0,0,0,1,0,51539607623</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_REMOVED--&gt;&gt;ChildData{path=&#39;/darian/node1/node1&#39;, stat=51539607623,51539607623,1531222989856,1531222989856,0,0,0,0,1,0,51539607623</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_UPDATED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607622,51539607625,1531222969992,1531223116477,1,2,0,0,1,0,51539607624</span></span>
<span class="line"><span style="color:#6A737D;">, data=[50]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_REMOVED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607622,51539607625,1531222969992,1531223116477,1,2,0,0,1,0,51539607624</span></span>
<span class="line"><span style="color:#6A737D;">, data=[50]}</span></span>
<span class="line"><span style="color:#6A737D;">NODE_REMOVED--&gt;&gt;ChildData{path=&#39;/darian&#39;, stat=51539607621,51539607621,1531222950294,1531222950294,0,2,0,0,1,0,51539607626</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">   /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 监听对应节点下的子节点的变化</span></span>
<span class="line"><span style="color:#6A737D;">    * 创建</span></span>
<span class="line"><span style="color:#6A737D;">    * 删除</span></span>
<span class="line"><span style="color:#6A737D;">    * 更新</span></span>
<span class="line"><span style="color:#6A737D;">    */</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addlistenerWithPathChildCache</span><span style="color:#24292E;">(CuratorFramework </span><span style="color:#E36209;">curatorFramework</span><span style="color:#24292E;">, String </span><span style="color:#E36209;">path</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> PathChildrenCache pathChildrenCache </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">PathChildrenCache</span><span style="color:#24292E;">(curatorFramework, path, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">       PathChildrenCacheListener pathChildrenCacheListener </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">PathChildrenCacheListener</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">           @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">childEvent</span><span style="color:#24292E;">(CuratorFramework </span><span style="color:#E36209;">curatorFramework</span><span style="color:#24292E;">, PathChildrenCacheEvent </span><span style="color:#E36209;">pathChildrenCacheEvent</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">               System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;receive Event:&quot;</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> pathChildrenCacheEvent.</span><span style="color:#6F42C1;">getType</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;--&gt;&gt;&quot;</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> pathChildrenCacheEvent.</span><span style="color:#6F42C1;">getData</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">           }</span></span>
<span class="line"><span style="color:#24292E;">       };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       pathChildrenCache.</span><span style="color:#6F42C1;">getListenable</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">addListener</span><span style="color:#24292E;">(pathChildrenCacheListener);</span></span>
<span class="line"><span style="color:#24292E;">       pathChildrenCache.</span><span style="color:#6F42C1;">start</span><span style="color:#24292E;">(PathChildrenCache.StartMode.NORMAL);</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6A737D;">/*</span></span>
<span class="line"><span style="color:#6A737D;">receive Event:CONNECTION_RECONNECTED--&gt;&gt;null</span></span>
<span class="line"><span style="color:#6A737D;">receive Event:CHILD_ADDED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607611,51539607611,1531222192297,1531222192297,0,0,0,0,1,0,51539607611</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">receive Event:CHILD_REMOVED--&gt;&gt;ChildData{path=&#39;/darian/node1&#39;, stat=51539607611,51539607611,1531222192297,1531222192297,0,0,0,0,1,0,51539607611</span></span>
<span class="line"><span style="color:#6A737D;">, data=[49]}</span></span>
<span class="line"><span style="color:#6A737D;">        */</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">   /**</span></span>
<span class="line"><span style="color:#6A737D;">    * 监听这个节点的变化</span></span>
<span class="line"><span style="color:#6A737D;">    * 创建</span></span>
<span class="line"><span style="color:#6A737D;">    * 更新</span></span>
<span class="line"><span style="color:#6A737D;">    **/</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addListenerWithNodeCache</span><span style="color:#24292E;">(CuratorFramework </span><span style="color:#E36209;">curatorFramework</span><span style="color:#24292E;">, String </span><span style="color:#E36209;">path</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> NodeCache nodeCache </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NodeCache</span><span style="color:#24292E;">(curatorFramework, path, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       NodeCacheListener nodeCacheListener </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NodeCacheListener</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">           @</span><span style="color:#D73A49;">Override</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">nodeChanged</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">throws</span><span style="color:#24292E;"> Exception {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">               System.out.</span><span style="color:#6F42C1;">println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Receive Event:&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> nodeCache.</span><span style="color:#6F42C1;">getCurrentData</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">getPath</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">           }</span></span>
<span class="line"><span style="color:#24292E;">       };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       nodeCache.</span><span style="color:#6F42C1;">getListenable</span><span style="color:#24292E;">().</span><span style="color:#6F42C1;">addListener</span><span style="color:#24292E;">(nodeCacheListener);</span></span>
<span class="line"><span style="color:#24292E;">       nodeCache.</span><span style="color:#6F42C1;">start</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br></div></div>`,110),E=[c];function y(i,u,b,d,F,h){return n(),a("div",null,E)}const D=s(t,[["render",y]]);export{C as __pageData,D as default};
