import{_ as s,o as a,h as n,Q as l}from"./chunks/framework.da611722.js";const p="/assets/RabbitMQ_可靠性投递和实践_可靠性投递.92df341c.png",o="/assets/RabbitMQ_可靠性投递和实践_高可用架构.ae77ae4c.png",e="/assets/RabbitMQ_可靠性投递和实践_镜像队列.aff1af47.png",r="/assets/RabbitMQ_可靠性投递和实践_插件列表.e65f5917.png",C=JSON.parse('{"title":"可靠性投递和实践经验 | JavaGuide","description":"","frontmatter":{"head":[["link",{"rel":"canonical","href":"https://javaguide.net/百万架构师/RabbitMq/可靠性投递和实践经验.html"}],["meta",{"name":"keywords","content":"可靠性投递和实践经验 , JavaGuide , JavaGuide官网, Java面试指南, Java基础, 多线程, JVM, 虚拟机, 数据库, MySQL, Spring, Redis, MyBatis, 系统设计, 分布式, RPC, 高可用, 高并发"}],["meta",{"name":"og:url","content":"https://JavaGuide.net"}],["meta",{"name":"og:type","content":"website"}],["meta",{"name":"og:image","content":"https://javaguide.net/JavaGuide-og.png"}],["meta",{"name":"og:title","content":"可靠性投递和实践经验 | JavaGuide | Java面试指南 | JavaGuide官网"}],["meta",{"name":"og:description","content":"可靠性投递和实践经验 | JavaGuide | Java面试指南 | JavaGuide官网 | 「JavaGuide.net」一份涵盖大部分 Java 程序员所需要掌握的核心知识。准备 Java 面试，首选 JavaGuide.net ！"}],["meta",{"name":"twitter:site","content":"https://javaguide.net"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:creator","content":"nogeek.cn"}],["meta",{"name":"twitter:title","content":"可靠性投递和实践经验 | JavaGuide | Java面试指南 | JavaGuide官网"}],["meta",{"name":"twitter:description","content":"可靠性投递和实践经验 | JavaGuide | Java面试指南 | JavaGuide官网 | 「JavaGuide.net」一份涵盖大部分 Java 程序员所需要掌握的核心知识。准备 Java 面试，首选 JavaGuide.net ！"}],["meta",{"name":"twitter:image","content":"https://javaguide.net/JavaGuide-og.png"}],["meta",{"name":"baidu-site-verification","content":"codeva-MXEPYsXKGk"}],["meta",{"name":"msvalidate.01","content":"9F2D57CFC59E8031212A166878638B15"}]]},"headers":[],"relativePath":"百万架构师/RabbitMq/可靠性投递和实践经验.md","filePath":"百万架构师/RabbitMq/可靠性投递和实践经验.md","lastUpdated":1741277271000}'),t={name:"百万架构师/RabbitMq/可靠性投递和实践经验.md"},c=l('<h2 id="rabbitmq-2-可靠性投递与生产实践" tabindex="-1">**RabbitMQ 2-**可靠性投递与生产实践 <a class="header-anchor" href="#rabbitmq-2-可靠性投递与生产实践" aria-label="Permalink to &quot;**RabbitMQ 2-**可靠性投递与生产实践&quot;">​</a></h2><h1 id="可靠性投递" tabindex="-1">可靠性投递 <a class="header-anchor" href="#可靠性投递" aria-label="Permalink to &quot;可靠性投递&quot;">​</a></h1><p>​ 首先需要明确，效率与可靠性是无法兼得的，如果要保证每一个环节都成功，势必会对消息的收发效率造成影响。 如果是一些业务实时一致性要求不是特别高的场合，可以牺牲一些可靠性来换取效率。</p><p><img src="'+p+`" alt="RabbitMQ_可靠性投递和实践_可靠性投递.png"></p><p>① 代表消息从生产者发送到Exchange;</p><p>② 代表消息从Exchange路由到Queue；</p><p>③ 代表消息在Queue中存储；</p><p>④ 代表消费者订阅Queue并消费消息。</p><h2 id="_1、确保消息发送到rabbitmq服务器" tabindex="-1">1、确保消息发送到RabbitMQ服务器 <a class="header-anchor" href="#_1、确保消息发送到rabbitmq服务器" aria-label="Permalink to &quot;1、确保消息发送到RabbitMQ服务器&quot;">​</a></h2><p>可能因为网络或者Broker的问题导致①失败，而生产者是无法知道消息是否正确发送到Broker的。 有两种解决方案，第一种是Transaction（事务）模式，第二种Conﬁrm（确认）模式。</p><p>在通过channel.txSelect方法开启事务之后，我们便可以发布消息给RabbitMQ了。如<strong>果事务提交成功，则消息一定到达了 RabbitMQ 中</strong>，如果在事务提交执行之前由于RabbitMQ异常崩溃或者其他原因抛出异常，这个时候我们便可以将其捕获，进而通过执行 channel.txRollback方法来实现事务回滚。使用事务机制的话会“吸干”RabbitMQ的性能，一般不建议使用。</p><p>生产者通过调用channel.conﬁrmSelect方法（即Conﬁrm.Select命令）将信道设置为conﬁrm模式。一旦消息被投递到所有匹配的队列之后，RabbitMQ就会发送一个确认（Basic.Ack）给生产者（包含消息的唯一ID），这就使得 生产者知晓消息已经正确到达了目的地了。</p><p>参考：</p><p>com.gupaoedu.transaction</p><p>com.gupaoedu.conﬁrm</p><h2 id="_2、确保消息路由到正确的队列" tabindex="-1">2、确保消息路由到正确的队列 <a class="header-anchor" href="#_2、确保消息路由到正确的队列" aria-label="Permalink to &quot;2、确保消息路由到正确的队列&quot;">​</a></h2><p>可能因为路由关键字错误、队列不存在、队列名称错误导致②失败。</p><p>使用mandatory参数和ReturnListener，可以实现消息无法路由的时候返回给生产者。</p><p>另一种方式就是使用备份交换机（alternate-exchange），无法路由的消息会发送到这个交换机上。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Map&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; arguments </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> HashMap&lt;</span><span style="color:#F97583;">String</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8;">arguments.</span><span style="color:#B392F0;">put</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;alternate-exchange&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ALTERNATE_EXCHANGE&quot;</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 指定交换机的备份交换机</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">channel.</span><span style="color:#B392F0;">exchangeDeclare</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;TEST_EXCHANGE&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;topic&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, arguments);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Map&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; arguments </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> HashMap&lt;</span><span style="color:#D73A49;">String</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt;();</span></span>
<span class="line"><span style="color:#24292E;">arguments.</span><span style="color:#6F42C1;">put</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;alternate-exchange&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ALTERNATE_EXCHANGE&quot;</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// 指定交换机的备份交换机</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;TEST_EXCHANGE&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;topic&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, arguments);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参考：</p><p>com.gupaoedu.returnlistener</p><h2 id="_3、确保消息在队列正确地存储" tabindex="-1">3、确保消息在队列正确地存储 <a class="header-anchor" href="#_3、确保消息在队列正确地存储" aria-label="Permalink to &quot;3、确保消息在队列正确地存储&quot;">​</a></h2><p>可能因为系统宕机、重启、关闭等等情况导致存储在队列的消息丢失，即③出现问题。 解决方案：</p><ol><li><p>队列持久化</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments</span></span>
<span class="line"><span style="color:#E1E4E8;">channel.</span><span style="color:#B392F0;">queueDeclare</span><span style="color:#E1E4E8;">(QUEUE_NAME, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments</span></span>
<span class="line"><span style="color:#24292E;">channel.</span><span style="color:#6F42C1;">queueDeclare</span><span style="color:#24292E;">(QUEUE_NAME, </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>交换机持久化</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// String exchange, boolean durable</span></span>
<span class="line"><span style="color:#E1E4E8;">channel.</span><span style="color:#B392F0;">exchangeDeclare</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;MY_EXCHANGE&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;true&quot;</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// String exchange, boolean durable</span></span>
<span class="line"><span style="color:#24292E;">channel.</span><span style="color:#6F42C1;">exchangeDeclare</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;MY_EXCHANGE&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>消息持久化</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">AMQP.BasicProperties properties </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> AMQP.BasicProperties.</span><span style="color:#B392F0;">Builder</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">deliveryMode</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 2代表持久化，其他代表瞬态</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">build</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">channel.</span><span style="color:#B392F0;">basicPublish</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">, QUEUE_NAME, properties, msg.</span><span style="color:#B392F0;">getBytes</span><span style="color:#E1E4E8;">());</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">AMQP.BasicProperties properties </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> AMQP.BasicProperties.</span><span style="color:#6F42C1;">Builder</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">deliveryMode</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 2代表持久化，其他代表瞬态</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">build</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">channel.</span><span style="color:#6F42C1;">basicPublish</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">, QUEUE_NAME, properties, msg.</span><span style="color:#6F42C1;">getBytes</span><span style="color:#24292E;">());</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p>集群，镜像队列，参考下一节</p></li></ol><h2 id="_4、确保消息从队列正确地投递到消费者" tabindex="-1">4、确保消息从队列正确地投递到消费者 <a class="header-anchor" href="#_4、确保消息从队列正确地投递到消费者" aria-label="Permalink to &quot;4、确保消息从队列正确地投递到消费者&quot;">​</a></h2><p>如果消费者收到消息后未来得及处理即发生异常，或者处理过程中发生异常，会导致④失败。</p><p>为了保证消息从队列可靠地到达消费者，RabbitMQ提供了消息确认机制（message acknowledgement）。消费者在订阅队列时，可以指定autoAck参数，当autoAck等于false时，RabbitMQ会等待消费者显式地回复确认信号后才从队列中移去消息。</p><p>如果消息消费失败，也可以调用Basic.Reject或者Basic.Nack来拒绝当前消息而不是确认。如果requeue参数设置为true，可以把这条消息重新存入队列，以便发给下一个消费者（当然，只有一个消费者的时候，这种方式可能会出 现无限循环重复消费的情况，可以投递到新的队列中，或者只打印异常日志）。</p><h2 id="_5、消费者回调" tabindex="-1">5、消费者回调 <a class="header-anchor" href="#_5、消费者回调" aria-label="Permalink to &quot;5、消费者回调&quot;">​</a></h2><p>消费者处理消息以后，可以再发送一条消息给生产者，或者调用生产者的API，告知消息处理完毕。</p><p>参考：二代支付中异步通信的回执，多次交互。某提单APP，发送碎屏保消息后，消费者必须回调API。</p><h2 id="_6、补偿机制" tabindex="-1">6、补偿机制 <a class="header-anchor" href="#_6、补偿机制" aria-label="Permalink to &quot;6、补偿机制&quot;">​</a></h2><p>对于一定时间没有得到响应的消息，可以设置一个定时重发的机制，但要控制次数，比如最多重发3次，否则会造 成消息堆积。</p><p>参考：ATM存款未得到应答时发送5次确认；ATM取款未得到应答时，发送5次冲正。根据业务表状态做一个重发。</p><h2 id="_7、消息幂等性" tabindex="-1">7、消息幂等性 <a class="header-anchor" href="#_7、消息幂等性" aria-label="Permalink to &quot;7、消息幂等性&quot;">​</a></h2><p>服务端是没有这种控制的，只能在消费端控制。如何避免消息的重复消费？</p><p>消息重复可能会有两个原因：</p><p>1、生产者的问题，环节①重复发送消息，比如在开启了Conﬁrm模式但未收到确认。</p><p>2、环节④出了问题，由于消费者未发送ACK或者其他原因，消息重复投递。</p><p>对于重复发送的消息，可以对每一条消息生成一个唯一的业务ID，通过日志或者建表来做重复控制。 参考：银行的重账控制环节。</p><h2 id="_8、消息的顺序性" tabindex="-1">8、消息的顺序性 <a class="header-anchor" href="#_8、消息的顺序性" aria-label="Permalink to &quot;8、消息的顺序性&quot;">​</a></h2><p>消息的顺序性指的是消费者消费的顺序跟生产者产生消息的顺序是一致的。</p><p>在RabbitMQ中，一个队列有多个消费者时，由于不同的消费者消费消息的速度是不一样的，顺序无法保证。</p><p>参考：消息：1、新增门店 2、绑定产品 3、激活门店，这种情况下消息消费顺序不能颠倒。</p><h1 id="高可用架构" tabindex="-1">高可用架构 <a class="header-anchor" href="#高可用架构" aria-label="Permalink to &quot;高可用架构&quot;">​</a></h1><p><img src="`+o+'" alt="RabbitMQ_可靠性投递和实践_高可用架构.png"></p><h2 id="rabbitmq集群" tabindex="-1">RabbitMQ集群 <a class="header-anchor" href="#rabbitmq集群" aria-label="Permalink to &quot;RabbitMQ集群&quot;">​</a></h2><p>集群主要用于实现高可用与负载均衡。</p><p>RabbitMQ通过/var/lib/rabbitmq/.erlang.cookie来验证身份，需要在所有节点上保持一致。</p><p>集群有两种节点类型，一种是磁盘节点，一种是内存节点。集群中至少需要一个磁盘节点以实现元数据的持久化， 未指定类型的情况下，默认为磁盘节点。</p><p>集群通过25672端口两两通信，需要开放防火墙的端口。</p><p>需要注意的是，RabbitMQ集群无法搭建在广域网上，除非使用federation或者shovel等插件。 集群的配置步骤：</p><p>1、配置hosts</p><p>2、同步erlang.cookie</p><p>3、加入集群</p><h2 id="rabbitmq镜像队列" tabindex="-1">RabbitMQ镜像队列 <a class="header-anchor" href="#rabbitmq镜像队列" aria-label="Permalink to &quot;RabbitMQ镜像队列&quot;">​</a></h2><p>集群方式下，队列和消息是无法在节点之间同步的，因此需要使用RabbitMQ的镜像队列机制进行同步。</p><table><thead><tr><th><strong>操作方式</strong></th><th><strong>命令或步骤</strong></th></tr></thead><tbody><tr><td>rabbitmqctl (Windows)</td><td>rabbitmqctl set_policy ha-all &quot;^ha.&quot; &quot;{&quot;&quot;ha-mode&quot;&quot;:&quot;&quot;all&quot;&quot;}&quot;</td></tr><tr><td>HTTP API</td><td>PUT /api/policies/%2f/ha-all {&quot;pattern&quot;:&quot;^ha.&quot;, &quot;deﬁnition&quot;:{&quot;ha-mode&quot;:&quot;all&quot;}}</td></tr><tr><td>Web UI</td><td>Navigate to Admin &gt; Policies &gt; Add / update a policy Name输入：mirror_image Pattern输入：^（代表匹配所有） Deﬁnition点击 HA mode，右边输入：all</td></tr></tbody></table><p>如图：</p><p><img src="'+e+`" alt="RabbitMQ_可靠性投递和实践_镜像队列.png"></p><p>参考资料：</p><p><a href="https://blog.csdn.net/u013256816/article/details/71097186" target="_blank" rel="noreferrer">RabbitMQ之镜像队列</a></p><h2 id="haproxy负载-keepalived高可用" tabindex="-1">HAproxy负载+Keepalived高可用 <a class="header-anchor" href="#haproxy负载-keepalived高可用" aria-label="Permalink to &quot;HAproxy负载+Keepalived高可用&quot;">​</a></h2><p>在两个内存节点上安装HAProxy</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">haproxy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">haproxy</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>编辑配置文件</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/haproxy/haproxy.cfg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/haproxy/haproxy.cfg</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>内容修改为：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">global</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">local2</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">chroot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/haproxy</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">pidfile</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/run/haproxy.pid</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">maxconn</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4000</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">user</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">haproxy</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">group</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">haproxy</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">daemon</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">stats</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">socket</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/haproxy/stats</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">defaults</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">global</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">option</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dontlognull</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">option</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">redispatch</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">retries</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">timeout</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connect</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">timeout</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">client</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">timeout</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">maxconn</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">listen</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http_front</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">mode</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">bind</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0:1080</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#监听端口</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">stats</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">refresh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">30</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#统计页面自动刷新时间</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">stats</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uri</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/haproxy?stats</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#统计页面url</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">stats</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">realm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Haproxy</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Manager</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#统计页面密码框上提示文本</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">stats</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">auth</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin:123456</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#统计页面用户名和密码设置</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">listen</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rabbitmq_admin</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">bind</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0:15673</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.8.40:15672</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.8.45:15672</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#B392F0;">listen</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rabbitmq_cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0:5673</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">mode</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">balance</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">roundrobin</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">timeout</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">client</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">h</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">timeout</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">h</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">timeout</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connect</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">h</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.8.40:5672</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">check</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">inter</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rise</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fall</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.8.45:5672</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">check</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">inter</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rise</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fall</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">global</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">local2</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">chroot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/haproxy</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">pidfile</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/run/haproxy.pid</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">maxconn</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4000</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">user</span><span style="color:#24292E;"> </span><span style="color:#032F62;">haproxy</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">group</span><span style="color:#24292E;"> </span><span style="color:#032F62;">haproxy</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">daemon</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">stats</span><span style="color:#24292E;"> </span><span style="color:#032F62;">socket</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/haproxy/stats</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">defaults</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">global</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">option</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dontlognull</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">option</span><span style="color:#24292E;"> </span><span style="color:#032F62;">redispatch</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">retries</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">timeout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connect</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">timeout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">client</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">timeout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">maxconn</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">listen</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http_front</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">mode</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">bind</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0:1080</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#监听端口</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">stats</span><span style="color:#24292E;"> </span><span style="color:#032F62;">refresh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span><span style="color:#032F62;">s</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#统计页面自动刷新时间</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">stats</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uri</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/haproxy?stats</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#统计页面url</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">stats</span><span style="color:#24292E;"> </span><span style="color:#032F62;">realm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Haproxy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Manager</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#统计页面密码框上提示文本</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">stats</span><span style="color:#24292E;"> </span><span style="color:#032F62;">auth</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin:123456</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#统计页面用户名和密码设置</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">listen</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbitmq_admin</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">bind</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0:15673</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.8.40:15672</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.8.45:15672</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#6F42C1;">listen</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbitmq_cluster</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0:5673</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">mode</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">balance</span><span style="color:#24292E;"> </span><span style="color:#032F62;">roundrobin</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">timeout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">client</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">timeout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">timeout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connect</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.8.40:5672</span><span style="color:#24292E;"> </span><span style="color:#032F62;">check</span><span style="color:#24292E;"> </span><span style="color:#032F62;">inter</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rise</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fall</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.8.45:5672</span><span style="color:#24292E;"> </span><span style="color:#032F62;">check</span><span style="color:#24292E;"> </span><span style="color:#032F62;">inter</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rise</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fall</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>启动HAProxy</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">haproxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/haproxy/haproxy.cfg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">haproxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/haproxy/haproxy.cfg</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>安装Keepalived</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">yum </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">y install keepalived</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">yum </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">y install keepalived</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>修改配置文件</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/keepalived/keepalived.conf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/keepalived/keepalived.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>内容改成（物理网卡和当前主机IP要修改）：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">global_defs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">notification_email</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">acassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">failover@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">notification_email_from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">smtp_server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.200.1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">smtp_connect_timeout</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">router_id</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LVS_DEVEL</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># vrrp_strict # 注释掉，不然访问不到VIP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">vrrp_garp_interval</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">vrrp_gna_interval</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">global_defs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">notification_email</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">acassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">failover@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">notification_email_from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">smtp_server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.200.1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">smtp_connect_timeout</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">router_id</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LVS_DEVEL</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># vrrp_strict # 注释掉，不然访问不到VIP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">vrrp_garp_interval</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">vrrp_gna_interval</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#6A737D;"># 检测任务</span></span>
<span class="line"><span style="color:#B392F0;">vrrp_script</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">check_haproxy</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 检测HAProxy脚本</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">script</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/etc/keepalived/script/check_haproxy.sh&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 每隔两秒检测</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">interval</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 权重</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">weight</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#6A737D;"># 虚拟组</span></span>
<span class="line"><span style="color:#B392F0;">vrrp_instance</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">haproxy</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MASTER</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 此处为\`主\`，备机是 \`BACKUP\`</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ens33</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 物理网卡，根据情况而定</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">mcast_src_ip</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.8.40</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 当前主机ip</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">virtual_router_id</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">51</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 虚拟路由id，同一个组内需要相同</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">priority</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 主机的优先权要比备机高</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">advert_int</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 心跳检查频率，单位：秒</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">authentication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 认证，组内的要相同</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">auth_type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PASS</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">auth_pass</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1111</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 调用脚本</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">track_script</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">check_haproxy</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 虚拟ip，多个换行</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">virtual_ipaddress</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">192.168.8.201</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">global_defs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">notification_email</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">acassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">failover@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">notification_email_from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">smtp_server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.200.1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">smtp_connect_timeout</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">router_id</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LVS_DEVEL</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># vrrp_strict # 注释掉，不然访问不到VIP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">vrrp_garp_interval</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">vrrp_gna_interval</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">global_defs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">notification_email</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">acassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">failover@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">notification_email_from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">smtp_server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.200.1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">smtp_connect_timeout</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">router_id</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LVS_DEVEL</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># vrrp_strict # 注释掉，不然访问不到VIP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">vrrp_garp_interval</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">vrrp_gna_interval</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6A737D;"># 检测任务</span></span>
<span class="line"><span style="color:#6F42C1;">vrrp_script</span><span style="color:#24292E;"> </span><span style="color:#032F62;">check_haproxy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 检测HAProxy脚本</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">script</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/etc/keepalived/script/check_haproxy.sh&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 每隔两秒检测</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">interval</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 权重</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">weight</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#6A737D;"># 虚拟组</span></span>
<span class="line"><span style="color:#6F42C1;">vrrp_instance</span><span style="color:#24292E;"> </span><span style="color:#032F62;">haproxy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">state</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MASTER</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 此处为\`主\`，备机是 \`BACKUP\`</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">interface</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ens33</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 物理网卡，根据情况而定</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">mcast_src_ip</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.8.40</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 当前主机ip</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">virtual_router_id</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">51</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 虚拟路由id，同一个组内需要相同</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">priority</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 主机的优先权要比备机高</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">advert_int</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 心跳检查频率，单位：秒</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">authentication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 认证，组内的要相同</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">auth_type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PASS</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">auth_pass</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1111</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 调用脚本</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">track_script</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">check_haproxy</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 虚拟ip，多个换行</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">virtual_ipaddress</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">192.168.8.201</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>启动keepalived</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">keepalived</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-D</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">keepalived</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-D</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h1 id="网络分区" tabindex="-1">网络分区 <a class="header-anchor" href="#网络分区" aria-label="Permalink to &quot;网络分区&quot;">​</a></h1><p>为什么会出现分区？因为RabbitMQ对网络延迟非常敏感，为了保证数据一致性和性能，在出现网络故障时，集群 节点会出现分区。</p><p>参 考 脑 图 .xmind</p><p><a href="https://blog.csdn.net/u013256816/article/details/53588206" target="_blank" rel="noreferrer">RabbitMQ Network Partitions</a></p><p><a href="https://blog.csdn.net/u013256816/article/details/73757884" target="_blank" rel="noreferrer">RabbitMQ Network Partitions 处理策略</a></p><p><a href="https://blog.csdn.net/u013256816/article/details/74998896" target="_blank" rel="noreferrer">模拟RabbitMQ网络分区</a></p><h1 id="广域网的同步方案" tabindex="-1">广域网的同步方案 <a class="header-anchor" href="#广域网的同步方案" aria-label="Permalink to &quot;广域网的同步方案&quot;">​</a></h1><p>federation插件</p><p>shovel插件</p><h1 id="实践经验总结" tabindex="-1">实践经验总结 <a class="header-anchor" href="#实践经验总结" aria-label="Permalink to &quot;实践经验总结&quot;">​</a></h1><h2 id="_1、配置文件与命名规范" tabindex="-1">1、配置文件与命名规范 <a class="header-anchor" href="#_1、配置文件与命名规范" aria-label="Permalink to &quot;1、配置文件与命名规范&quot;">​</a></h2><p>集中放在properties文件中</p><p>体现元数据类型（_VHOST _EXCHANGE _QUEUE）；</p><p>体现数据来源和去向（XXX_TO_XXX）；</p><h2 id="_2、调用封装" tabindex="-1">2、调用封装 <a class="header-anchor" href="#_2、调用封装" aria-label="Permalink to &quot;2、调用封装&quot;">​</a></h2><p>可以对 Template 做进一步封装，简化消息的发送。</p><h2 id="_3、信息落库-定时任务" tabindex="-1">3、信息落库+定时任务 <a class="header-anchor" href="#_3、信息落库-定时任务" aria-label="Permalink to &quot;3、信息落库+定时任务&quot;">​</a></h2><p>将需要发送的消息保存在数据库中，可以实现消息的可追溯和重复控制，需要配合定时任务来实现。</p><h2 id="_4、运维监控" tabindex="-1">4、运维监控 <a class="header-anchor" href="#_4、运维监控" aria-label="Permalink to &quot;4、运维监控&quot;">​</a></h2><p>参考：</p><p><a href="http://blog.51cto.com/yanconggod/2069376" target="_blank" rel="noreferrer">zabbix系列zabbix3.4监控rabbitmq</a></p><h2 id="_5、插件" tabindex="-1">5、插件 <a class="header-anchor" href="#_5、插件" aria-label="Permalink to &quot;5、插件&quot;">​</a></h2><p>tracing <a href="https://www.rabbitmq.com/plugins.html" target="_blank" rel="noreferrer">https://www.rabbitmq.com/plugins.html</a></p><p><img src="`+r+'" alt="RabbitMQ_可靠性投递和实践_插件列表.png"></p><h2 id="_6、如何减少连接数" tabindex="-1">6、如何减少连接数 <a class="header-anchor" href="#_6、如何减少连接数" aria-label="Permalink to &quot;6、如何减少连接数&quot;">​</a></h2><p>合并消息的发送，建议单条消息不要超过4M（4096KB）</p><h1 id="思考" tabindex="-1">思考 <a class="header-anchor" href="#思考" aria-label="Permalink to &quot;思考&quot;">​</a></h1><p>消费者的集群或者微服务的多个实例，会不会重复接收消息？ 生产者先发送消息还是先登记业务表？（打款错误的例子） 谁来创建对象（交换机、队列、绑定关系）？</p><p>重复创建会有什么问题？</p><p>持久化的队列和非持久化的交换机可以绑定吗？可以</p><p>如何设计一个MQ服务？ <a href="http://www.xuxueli.com/xxl-mq/%23/" target="_blank" rel="noreferrer">http://www.xuxueli.com/xxl-mq/#/</a></p><h1 id="面试题" tabindex="-1">面试题 <a class="header-anchor" href="#面试题" aria-label="Permalink to &quot;面试题&quot;">​</a></h1><p>1、消息队列的作用与使用场景？</p><p>2、创建队列和交换机的方法？</p><p>3、多个消费者监听一个生产者时，消息如何分发？</p><p>4、无法被路由的消息，去了哪里？</p><p>5、消息在什么时候会变成Dead Letter（死信）？</p><p>6、RabbitMQ如何实现延迟队列？</p><p>7、如何保证消息的可靠性投递？</p><p>8、如何在服务端和消费端做限流？</p><p>9、如何保证消息的顺序性？</p><p>10、RabbitMQ的节点类型？</p><h1 id="课后作业" tabindex="-1">课后作业 <a class="header-anchor" href="#课后作业" aria-label="Permalink to &quot;课后作业&quot;">​</a></h1><ol><li>安装Erlang、RabbitMQ</li><li>高可用集群搭建（可选）</li><li>编写 Java API</li><li>SpringBoot 集成 RabbitMQ</li></ol><h1 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h1><ol><li>GitLib代码</li><li>安装文件</li><li>PDF书籍</li><li>常用命令</li></ol>',126),E=[c];function i(y,F,b,u,d,h){return a(),n("div",null,E)}const B=s(t,[["render",i]]);export{C as __pageData,B as default};
