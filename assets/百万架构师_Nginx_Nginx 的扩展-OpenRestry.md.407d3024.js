import{_ as s,o as n,h as a,Q as l}from"./chunks/framework.da611722.js";const p="/assets/JavaGuide_Nginx_扩展_OpenRestry_多路复用.8e9a96f4.png",e="/assets/JavaGuide_Nginx_扩展_OpenRestry_Nginx进程模型.71eb3c38.png",o="/assets/JavaGuide_Nginx_扩展_OpenRestry_Nginx一台服务器.cc8ac9f5.png",r="/assets/JavaGuide_Nginx_扩展_OpenRestry_Nginx多台服务器.63197a1e.png",c="/assets/JavaGuide_Nginx_扩展_OpenRestry_Nginx多台服务器切换.788c27eb.png",t="/assets/JavaGuide_Nginx_扩展_OpenRestry_Nginx之间通过keepalived切换.e9ad73aa.png",E="/assets/JavaGuide_Nginx_扩展_OpenRestry_F5_Nginx做高可用.9100598e.png",i="/assets/JavaGuide_Nginx_扩展_OpenRestry_Nginx的轻量级的主备竞选高可用方案.586f9fb2.png",y="/assets/JavaGuide_Nginx_扩展_OpenRestry_keepalived状态.aac55e16.png",b="/assets/JavaGuide_Nginx_扩展_OpenRestry_keepalived_LVS.b5031a28.png",u="/assets/JavaGuide_Nginx_扩展_OpenRestry_keepalived_配置的几点.342d17e4.png",d="/assets/JavaGuide_Nginx_扩展_OpenRestry_nginx_hello_world.a7a83619.png",m="/assets/JavaGuide_Nginx_扩展_OpenRestry_sub.e456a5b5.png",F="/assets/JavaGuide_Nginx_扩展_OpenRestry_nginx_test_index.2d94211e.png",g="/assets/JavaGuide_Nginx_扩展_OpenRestry_nginx_lua脚本.20a30304.png",v="/assets/JavaGuide_Nginx_扩展_OpenRestry_多个GateWay网关服务.d7fde386.png",_="/assets/JavaGuide_Nginx_扩展_OpenRestry_Lua插件图解.7ffa2af8.png",C="/assets/JavaGuide_Nginx_扩展_OpenRestry_nginx做灰度切换.cec1c9a6.png",D="/assets/JavaGuide_Nginx_扩展_OpenRestry_tomcat请求界面.8b4a19b1.png",h="/assets/JavaGuide_Nginx_扩展_OpenRestry_高可用配置正确.e2ac4721.png",T=JSON.parse('{"title":"Nginx 的扩展-OpenRestry | JavaGuide","description":"","frontmatter":{"head":[["link",{"rel":"canonical","href":"https://JavaGuide.net/百万架构师/Nginx/Nginx 的扩展-OpenRestry.html"}],["meta",{"name":"keywords","content":"Nginx 的扩展-OpenRestry , JavaGuide , JavaGuide官网, Java面试指南, Java基础, 多线程, JVM, 虚拟机, 数据库, MySQL, Spring, Redis, MyBatis, 系统设计, 分布式, RPC, 高可用, 高并发"}],["meta",{"name":"og:url","content":"https://JavaGuide.net"}],["meta",{"name":"og:type","content":"website"}],["meta",{"name":"og:image","content":"https://JavaGuide.net/JavaGuide-og.png"}],["meta",{"name":"og:title","content":"Nginx 的扩展-OpenRestry | JavaGuide | Java面试指南 | JavaGuide官网"}],["meta",{"name":"og:description","content":"Nginx 的扩展-OpenRestry | JavaGuide | Java面试指南 | JavaGuide官网 | 「JavaGuide.net」一份涵盖大部分 Java 程序员所需要掌握的核心知识。准备 Java 面试，首选 JavaGuide.net ！"}],["meta",{"name":"twitter:site","content":"https://JavaGuide.net"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:creator","content":"nogeek.cn"}],["meta",{"name":"twitter:title","content":"Nginx 的扩展-OpenRestry | JavaGuide | Java面试指南 | JavaGuide官网"}],["meta",{"name":"twitter:description","content":"Nginx 的扩展-OpenRestry | JavaGuide | Java面试指南 | JavaGuide官网 | 「JavaGuide.net」一份涵盖大部分 Java 程序员所需要掌握的核心知识。准备 Java 面试，首选 JavaGuide.net ！"}],["meta",{"name":"twitter:image","content":"https://JavaGuide.net/JavaGuide-og.png"}],["meta",{"name":"sogou_site_verification","content":"fcAkazTXFd"}],["meta",{"name":"baidu-site-verification","content":"codeva-MXEPYsXKGk"}],["meta",{"name":"msvalidate.01","content":"9F2D57CFC59E8031212A166878638B15"}]]},"headers":[],"relativePath":"百万架构师/Nginx/Nginx 的扩展-OpenRestry.md","filePath":"百万架构师/Nginx/Nginx 的扩展-OpenRestry.md","lastUpdated":1741277271000}'),A={name:"百万架构师/Nginx/Nginx 的扩展-OpenRestry.md"},k=l(`<h1 id="nginx-的扩展-openrestry" tabindex="-1">Nginx 的扩展-OpenRestry <a class="header-anchor" href="#nginx-的扩展-openrestry" aria-label="Permalink to &quot;Nginx 的扩展-OpenRestry&quot;">​</a></h1><h3 id="课程目标" tabindex="-1">课程目标 <a class="header-anchor" href="#课程目标" aria-label="Permalink to &quot;课程目标&quot;">​</a></h3><ol><li><p>Nginx 进程模型简介</p></li><li><p>Nginx 的高可用方案</p></li><li><p>OpenResty 安装及使用</p></li><li><p>什么是 API 网关？</p></li><li><p>OpenResty 实现灰度发布功能</p></li></ol><h1 id="nginx-进程模型简介" tabindex="-1">Nginx 进程模型简介 <a class="header-anchor" href="#nginx-进程模型简介" aria-label="Permalink to &quot;Nginx 进程模型简介&quot;">​</a></h1><h3 id="多进程" tabindex="-1">多进程 <a class="header-anchor" href="#多进程" aria-label="Permalink to &quot;多进程&quot;">​</a></h3><ul><li><p>Tomcat</p><ul><li>BIO</li><li>NIO</li><li>AIO</li></ul></li><li><p>Nginx</p><ul><li>多进程+多路复用</li><li>master 进程 、 worker 进程</li></ul></li></ul><p>​ 当它启动以后，会产生一个主进程和多个工作进程。多个工作进程是通过 Master 进程去管理的。它是基于 Master 进程 Fork 出来的。当我们的 Nginx 收到一个请求的时候，它会向我们的 work 发送一个信号。然后通过 worker 进程去管理。类似于中心进程的意思。</p><p>​ 当有一个请求过来的时候，只会有一个 <code>worker</code> 进程去处理。</p><table><thead><tr><th>root /nginx</th><th>7473</th><th>1</th><th>0 20:09</th><th>?</th><th>00:00:00 nginx:</th><th>master process .</th></tr></thead><tbody><tr><td>nobody</td><td>7474</td><td>7473</td><td>0 20:09</td><td>?</td><td>00:00:00 nginx:</td><td>worker process</td></tr></tbody></table><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 nginx]# ps </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ef</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">grep nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">root      </span><span style="color:#79B8FF;">47432</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">:0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">:</span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> nginx: master process .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">nobody    </span><span style="color:#79B8FF;">47433</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">47432</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">:0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">:</span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> nginx: worker process</span></span>
<span class="line"><span style="color:#E1E4E8;">root      </span><span style="color:#79B8FF;">47438</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">47405</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;"> pts</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">:</span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">:</span><span style="color:#F97583;">0</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> grep </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">color</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">auto nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 nginx]#</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 nginx]# ps </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ef</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">grep nginx</span></span>
<span class="line"><span style="color:#24292E;">root      </span><span style="color:#005CC5;">47432</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">?</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">:0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">:</span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> nginx: master process .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span></span>
<span class="line"><span style="color:#24292E;">nobody    </span><span style="color:#005CC5;">47433</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">47432</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">?</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">:0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">:</span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> nginx: worker process</span></span>
<span class="line"><span style="color:#24292E;">root      </span><span style="color:#005CC5;">47438</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">47405</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;"> pts</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">:</span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">:</span><span style="color:#D73A49;">0</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> grep </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">color</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">auto nginx</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 nginx]#</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="`+p+`" alt="JavaGuide_Nginx_扩展_OpenRestry_多路复用.png"></p><p>​ Master 进程会去管理每一个 worker 进程。当客户端发起一个请求的时候，它会由 worker 进程去处理，而不是由 Master 进程去处理。如果有多个 worker 进程的时候，一个请求过来，多个 worker 会有竞争。每一个进程会去争抢获得这样的一个许可。</p><p>​ 相当于多个 worker 进程 组成一个集群去实现，每一个 worker 进程后边是多路复用。</p><h5 id="nginx-配置几个进程" tabindex="-1">Nginx 配置几个进程 <a class="header-anchor" href="#nginx-配置几个进程" aria-label="Permalink to &quot;Nginx 配置几个进程&quot;">​</a></h5><ul><li><p>工作进程建议设置成我们的 CPU 总核心数。</p></li><li><p>IO模型</p><ul><li>epoll . select ....</li></ul></li><li><p>Linux 理论上最大的连接数是 6535 。</p></li></ul><p>最后支持的就是 <strong>CPU 数 * 进程数</strong> 。</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"># 用户组，这个用户组是当前 Linux 的用户组。和用户账号</span></span>
<span class="line"><span style="color:#E1E4E8;">#user  nobody;         </span></span>
<span class="line"><span style="color:#E1E4E8;"># Nginx 工作进程数， 建议设置成我们的 CPU 总核心数。 </span></span>
<span class="line"><span style="color:#E1E4E8;">worker_processes  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#error_log  logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;">#error_log  logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log  notice;</span></span>
<span class="line"><span style="color:#E1E4E8;">#error_log  logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log  info;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#pid        logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx.pid;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">events {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # io 模型</span></span>
<span class="line"><span style="color:#E1E4E8;">    use epoll ;  </span></span>
<span class="line"><span style="color:#E1E4E8;">    # 理论上  processes</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> connections</span></span>
<span class="line"><span style="color:#E1E4E8;">    worker_connections  </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">；  </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"># 用户组，这个用户组是当前 Linux 的用户组。和用户账号</span></span>
<span class="line"><span style="color:#24292E;">#user  nobody;         </span></span>
<span class="line"><span style="color:#24292E;"># Nginx 工作进程数， 建议设置成我们的 CPU 总核心数。 </span></span>
<span class="line"><span style="color:#24292E;">worker_processes  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#error_log  logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log;</span></span>
<span class="line"><span style="color:#24292E;">#error_log  logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log  notice;</span></span>
<span class="line"><span style="color:#24292E;">#error_log  logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log  info;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#pid        logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx.pid;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">events {</span></span>
<span class="line"><span style="color:#24292E;">    # io 模型</span></span>
<span class="line"><span style="color:#24292E;">    use epoll ;  </span></span>
<span class="line"><span style="color:#24292E;">    # 理论上  processes</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> connections</span></span>
<span class="line"><span style="color:#24292E;">    worker_connections  </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">；  </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><img src="`+e+`" alt="JavaGuide_Nginx_扩展_OpenRestry_Nginx进程模型.png"></p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#user  nobody;</span></span>
<span class="line"><span style="color:#E1E4E8;">worker_processes  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#error_log  logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;">#error_log  logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log  notice;</span></span>
<span class="line"><span style="color:#E1E4E8;">#error_log  logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log  info;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#pid        logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx.pid;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">events {</span></span>
<span class="line"><span style="color:#E1E4E8;">    worker_connections  </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">http {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 媒体类型，</span></span>
<span class="line"><span style="color:#E1E4E8;">    include       mime.types;</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 默认的配置是二进制字节流</span></span>
<span class="line"><span style="color:#E1E4E8;">    default_type  application</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">octet</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">stream;</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 日志格式，命名，把日志放到某一个文件里边，然后用 Kafka 收集起来，最后做分析</span></span>
<span class="line"><span style="color:#E1E4E8;">    log_format  main  </span><span style="color:#9ECBFF;">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 访问日志，每一个请求都会记录一个日志</span></span>
<span class="line"><span style="color:#E1E4E8;">    #access_log  logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">access.log  main;</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 是否开启 </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> 拷贝模式，我们传输文件 </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> 拷贝效率高</span></span>
<span class="line"><span style="color:#E1E4E8;">    sendfile        on;</span></span>
<span class="line"><span style="color:#E1E4E8;">    # tcp 超时时间</span></span>
<span class="line"><span style="color:#E1E4E8;">    #tcp_nopush     on;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    #keepalive_timeout  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    keepalive_timeout  </span><span style="color:#79B8FF;">65</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    # 扫描这个目录下的配置文件</span></span>
<span class="line"><span style="color:#E1E4E8;">    include    extra</span><span style="color:#6A737D;">/*.conf;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    # 是否打开 gzip</span></span>
<span class="line"><span style="color:#6A737D;">    gzip on;</span></span>
<span class="line"><span style="color:#6A737D;">    # 超过多长长度再进行压缩</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_min_length 5K;</span></span>
<span class="line"><span style="color:#6A737D;">    # 压缩的等级越高，压缩后的文件越小，占用的 CPU 越高</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_comp_level 3;</span></span>
<span class="line"><span style="color:#6A737D;">    # 对哪些文件去做压缩</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_types application/javascript image/jpeg;</span></span>
<span class="line"><span style="color:#6A737D;">    # 设置缓冲区，按照我们我们指定大小的倍数去申请内存，</span></span>
<span class="line"><span style="color:#6A737D;">    # 按照我们原始文件的大小，以 32K 为单位的四倍去申请内存。</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_buffers 4 32k;</span></span>
<span class="line"><span style="color:#6A737D;">    # 是否传输 “vary: Accept-Encoding” 的文件头标志</span></span>
<span class="line"><span style="color:#6A737D;">    # 根据客户端的头去判断我们是不是要去做压缩。</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_vary on;</span></span>
<span class="line"><span style="color:#6A737D;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span>
<span class="line"><span style="color:#24292E;">#user  nobody;</span></span>
<span class="line"><span style="color:#24292E;">worker_processes  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#error_log  logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log;</span></span>
<span class="line"><span style="color:#24292E;">#error_log  logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log  notice;</span></span>
<span class="line"><span style="color:#24292E;">#error_log  logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log  info;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#pid        logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx.pid;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">events {</span></span>
<span class="line"><span style="color:#24292E;">    worker_connections  </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">http {</span></span>
<span class="line"><span style="color:#24292E;">    # 媒体类型，</span></span>
<span class="line"><span style="color:#24292E;">    include       mime.types;</span></span>
<span class="line"><span style="color:#24292E;">    # 默认的配置是二进制字节流</span></span>
<span class="line"><span style="color:#24292E;">    default_type  application</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">octet</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">stream;</span></span>
<span class="line"><span style="color:#24292E;">    # 日志格式，命名，把日志放到某一个文件里边，然后用 Kafka 收集起来，最后做分析</span></span>
<span class="line"><span style="color:#24292E;">    log_format  main  </span><span style="color:#032F62;">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    # 访问日志，每一个请求都会记录一个日志</span></span>
<span class="line"><span style="color:#24292E;">    #access_log  logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">access.log  main;</span></span>
<span class="line"><span style="color:#24292E;">    # 是否开启 </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> 拷贝模式，我们传输文件 </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> 拷贝效率高</span></span>
<span class="line"><span style="color:#24292E;">    sendfile        on;</span></span>
<span class="line"><span style="color:#24292E;">    # tcp 超时时间</span></span>
<span class="line"><span style="color:#24292E;">    #tcp_nopush     on;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    #keepalive_timeout  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    keepalive_timeout  </span><span style="color:#005CC5;">65</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    # 扫描这个目录下的配置文件</span></span>
<span class="line"><span style="color:#24292E;">    include    extra</span><span style="color:#6A737D;">/*.conf;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    # 是否打开 gzip</span></span>
<span class="line"><span style="color:#6A737D;">    gzip on;</span></span>
<span class="line"><span style="color:#6A737D;">    # 超过多长长度再进行压缩</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_min_length 5K;</span></span>
<span class="line"><span style="color:#6A737D;">    # 压缩的等级越高，压缩后的文件越小，占用的 CPU 越高</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_comp_level 3;</span></span>
<span class="line"><span style="color:#6A737D;">    # 对哪些文件去做压缩</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_types application/javascript image/jpeg;</span></span>
<span class="line"><span style="color:#6A737D;">    # 设置缓冲区，按照我们我们指定大小的倍数去申请内存，</span></span>
<span class="line"><span style="color:#6A737D;">    # 按照我们原始文件的大小，以 32K 为单位的四倍去申请内存。</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_buffers 4 32k;</span></span>
<span class="line"><span style="color:#6A737D;">    # 是否传输 “vary: Accept-Encoding” 的文件头标志</span></span>
<span class="line"><span style="color:#6A737D;">    # 根据客户端的头去判断我们是不是要去做压缩。</span></span>
<span class="line"><span style="color:#6A737D;">    gzip_vary on;</span></span>
<span class="line"><span style="color:#6A737D;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h1 id="nginx-的高可用方案" tabindex="-1">Nginx 的高可用方案 <a class="header-anchor" href="#nginx-的高可用方案" aria-label="Permalink to &quot;Nginx 的高可用方案&quot;">​</a></h1><p><img src="`+o+'" alt="JavaGuide_Nginx_扩展_OpenRestry_Nginx一台服务器.png"></p><p>​ 这模型的整个吞吐量是有限的。一旦大了以后，就会崩溃</p><p>​ Nginx 作为反向代理服务器，所有的流量都会经过 Nginx，所以 Nginx 本身的可靠性是我们首先要考虑的问题。</p><p><img src="'+r+'" alt="JavaGuide_Nginx_扩展_OpenRestry_Nginx多台服务器.png"></p><p>​ 问题： HTTP Server 之间的同步，出现问题的切换，DNS 是没有办法解决的。</p><p>​ 通过 Nginx 去代理后端应用的服务器。Nginx 对外是一个 IP 地址，七层负载，做一个转发，通过应用层的 URI 做一些转发。 我可以做 IP_Hash 、轮询、权重 ... ... 各种方式去做转发。</p><p>​ Nginx 性能比 Tomcat 高得多得多。高性能的反向代理服务器。（DNS 是对域名做解析的。）通过 Nginx 做一个集群。</p><p><img src="'+c+'" alt="JavaGuide_Nginx_扩展_OpenRestry_Nginx多台服务器切换.png"></p><p>​ 我们为了避免单点故障，就需要解决 Nginx 的单点问题！！！</p><p><img src="'+t+'" alt="JavaGuide_Nginx_扩展_OpenRestry_Nginx之间通过keepalived切换.png"></p><p>​ 我一个请求过来，会根据它的一个 IP + 端口号 做一个转发，转发以后，后续请求，不是通过 F5 去做一个返回。而是直接返回，只是通过 F5 做一个解析而已。 F5 的性能 Nginx 更高。</p><p><img src="'+E+'" alt="JavaGuide_Nginx_扩展_OpenRestry_F5_Nginx做高可用.png"></p><p>流量问题，不能纯靠技术问题去解决。</p><blockquote><p>www.baidu.com 它是可以分发到不同的站点的，叫做 <strong>地域服务器</strong> 。</p><p>在北京访问北京的机房。其他的地方，访问其他地方的机房。</p><p>流量是无限的。我们需要通过 多机房，地域来解析。</p><p>把你的请求转发到离你最近的服务器上。</p></blockquote><h2 id="keepalived" tabindex="-1">keepalived <a class="header-anchor" href="#keepalived" aria-label="Permalink to &quot;keepalived&quot;">​</a></h2><p>keeppalived 可以生成 虚拟IP ( vip )。</p><p>​ <strong>Keepalived</strong> 是 Linux 下一个轻量级别的高可用解决方案，Keepalived 软件起初是专为 <strong>LVS 负载均衡软件</strong> 设计的，用来管理并监控 LVS 集群系统中各个服务节点的状态，后来又加入了可以实现高可用的 VRRP 功能。因此，Keepalived 除了能够管理 LVS 软件外，还可以作为其他服务（例如：Nginx、Haproxy、MySQL 等）的高可用解决方案软件。</p><p>​ Keepalived 软件主要是通过 <strong>VRRP</strong> 协议实现高可用功能的。<strong>VRRP</strong> 是 Virtual Router RedundancyProtocol （虚拟路由器冗余协议）的缩写，VRRP 出现的目的就是为了解决静态路由单点故障问题的，它能够保证当个别节点宕机时，整个网络可以不间断地运行;(简单来说，vrrp 就是把两台或多台路由器设备虚拟成一个设备， 实现主备高可用)。（它是虚拟 IP ）</p><p>​ 所以，Keepalived 一方面具有配置管理 LVS 的功能，同时还具有对 LVS 下面节点进行健康检查的功能，另一方面也可实现系统网络服务的高可用功能。</p><p>​ LVS 是 Linux Virtual Server 的缩写，也就是 Linux 虚拟服务器，在 linux2.4 内核以后，已经完全内置了 LVS 的各个功能模块。</p><p>​ 它是工作在四层的负载均衡，类似于 Haproxy, 主要用于实现对服务器集群的负载均衡。</p><p>​ 关于四层负载，我们知道 osi 网络层次模型的 7 层模型（应用层、表示层、会话层、传输层、网络层、数据链路层、物理层）；四层负载就是基于传输层，也就是 ip+端口 的负载；而七层负载就是需要基于 URL 等应用层的信息来做负载，同时还有二层负载（基于 MAC）、三层负载（IP）；</p><p>常见的四层负载有：LVS、F5 ； 七层负载有 : Nginx、HAproxy ; 在软件层面，</p><p><strong>Nginx</strong> / <strong>LVS</strong> / <strong>HAProxy</strong> 是使用得比较广泛的三种负载均衡软件</p><p>对于中小型的 Web 应用，可以使用 Nginx、大型网站或者重要的服务并且服务比较多的时候，可以考虑使用 LVS</p><h4 id="轻量级的高可用解决方案" tabindex="-1">轻量级的高可用解决方案 <a class="header-anchor" href="#轻量级的高可用解决方案" aria-label="Permalink to &quot;轻量级的高可用解决方案&quot;">​</a></h4><p>​ LVS 四层负载均衡软件（Linux virtual server） 监控 lvs 集群系统中的各个服务节点的状态VRRP 协议（虚拟路由冗余协议） linux2.4 以后，是内置在 linux 内核中的</p><p>lvs(四层) -&gt; HAproxy 七层</p><p>lvs(四层) -&gt; Nginx(七层)</p><p><img src="'+i+`" alt="JavaGuide_Nginx_扩展_OpenRestry_Nginx的轻量级的主备竞选高可用方案.png"></p><h3 id="实践" tabindex="-1">实践 <a class="header-anchor" href="#实践" aria-label="Permalink to &quot;实践&quot;">​</a></h3><ol><li><p>下载 keepalived 的安装包</p></li><li><p><code>tar -zxvf keepalived-2.0.7.tar.gz</code></p></li><li><p>在 <code>/data/program/</code> 目录下创建一个 keepalived 的文件</p></li><li><p>cd 到 keepalived-2.0.7 目录下，执行 <code>./configure -- prefix=/data/program/keepalived --sysconf=/etc</code></p></li><li><p>如果缺少依赖库，则 <code>yum install gcc;</code> <code>yum install openssl-devel ;</code> <code>yum install libnl libnl-devel</code></p></li><li><p>编译安装 <code>make &amp;&amp; make install</code></p></li><li><p>进入安装后的路径 <code>cd /data/program/keepalived</code> , 创建软连接: <code>ln -s sbin/keepalived /sbin</code></p></li><li><p><code>cp /data/program/keepalived-2.0.7/keepalived/etc/init.d/keepalived /etc/init.d</code></p><p>把运行的的服务添加进去</p></li><li><p><code>chkconfig --add keepalived</code></p></li><li><p><code>chkconfig keepalived on</code></p></li><li><p><code>service keepalived start</code></p></li></ol><blockquote><h3 id="安装步骤" tabindex="-1">安装步骤 <a class="header-anchor" href="#安装步骤" aria-label="Permalink to &quot;安装步骤&quot;">​</a></h3><p>版本，2.0.7 其他版本会有问题。</p></blockquote><blockquote><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# tar </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">zxvf keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.11.tar.gz</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# mkdir keepalived</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# cd keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.11</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.11</span><span style="color:#E1E4E8;">]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">configure </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">=/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">sysconf</span><span style="color:#F97583;">=/</span><span style="color:#E1E4E8;">etc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">configure: error: </span></span>
<span class="line"><span style="color:#F97583;">!!!</span><span style="color:#E1E4E8;"> OpenSSL is not properly installed on your system. </span><span style="color:#F97583;">!!!</span></span>
<span class="line"><span style="color:#F97583;">!!!</span><span style="color:#E1E4E8;"> Can not include OpenSSL headers files.            </span><span style="color:#F97583;">!!!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.11</span><span style="color:#E1E4E8;">]# yum install openssl</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">devel</span></span>
<span class="line"><span style="color:#E1E4E8;">Is this ok [y</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">d</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">N]: y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">***</span><span style="color:#E1E4E8;"> WARNING </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> this build will not support IPVS with IPv6. Please install libnl</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">libnl</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> dev libraries to support IPv6 with IPVS.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.11</span><span style="color:#E1E4E8;">]# yum install libnl libnl</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">devel</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.11</span><span style="color:#E1E4E8;">]# yum install gcc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.11</span><span style="color:#E1E4E8;">]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">configure </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">=/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">sysconf</span><span style="color:#F97583;">=/</span><span style="color:#E1E4E8;">etc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">configure: error: libnfnetlink headers missing</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian3 keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.7</span><span style="color:#E1E4E8;">]# yum install </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">y libnfnetlink</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">devel</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.7</span><span style="color:#E1E4E8;">]# make </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> make install</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian3 software]# mkdir keepalived</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# cd ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# ln </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# cp </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">2.0.7</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">init.d</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">init.d</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# chkconfig </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">add keepalived</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# chkconfig keepalived on</span></span>
<span class="line"><span style="color:#E1E4E8;">注意：正在将请求转发到“systemctl enable keepalived.service”。</span></span>
<span class="line"><span style="color:#E1E4E8;">Created symlink from </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">systemd</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">system</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">multi</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">user.target.wants</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.service to </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">usr</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">systemd</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">system</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.service.</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# service keepalived start</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# service keepalived status</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 software]# tar </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">zxvf keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.11.tar.gz</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 software]# mkdir keepalived</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 software]# cd keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.11</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.11</span><span style="color:#24292E;">]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">configure </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">=/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">sysconf</span><span style="color:#D73A49;">=/</span><span style="color:#24292E;">etc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">configure: error: </span></span>
<span class="line"><span style="color:#D73A49;">!!!</span><span style="color:#24292E;"> OpenSSL is not properly installed on your system. </span><span style="color:#D73A49;">!!!</span></span>
<span class="line"><span style="color:#D73A49;">!!!</span><span style="color:#24292E;"> Can not include OpenSSL headers files.            </span><span style="color:#D73A49;">!!!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.11</span><span style="color:#24292E;">]# yum install openssl</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">devel</span></span>
<span class="line"><span style="color:#24292E;">Is this ok [y</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">d</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">N]: y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">***</span><span style="color:#24292E;"> WARNING </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> this build will not support IPVS with IPv6. Please install libnl</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">libnl</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> dev libraries to support IPv6 with IPVS.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.11</span><span style="color:#24292E;">]# yum install libnl libnl</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">devel</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.11</span><span style="color:#24292E;">]# yum install gcc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.11</span><span style="color:#24292E;">]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">configure </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">=/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">sysconf</span><span style="color:#D73A49;">=/</span><span style="color:#24292E;">etc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">configure: error: libnfnetlink headers missing</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian3 keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.7</span><span style="color:#24292E;">]# yum install </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">y libnfnetlink</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">devel</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.7</span><span style="color:#24292E;">]# make </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> make install</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian3 software]# mkdir keepalived</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# cd ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# ln </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# cp </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">2.0.7</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">init.d</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">init.d</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# chkconfig </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">add keepalived</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# chkconfig keepalived on</span></span>
<span class="line"><span style="color:#24292E;">注意：正在将请求转发到“systemctl enable keepalived.service”。</span></span>
<span class="line"><span style="color:#24292E;">Created symlink from </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">systemd</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">system</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">multi</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">user.target.wants</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.service to </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">usr</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">systemd</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">system</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.service.</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# service keepalived start</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# service keepalived status</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p><img src="`+y+`" alt="JavaGuide_Nginx_扩展_OpenRestry_keepalived状态.png"></p><h3 id="请立马配置-keepalived-的日志" tabindex="-1">请立马配置 keepalived 的日志 <a class="header-anchor" href="#请立马配置-keepalived-的日志" aria-label="Permalink to &quot;请立马配置 keepalived 的日志&quot;">​</a></h3></blockquote><h3 id="keepalived-的配置" tabindex="-1">keepalived 的配置 <a class="header-anchor" href="#keepalived-的配置" aria-label="Permalink to &quot;keepalived 的配置&quot;">​</a></h3><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# vim </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.conf </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">!</span><span style="color:#E1E4E8;"> Configuration File </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># 配置一些全局的东西</span></span>
<span class="line"><span style="color:#E1E4E8;">global_defs {</span></span>
<span class="line"><span style="color:#E1E4E8;">   # 邮箱的配置, 当 keepalived 发生错误的时候,发送到你的邮箱里边</span></span>
<span class="line"><span style="color:#E1E4E8;">   notification_email {</span></span>
<span class="line"><span style="color:#E1E4E8;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">   smtp_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.1</span></span>
<span class="line"><span style="color:#E1E4E8;">   smtp_connect_timeout </span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">   router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_strict</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_garp_interval </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_gna_interval </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># 虚拟的路由的冗余协议</span></span>
<span class="line"><span style="color:#E1E4E8;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#E1E4E8;">    state MASTER</span></span>
<span class="line"><span style="color:#E1E4E8;">    interface eth0</span></span>
<span class="line"><span style="color:#E1E4E8;">    virtual_router_id </span><span style="color:#79B8FF;">51</span></span>
<span class="line"><span style="color:#E1E4E8;">    priority </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">    advert_int </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    authentication {</span></span>
<span class="line"><span style="color:#E1E4E8;">        auth_type PASS</span></span>
<span class="line"><span style="color:#E1E4E8;">        auth_pass </span><span style="color:#79B8FF;">1111</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 配置多个虚拟 IP 地址</span></span>
<span class="line"><span style="color:#E1E4E8;">    virtual_ipaddress {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.16</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.17</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.18</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># 虚拟的服务,就是我们的 LVS  了,就是我们对外的一个虚拟的 IP 地址的配置的映射,默认 </span><span style="color:#79B8FF;">443</span><span style="color:#E1E4E8;"> 是对 HTTPS 的一个映射,</span></span>
<span class="line"><span style="color:#E1E4E8;">virtual_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.100</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">443</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    delay_loop </span><span style="color:#79B8FF;">6</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_algo rr</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_kind NAT</span></span>
<span class="line"><span style="color:#E1E4E8;">    persistence_timeout </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#E1E4E8;">    protocol TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    # 这里是真实服务的一个配置</span></span>
<span class="line"><span style="color:#E1E4E8;">    real_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.201.100</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">443</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        weight </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">        SSL_GET {</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest ff20ad2481f97b1754ef3e12ecd3a9cc</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mrtg</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">9b3a0c85a887a256d6939da88aabd8cd</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            connect_timeout </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            delay_before_retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">virtual_server </span><span style="color:#FDAEB7;font-style:italic;">10.10.10.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1358</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    delay_loop </span><span style="color:#79B8FF;">6</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_algo rr</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_kind NAT</span></span>
<span class="line"><span style="color:#E1E4E8;">    persistence_timeout </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#E1E4E8;">    protocol TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    sorry_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.200</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1358</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    real_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1358</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        weight </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">        HTTP_GET {</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl2</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl3</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            connect_timeout </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            delay_before_retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    real_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.3</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1358</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        weight </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">        HTTP_GET {</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334c</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl2</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334c</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            connect_timeout </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            delay_before_retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">virtual_server </span><span style="color:#FDAEB7;font-style:italic;">10.10.10.3</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1358</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    delay_loop </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_algo rr</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_kind NAT</span></span>
<span class="line"><span style="color:#E1E4E8;">    persistence_timeout </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#E1E4E8;">    protocol TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    real_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.4</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1358</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        weight </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">        HTTP_GET {</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl2</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl3</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            connect_timeout </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            delay_before_retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    real_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.5</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1358</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        weight </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">        HTTP_GET {</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl2</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            url {</span></span>
<span class="line"><span style="color:#E1E4E8;">              path </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testurl3</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">test.jsp</span></span>
<span class="line"><span style="color:#E1E4E8;">              digest </span><span style="color:#FDAEB7;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            connect_timeout </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            delay_before_retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# vim </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.conf </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">!</span><span style="color:#24292E;"> Configuration File </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># 配置一些全局的东西</span></span>
<span class="line"><span style="color:#24292E;">global_defs {</span></span>
<span class="line"><span style="color:#24292E;">   # 邮箱的配置, 当 keepalived 发生错误的时候,发送到你的邮箱里边</span></span>
<span class="line"><span style="color:#24292E;">   notification_email {</span></span>
<span class="line"><span style="color:#24292E;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">   smtp_server </span><span style="color:#B31D28;font-style:italic;">192.168.200.1</span></span>
<span class="line"><span style="color:#24292E;">   smtp_connect_timeout </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">   router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_strict</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_garp_interval </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_gna_interval </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># 虚拟的路由的冗余协议</span></span>
<span class="line"><span style="color:#24292E;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#24292E;">    state MASTER</span></span>
<span class="line"><span style="color:#24292E;">    interface eth0</span></span>
<span class="line"><span style="color:#24292E;">    virtual_router_id </span><span style="color:#005CC5;">51</span></span>
<span class="line"><span style="color:#24292E;">    priority </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">    advert_int </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">    authentication {</span></span>
<span class="line"><span style="color:#24292E;">        auth_type PASS</span></span>
<span class="line"><span style="color:#24292E;">        auth_pass </span><span style="color:#005CC5;">1111</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    # 配置多个虚拟 IP 地址</span></span>
<span class="line"><span style="color:#24292E;">    virtual_ipaddress {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#B31D28;font-style:italic;">192.168.200.16</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#B31D28;font-style:italic;">192.168.200.17</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#B31D28;font-style:italic;">192.168.200.18</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># 虚拟的服务,就是我们的 LVS  了,就是我们对外的一个虚拟的 IP 地址的配置的映射,默认 </span><span style="color:#005CC5;">443</span><span style="color:#24292E;"> 是对 HTTPS 的一个映射,</span></span>
<span class="line"><span style="color:#24292E;">virtual_server </span><span style="color:#B31D28;font-style:italic;">192.168.200.100</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">443</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    delay_loop </span><span style="color:#005CC5;">6</span></span>
<span class="line"><span style="color:#24292E;">    lb_algo rr</span></span>
<span class="line"><span style="color:#24292E;">    lb_kind NAT</span></span>
<span class="line"><span style="color:#24292E;">    persistence_timeout </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#24292E;">    protocol TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    # 这里是真实服务的一个配置</span></span>
<span class="line"><span style="color:#24292E;">    real_server </span><span style="color:#B31D28;font-style:italic;">192.168.201.100</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">443</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        weight </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">        SSL_GET {</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">              digest ff20ad2481f97b1754ef3e12ecd3a9cc</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mrtg</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">9b3a0c85a887a256d6939da88aabd8cd</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            connect_timeout </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            delay_before_retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">virtual_server </span><span style="color:#B31D28;font-style:italic;">10.10.10.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1358</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    delay_loop </span><span style="color:#005CC5;">6</span></span>
<span class="line"><span style="color:#24292E;">    lb_algo rr</span></span>
<span class="line"><span style="color:#24292E;">    lb_kind NAT</span></span>
<span class="line"><span style="color:#24292E;">    persistence_timeout </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#24292E;">    protocol TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    sorry_server </span><span style="color:#B31D28;font-style:italic;">192.168.200.200</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1358</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    real_server </span><span style="color:#B31D28;font-style:italic;">192.168.200.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1358</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        weight </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">        HTTP_GET {</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl2</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl3</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            connect_timeout </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            delay_before_retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    real_server </span><span style="color:#B31D28;font-style:italic;">192.168.200.3</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1358</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        weight </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">        HTTP_GET {</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334c</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl2</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334c</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            connect_timeout </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            delay_before_retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">virtual_server </span><span style="color:#B31D28;font-style:italic;">10.10.10.3</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1358</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    delay_loop </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">    lb_algo rr</span></span>
<span class="line"><span style="color:#24292E;">    lb_kind NAT</span></span>
<span class="line"><span style="color:#24292E;">    persistence_timeout </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#24292E;">    protocol TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    real_server </span><span style="color:#B31D28;font-style:italic;">192.168.200.4</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1358</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        weight </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">        HTTP_GET {</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl2</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl3</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            connect_timeout </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            delay_before_retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    real_server </span><span style="color:#B31D28;font-style:italic;">192.168.200.5</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1358</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        weight </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">        HTTP_GET {</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl2</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            url {</span></span>
<span class="line"><span style="color:#24292E;">              path </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testurl3</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">test.jsp</span></span>
<span class="line"><span style="color:#24292E;">              digest </span><span style="color:#B31D28;font-style:italic;">640205b7b0fc66c1ea91c463fac6334d</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            connect_timeout </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            delay_before_retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br></div></div><p>​ 我们需要在 Keepalived 里边配置 Nginx 的一些东西。通过 Keepalived 实现了对 Nginx 的高可用，keepalived 是对 LVS 的一个检测。这个 <strong>虚拟 IP</strong> 会根据你的配置去进行映射。</p><p><img src="`+b+`" alt="JavaGuide_Nginx_扩展_OpenRestry_keepalived_LVS.png"></p><h4 id="master" tabindex="-1">master <a class="header-anchor" href="#master" aria-label="Permalink to &quot;master&quot;">​</a></h4><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# vim </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.conf </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">!</span><span style="color:#E1E4E8;"> Configuration File </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> keepalived </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">global_defs {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 运行 keepalived 服务器的标识，在一个网络内应该是唯一的</span></span>
<span class="line"><span style="color:#E1E4E8;">    router_id LVS_DEVEL   </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># vrrp 实例定义部分</span></span>
<span class="line"><span style="color:#E1E4E8;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设置 lvs 的状态，MASTER 和 BACKUP 两种，必须大写</span></span>
<span class="line"><span style="color:#E1E4E8;">    state MASTER  </span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设置对外服务的接口，网卡的地址</span></span>
<span class="line"><span style="color:#E1E4E8;">    interface ens33   </span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设置虚拟路由标示，这个标示是一个数字，同一个 vr rp 实例使用唯一标示</span></span>
<span class="line"><span style="color:#E1E4E8;">    virtual_router_id </span><span style="color:#79B8FF;">51</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    # 定义优先级，数字越大优先级越高，在一个 vrrp——instance 下，master 的优先级必须大于 backup</span></span>
<span class="line"><span style="color:#E1E4E8;">    priority </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设定 master 与 backup 负载均衡器之间同步检查的时间间隔，单位是秒</span></span>
<span class="line"><span style="color:#E1E4E8;">    advert_int </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    authentication {  </span></span>
<span class="line"><span style="color:#E1E4E8;">        # 设置验证类型和密码</span></span>
<span class="line"><span style="color:#E1E4E8;">        auth_type PASS</span></span>
<span class="line"><span style="color:#E1E4E8;">        # 验证密码，同一个 vrrp_instance 下 MASTER 和 BACKUP 密码必须相同</span></span>
<span class="line"><span style="color:#E1E4E8;">        auth_pass </span><span style="color:#79B8FF;">1111</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    virtual_ipaddress { </span></span>
<span class="line"><span style="color:#E1E4E8;">        #设置虚拟 ip 地址，可以设置多个，每行一个</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.100</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># 设置虚拟服务器，需要指定虚拟 ip 和服务端口</span></span>
<span class="line"><span style="color:#E1E4E8;">virtual_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.100</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 健康检查时间间隔</span></span>
<span class="line"><span style="color:#E1E4E8;">    delay_loop </span><span style="color:#79B8FF;">6</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 负载均衡调度算法</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_algo rr</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 负载均衡转发规则</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_kind NAT   </span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设置会话保持时间protocol TCP #指定转发协议类型，有 TCP 和 UDP 两种</span></span>
<span class="line"><span style="color:#E1E4E8;">    persistence_timeout </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 配置服务器节点 </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">，需要指定 real server 的真实 IP 地址和端口</span></span>
<span class="line"><span style="color:#E1E4E8;">    real_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.128</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">        # 设置权重，数字越大权重越高</span></span>
<span class="line"><span style="color:#E1E4E8;">        weight </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">        # realserver 的状态监测设置部分单位秒，用来去检测它的状态</span></span>
<span class="line"><span style="color:#E1E4E8;">        TCP_CHECK {  </span></span>
<span class="line"><span style="color:#E1E4E8;">            # 超时时间</span></span>
<span class="line"><span style="color:#E1E4E8;">            connect_timeout </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">            # 重试间隔</span></span>
<span class="line"><span style="color:#E1E4E8;">            delay_before_retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            # 监测端口</span></span>
<span class="line"><span style="color:#E1E4E8;">            connect_port </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# vim </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.conf </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">!</span><span style="color:#24292E;"> Configuration File </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> keepalived </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">global_defs {</span></span>
<span class="line"><span style="color:#24292E;">    # 运行 keepalived 服务器的标识，在一个网络内应该是唯一的</span></span>
<span class="line"><span style="color:#24292E;">    router_id LVS_DEVEL   </span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># vrrp 实例定义部分</span></span>
<span class="line"><span style="color:#24292E;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#24292E;">    # 设置 lvs 的状态，MASTER 和 BACKUP 两种，必须大写</span></span>
<span class="line"><span style="color:#24292E;">    state MASTER  </span></span>
<span class="line"><span style="color:#24292E;">    # 设置对外服务的接口，网卡的地址</span></span>
<span class="line"><span style="color:#24292E;">    interface ens33   </span></span>
<span class="line"><span style="color:#24292E;">    # 设置虚拟路由标示，这个标示是一个数字，同一个 vr rp 实例使用唯一标示</span></span>
<span class="line"><span style="color:#24292E;">    virtual_router_id </span><span style="color:#005CC5;">51</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    # 定义优先级，数字越大优先级越高，在一个 vrrp——instance 下，master 的优先级必须大于 backup</span></span>
<span class="line"><span style="color:#24292E;">    priority </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    # 设定 master 与 backup 负载均衡器之间同步检查的时间间隔，单位是秒</span></span>
<span class="line"><span style="color:#24292E;">    advert_int </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    authentication {  </span></span>
<span class="line"><span style="color:#24292E;">        # 设置验证类型和密码</span></span>
<span class="line"><span style="color:#24292E;">        auth_type PASS</span></span>
<span class="line"><span style="color:#24292E;">        # 验证密码，同一个 vrrp_instance 下 MASTER 和 BACKUP 密码必须相同</span></span>
<span class="line"><span style="color:#24292E;">        auth_pass </span><span style="color:#005CC5;">1111</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    virtual_ipaddress { </span></span>
<span class="line"><span style="color:#24292E;">        #设置虚拟 ip 地址，可以设置多个，每行一个</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#B31D28;font-style:italic;">192.168.40.100</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># 设置虚拟服务器，需要指定虚拟 ip 和服务端口</span></span>
<span class="line"><span style="color:#24292E;">virtual_server </span><span style="color:#B31D28;font-style:italic;">192.168.40.100</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    # 健康检查时间间隔</span></span>
<span class="line"><span style="color:#24292E;">    delay_loop </span><span style="color:#005CC5;">6</span></span>
<span class="line"><span style="color:#24292E;">    # 负载均衡调度算法</span></span>
<span class="line"><span style="color:#24292E;">    lb_algo rr</span></span>
<span class="line"><span style="color:#24292E;">    # 负载均衡转发规则</span></span>
<span class="line"><span style="color:#24292E;">    lb_kind NAT   </span></span>
<span class="line"><span style="color:#24292E;">    # 设置会话保持时间protocol TCP #指定转发协议类型，有 TCP 和 UDP 两种</span></span>
<span class="line"><span style="color:#24292E;">    persistence_timeout </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#24292E;">    # 配置服务器节点 </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">，需要指定 real server 的真实 IP 地址和端口</span></span>
<span class="line"><span style="color:#24292E;">    real_server </span><span style="color:#B31D28;font-style:italic;">192.168.40.128</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">        # 设置权重，数字越大权重越高</span></span>
<span class="line"><span style="color:#24292E;">        weight </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">        # realserver 的状态监测设置部分单位秒，用来去检测它的状态</span></span>
<span class="line"><span style="color:#24292E;">        TCP_CHECK {  </span></span>
<span class="line"><span style="color:#24292E;">            # 超时时间</span></span>
<span class="line"><span style="color:#24292E;">            connect_timeout </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">            # 重试间隔</span></span>
<span class="line"><span style="color:#24292E;">            delay_before_retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            # 监测端口</span></span>
<span class="line"><span style="color:#24292E;">            connect_port </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h4 id="backup" tabindex="-1">backup <a class="header-anchor" href="#backup" aria-label="Permalink to &quot;backup&quot;">​</a></h4><p><code>vim /etc/keepalived/keepalived.conf</code></p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">!</span><span style="color:#E1E4E8;"> Configuration File </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">global_defs { </span></span>
<span class="line"><span style="color:#E1E4E8;">   router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">vrrp_instance VI_1 { </span></span>
<span class="line"><span style="color:#E1E4E8;">   state BACKUP </span></span>
<span class="line"><span style="color:#E1E4E8;">   interface ens33</span></span>
<span class="line"><span style="color:#E1E4E8;">   virtual_router_id </span><span style="color:#79B8FF;">51</span></span>
<span class="line"><span style="color:#E1E4E8;">   priority </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#E1E4E8;">   advert_int </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   authentication {</span></span>
<span class="line"><span style="color:#E1E4E8;">       auth_type PASS</span></span>
<span class="line"><span style="color:#E1E4E8;">       auth_pass </span><span style="color:#79B8FF;">1111</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">   virtual_ipaddress { </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.100</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">virtual_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.100</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   delay_loop </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   lb_algo rr</span></span>
<span class="line"><span style="color:#E1E4E8;">   lb_kind NAT</span></span>
<span class="line"><span style="color:#E1E4E8;">   persistence_timeout </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   protocol TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   real_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.129</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">       weight </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       TCP_CHECK {</span></span>
<span class="line"><span style="color:#E1E4E8;">           connect_timeout </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">           delay_before_retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">           connect_port </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">!</span><span style="color:#24292E;"> Configuration File </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">global_defs { </span></span>
<span class="line"><span style="color:#24292E;">   router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">vrrp_instance VI_1 { </span></span>
<span class="line"><span style="color:#24292E;">   state BACKUP </span></span>
<span class="line"><span style="color:#24292E;">   interface ens33</span></span>
<span class="line"><span style="color:#24292E;">   virtual_router_id </span><span style="color:#005CC5;">51</span></span>
<span class="line"><span style="color:#24292E;">   priority </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#24292E;">   advert_int </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   authentication {</span></span>
<span class="line"><span style="color:#24292E;">       auth_type PASS</span></span>
<span class="line"><span style="color:#24292E;">       auth_pass </span><span style="color:#005CC5;">1111</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">   virtual_ipaddress { </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#B31D28;font-style:italic;">192.168.40.100</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">virtual_server </span><span style="color:#B31D28;font-style:italic;">192.168.40.100</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   delay_loop </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   lb_algo rr</span></span>
<span class="line"><span style="color:#24292E;">   lb_kind NAT</span></span>
<span class="line"><span style="color:#24292E;">   persistence_timeout </span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   protocol TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   real_server </span><span style="color:#B31D28;font-style:italic;">192.168.40.129</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">       weight </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       TCP_CHECK {</span></span>
<span class="line"><span style="color:#24292E;">           connect_timeout </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">           delay_before_retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">           connect_port </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# service keepalived restart</span></span>
<span class="line"><span style="color:#E1E4E8;">Restarting </span><span style="color:#B392F0;">keepalived</span><span style="color:#E1E4E8;"> (via </span><span style="color:#FFAB70;">systemctl</span><span style="color:#E1E4E8;">):                     [  确定  ]</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# service keepalived status</span></span>
<span class="line"><span style="color:#E1E4E8;">● keepalived.service </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> LVS and VRRP High Availability Monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">   Loaded: </span><span style="color:#B392F0;">loaded</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">usr</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">systemd</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">system</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.service; enabled; vendor preset: disabled)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Active: </span><span style="color:#B392F0;">active</span><span style="color:#E1E4E8;"> (running) since 日 </span><span style="color:#79B8FF;">2019</span><span style="color:#F97583;">-0</span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;"> CST; </span><span style="color:#FDAEB7;font-style:italic;">20s</span><span style="color:#E1E4E8;"> ago</span></span>
<span class="line"><span style="color:#E1E4E8;">  Process: </span><span style="color:#79B8FF;">83210</span><span style="color:#E1E4E8;"> ExecStart</span><span style="color:#F97583;">=/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived $</span><span style="color:#B392F0;">KEEPALIVED_OPTIONS</span><span style="color:#E1E4E8;"> (code</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">exited, status</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">SUCCESS)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Main PID: </span><span style="color:#79B8FF;">83211</span><span style="color:#E1E4E8;"> (keepalived)</span></span>
<span class="line"><span style="color:#E1E4E8;">   CGroup: </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">system.slice</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.service</span></span>
<span class="line"><span style="color:#E1E4E8;">           ├─</span><span style="color:#79B8FF;">83211</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">D</span></span>
<span class="line"><span style="color:#E1E4E8;">           ├─</span><span style="color:#79B8FF;">83212</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">D</span></span>
<span class="line"><span style="color:#E1E4E8;">           └─</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">D</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;">]: Sending gratuitous ARP on ens33 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;">]: Sending gratuitous ARP on ens33 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;">]: Sending gratuitous ARP on ens33 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">28</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_healthcheckers</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83212</span><span style="color:#E1E4E8;">]: TCP connection to [</span><span style="color:#FDAEB7;font-style:italic;">192.168.40.128</span><span style="color:#E1E4E8;">]:udp:</span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> success.</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;">]: Sending gratuitous ARP on ens33 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;">]: (VI_1) Sending</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">queueing gratuitous ARPs on ens33 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;">]: Sending gratuitous ARP on ens33 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;">]: Sending gratuitous ARP on ens33 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;">]: Sending gratuitous ARP on ens33 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> Darian1 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">83213</span><span style="color:#E1E4E8;">]: Sending gratuitous ARP on ens33 </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian3 software]# service keepalived restart</span></span>
<span class="line"><span style="color:#E1E4E8;">Restarting </span><span style="color:#B392F0;">keepalived</span><span style="color:#E1E4E8;"> (via </span><span style="color:#FFAB70;">systemctl</span><span style="color:#E1E4E8;">):                     [  确定  ]</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian3 software]#  service keepalived status</span></span>
<span class="line"><span style="color:#E1E4E8;">● keepalived.service </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> LVS and VRRP High Availability Monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">   Loaded: </span><span style="color:#B392F0;">loaded</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">usr</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">systemd</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">system</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.service; enabled; vendor preset: disabled)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Active: </span><span style="color:#B392F0;">active</span><span style="color:#E1E4E8;"> (running) since 日 </span><span style="color:#79B8FF;">2019</span><span style="color:#F97583;">-0</span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> CST; </span><span style="color:#FDAEB7;font-style:italic;">15s</span><span style="color:#E1E4E8;"> ago</span></span>
<span class="line"><span style="color:#E1E4E8;">  Process: </span><span style="color:#79B8FF;">47254</span><span style="color:#E1E4E8;"> ExecStart</span><span style="color:#F97583;">=/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived $</span><span style="color:#B392F0;">KEEPALIVED_OPTIONS</span><span style="color:#E1E4E8;"> (code</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">exited, status</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">SUCCESS)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Main PID: </span><span style="color:#79B8FF;">47255</span><span style="color:#E1E4E8;"> (keepalived)</span></span>
<span class="line"><span style="color:#E1E4E8;">   CGroup: </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">system.slice</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.service</span></span>
<span class="line"><span style="color:#E1E4E8;">           ├─</span><span style="color:#79B8FF;">47255</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">D</span></span>
<span class="line"><span style="color:#E1E4E8;">           ├─</span><span style="color:#79B8FF;">47256</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">D</span></span>
<span class="line"><span style="color:#E1E4E8;">           └─</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">D</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;">]: (Line </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) Unexpected </span><span style="color:#9ECBFF;">&#39;{&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> ignoring</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;">]: (Line </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">) Unknown keyword </span><span style="color:#9ECBFF;">&#39;router_id&#39;</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;">]: (Line </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">) Unknown keyword </span><span style="color:#9ECBFF;">&#39;}&#39;</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;">]: Assigned address </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.129</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> interface ens33</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;">]: Assigned address fe80::d3a1:</span><span style="color:#FDAEB7;font-style:italic;">60b3</span><span style="color:#E1E4E8;">:dbb3:</span><span style="color:#FDAEB7;font-style:italic;">68c2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> interface ens33</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;">]: Registering gratuitous ARP shared channel</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;">]: (VI_1) removing VIPs.</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;">]: (VI_1) Entering BACKUP </span><span style="color:#B392F0;">STATE</span><span style="color:#E1E4E8;"> (init)</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_vrrp</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47257</span><span style="color:#E1E4E8;">]: VRRP sockpool: [</span><span style="color:#B392F0;">ifindex</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">), </span><span style="color:#B392F0;">proto</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">112</span><span style="color:#E1E4E8;">), </span><span style="color:#B392F0;">unicast</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">), </span><span style="color:#B392F0;">fd</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">月 </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">37</span><span style="color:#E1E4E8;"> Darian3 </span><span style="color:#FFAB70;">Keepalived_healthcheckers</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">47256</span><span style="color:#E1E4E8;">]: TCP connection to [</span><span style="color:#FDAEB7;font-style:italic;">192.168.40.129</span><span style="color:#E1E4E8;">]:tcp:</span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> success.</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian3 software]#</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 software]# service keepalived restart</span></span>
<span class="line"><span style="color:#24292E;">Restarting </span><span style="color:#6F42C1;">keepalived</span><span style="color:#24292E;"> (via </span><span style="color:#E36209;">systemctl</span><span style="color:#24292E;">):                     [  确定  ]</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 software]# service keepalived status</span></span>
<span class="line"><span style="color:#24292E;">● keepalived.service </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> LVS and VRRP High Availability Monitor</span></span>
<span class="line"><span style="color:#24292E;">   Loaded: </span><span style="color:#6F42C1;">loaded</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">usr</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">systemd</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">system</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.service; enabled; vendor preset: disabled)</span></span>
<span class="line"><span style="color:#24292E;">   Active: </span><span style="color:#6F42C1;">active</span><span style="color:#24292E;"> (running) since 日 </span><span style="color:#005CC5;">2019</span><span style="color:#D73A49;">-0</span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">22</span><span style="color:#24292E;"> CST; </span><span style="color:#B31D28;font-style:italic;">20s</span><span style="color:#24292E;"> ago</span></span>
<span class="line"><span style="color:#24292E;">  Process: </span><span style="color:#005CC5;">83210</span><span style="color:#24292E;"> ExecStart</span><span style="color:#D73A49;">=/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived $</span><span style="color:#6F42C1;">KEEPALIVED_OPTIONS</span><span style="color:#24292E;"> (code</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">exited, status</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">SUCCESS)</span></span>
<span class="line"><span style="color:#24292E;"> Main PID: </span><span style="color:#005CC5;">83211</span><span style="color:#24292E;"> (keepalived)</span></span>
<span class="line"><span style="color:#24292E;">   CGroup: </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">system.slice</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.service</span></span>
<span class="line"><span style="color:#24292E;">           ├─</span><span style="color:#005CC5;">83211</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">D</span></span>
<span class="line"><span style="color:#24292E;">           ├─</span><span style="color:#005CC5;">83212</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">D</span></span>
<span class="line"><span style="color:#24292E;">           └─</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">D</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;">]: Sending gratuitous ARP on ens33 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;">]: Sending gratuitous ARP on ens33 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;">]: Sending gratuitous ARP on ens33 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">28</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_healthcheckers</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83212</span><span style="color:#24292E;">]: TCP connection to [</span><span style="color:#B31D28;font-style:italic;">192.168.40.128</span><span style="color:#24292E;">]:udp:</span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> success.</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;">]: Sending gratuitous ARP on ens33 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;">]: (VI_1) Sending</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">queueing gratuitous ARPs on ens33 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;">]: Sending gratuitous ARP on ens33 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;">]: Sending gratuitous ARP on ens33 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;">]: Sending gratuitous ARP on ens33 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> Darian1 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">83213</span><span style="color:#24292E;">]: Sending gratuitous ARP on ens33 </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#B31D28;font-style:italic;">192.168.11.100</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 software]# </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian3 software]# service keepalived restart</span></span>
<span class="line"><span style="color:#24292E;">Restarting </span><span style="color:#6F42C1;">keepalived</span><span style="color:#24292E;"> (via </span><span style="color:#E36209;">systemctl</span><span style="color:#24292E;">):                     [  确定  ]</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian3 software]#  service keepalived status</span></span>
<span class="line"><span style="color:#24292E;">● keepalived.service </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> LVS and VRRP High Availability Monitor</span></span>
<span class="line"><span style="color:#24292E;">   Loaded: </span><span style="color:#6F42C1;">loaded</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">usr</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">systemd</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">system</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.service; enabled; vendor preset: disabled)</span></span>
<span class="line"><span style="color:#24292E;">   Active: </span><span style="color:#6F42C1;">active</span><span style="color:#24292E;"> (running) since 日 </span><span style="color:#005CC5;">2019</span><span style="color:#D73A49;">-0</span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> CST; </span><span style="color:#B31D28;font-style:italic;">15s</span><span style="color:#24292E;"> ago</span></span>
<span class="line"><span style="color:#24292E;">  Process: </span><span style="color:#005CC5;">47254</span><span style="color:#24292E;"> ExecStart</span><span style="color:#D73A49;">=/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived $</span><span style="color:#6F42C1;">KEEPALIVED_OPTIONS</span><span style="color:#24292E;"> (code</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">exited, status</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">SUCCESS)</span></span>
<span class="line"><span style="color:#24292E;"> Main PID: </span><span style="color:#005CC5;">47255</span><span style="color:#24292E;"> (keepalived)</span></span>
<span class="line"><span style="color:#24292E;">   CGroup: </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">system.slice</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.service</span></span>
<span class="line"><span style="color:#24292E;">           ├─</span><span style="color:#005CC5;">47255</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">D</span></span>
<span class="line"><span style="color:#24292E;">           ├─</span><span style="color:#005CC5;">47256</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">D</span></span>
<span class="line"><span style="color:#24292E;">           └─</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">D</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;">]: (Line </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">) Unexpected </span><span style="color:#032F62;">&#39;{&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> ignoring</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;">]: (Line </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">) Unknown keyword </span><span style="color:#032F62;">&#39;router_id&#39;</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;">]: (Line </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">) Unknown keyword </span><span style="color:#032F62;">&#39;}&#39;</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;">]: Assigned address </span><span style="color:#B31D28;font-style:italic;">192.168.40.129</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> interface ens33</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;">]: Assigned address fe80::d3a1:</span><span style="color:#B31D28;font-style:italic;">60b3</span><span style="color:#24292E;">:dbb3:</span><span style="color:#B31D28;font-style:italic;">68c2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> interface ens33</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;">]: Registering gratuitous ARP shared channel</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;">]: (VI_1) removing VIPs.</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;">]: (VI_1) Entering BACKUP </span><span style="color:#6F42C1;">STATE</span><span style="color:#24292E;"> (init)</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">31</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_vrrp</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47257</span><span style="color:#24292E;">]: VRRP sockpool: [</span><span style="color:#6F42C1;">ifindex</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">), </span><span style="color:#6F42C1;">proto</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">112</span><span style="color:#24292E;">), </span><span style="color:#6F42C1;">unicast</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">), </span><span style="color:#6F42C1;">fd</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">9</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;">月 </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">37</span><span style="color:#24292E;"> Darian3 </span><span style="color:#E36209;">Keepalived_healthcheckers</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">47256</span><span style="color:#24292E;">]: TCP connection to [</span><span style="color:#B31D28;font-style:italic;">192.168.40.129</span><span style="color:#24292E;">]:tcp:</span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> success.</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian3 software]#</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>Nginx 是每秒都可以抗十万的。</p><h4 id="踩坑" tabindex="-1">踩坑： <a class="header-anchor" href="#踩坑" aria-label="Permalink to &quot;踩坑：&quot;">​</a></h4><blockquote><p>配置同一个网段，不是同一个网段，访问会有问题！！！</p><p>线程在进程之内是共享的。共享资源相互影响。</p><p>线程产生的成本比进程低。</p></blockquote><h3 id="keepalived-日志文件配置" tabindex="-1">keepalived 日志文件配置 <a class="header-anchor" href="#keepalived-日志文件配置" aria-label="Permalink to &quot;keepalived 日志文件配置&quot;">​</a></h3><ol><li><p>首先看一下<code>/etc/sysconfig/keepalived</code> 文件</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">vim </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sysconfig</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">KEEPALIVED_OPTIONS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;-D -d -S 0&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">vim </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sysconfig</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">KEEPALIVED_OPTIONS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;-D -d -S 0&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>-D</code> 就是输出日志的选项</p><p>这里的“-S 0”表示 local0.* 具体地还需要看一下/etc/syslog.conf 文件</p></li><li><p>在 <code>/etc/rsyslog.conf</code> 里添加: <code>local0.* /var/log/keepalived.log</code></p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian3 keepalived]# vim </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">rsyslog.conf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian3 keepalived]# vim </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">rsyslog.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>重新启动 keepalived 和 rsyslog 服务：</p><p><code>service rsyslog restart</code></p><p><code>service keepalived restart</code></p><blockquote><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# vim </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sysconfig</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived </span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# vim </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">rsyslog.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># keepalived 的log</span></span>
<span class="line"><span style="color:#E1E4E8;">local0.</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">log</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# service rsyslog restart </span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# service keepalived restart</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# vim </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sysconfig</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived </span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# vim </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">rsyslog.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># keepalived 的log</span></span>
<span class="line"><span style="color:#24292E;">local0.</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">log</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# service rsyslog restart </span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# service keepalived restart</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></blockquote></li><li><p>查看日志：</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">tail </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">log</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.log</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">tail </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">log</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.log</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol><h3 id="通过脚本实现动态切换" tabindex="-1">通过脚本实现动态切换 <a class="header-anchor" href="#通过脚本实现动态切换" aria-label="Permalink to &quot;通过脚本实现动态切换&quot;">​</a></h3><blockquote><p>​ <strong>Keepalived</strong> 需要配置主备来实现动态的切换。Nginx 挂掉的时候，keepalived 也要停止掉。keepalived 的存在的意义是用来监听 Nginx 的请求。这个监听的过程实际上是通过 <strong>LVS</strong> 来转发的。需要脚本来触发。</p></blockquote><ol><li><p>在 master 和 <strong>slave</strong> 节点的 <code>/data/program/nginx/sbin/nginx-ha-check.sh</code> 目录下增加一个脚本</p><p>–no-headers 不打印头文件</p><p>Wc –l</p><p>统计行数</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 keepalived]# cd ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# vim nginx_status_check.sh</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 keepalived]# cd ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# vim nginx_status_check.sh</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">bin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sh   #</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sh 是指此脚本使用</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sh 来执行</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">A</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">\`ps </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">C nginx </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">no</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">header </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">wc </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [ $A </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">eq </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"><span style="color:#E1E4E8;">    then</span></span>
<span class="line"><span style="color:#E1E4E8;">        echo </span><span style="color:#9ECBFF;">&#39;nginx server is died&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        service keepalived stop</span></span>
<span class="line"><span style="color:#E1E4E8;">fi</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">bin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sh   #</span><span style="color:#D73A49;">!</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sh 是指此脚本使用</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sh 来执行</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">A</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">\`ps </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">C nginx </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">no</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">header </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">wc </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [ $A </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">eq </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;">    then</span></span>
<span class="line"><span style="color:#24292E;">        echo </span><span style="color:#032F62;">&#39;nginx server is died&#39;</span></span>
<span class="line"><span style="color:#24292E;">        service keepalived stop</span></span>
<span class="line"><span style="color:#24292E;">fi</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li><li><p>修改 keepalived.conf 文件，增加如下配置</p><p>track_script: #执行监控的服务。chknginxservice #</p><p>引用 VRRP 脚本，即在 <code>vrrp_script</code> 部分指定的名字。定期运行它们来改变优先级， 并最终引发主备切换。当我们 Nginx 挂掉以后，会触发这个脚本。</p></li></ol><blockquote><h3 id="操作步骤" tabindex="-1">操作步骤： <a class="header-anchor" href="#操作步骤" aria-label="Permalink to &quot;操作步骤：&quot;">​</a></h3><ol><li>编写 <code>keepalived.conf</code> 脚本</li></ol><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# vim </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">keepalived.conf </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">global_defs {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 运行 keepalived 服务器的标识，在一个网络内应该是唯一的</span></span>
<span class="line"><span style="color:#E1E4E8;">    router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#E1E4E8;">    enable_script_security</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">vrrp_script nginx_status_process {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 实现当 Nginx 挂掉以后，keepalived 也挂掉</span></span>
<span class="line"><span style="color:#E1E4E8;">    script </span><span style="color:#9ECBFF;">&quot;/software/nginx/sbin/nginx_status_check.sh&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 用户的隔离，用户的运行权限，防止其他用户对这个脚本的执行</span></span>
<span class="line"><span style="color:#E1E4E8;">    user root</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 检查频次</span></span>
<span class="line"><span style="color:#E1E4E8;">    interval </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># vrrp 实例定义部分</span></span>
<span class="line"><span style="color:#E1E4E8;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设置 lvs 的状态，MASTER 和 BACKUP 两种，必须大写</span></span>
<span class="line"><span style="color:#E1E4E8;">    state MASTER</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设置对外服务的接口，网卡的地址</span></span>
<span class="line"><span style="color:#E1E4E8;">    interface ens33</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设置虚拟路由标示，这个标示是一个数字，同一个 vr rp 实例使用唯一标示</span></span>
<span class="line"><span style="color:#E1E4E8;">    virtual_router_id </span><span style="color:#79B8FF;">51</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 定义优先级，数字越大优先级越高，在一个 vrrp——instance 下，master 的优先级必须大于 backup</span></span>
<span class="line"><span style="color:#E1E4E8;">    priority </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设定 master 与 backup 负载均衡器之间同步检查的时间间隔，单位是秒</span></span>
<span class="line"><span style="color:#E1E4E8;">    advert_int </span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    authentication {</span></span>
<span class="line"><span style="color:#E1E4E8;">        # 设置验证类型和密码</span></span>
<span class="line"><span style="color:#E1E4E8;">        auth_type PASS</span></span>
<span class="line"><span style="color:#E1E4E8;">        # 验证密码，同一个 vrrp_instance 下 MASTER 和 BACKUP 密码必须相同</span></span>
<span class="line"><span style="color:#E1E4E8;">        auth_pass </span><span style="color:#79B8FF;">1111</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    virtual_ipaddress {</span></span>
<span class="line"><span style="color:#E1E4E8;">        #设置虚拟 ip 地址，可以设置多个，每行一个</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.100</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    track_script{</span></span>
<span class="line"><span style="color:#E1E4E8;">        # 对应的 上边的 nginx_status_process</span></span>
<span class="line"><span style="color:#E1E4E8;">        nginx_status_process</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># 设置虚拟服务器，需要指定虚拟 ip 和服务端口</span></span>
<span class="line"><span style="color:#E1E4E8;">virtual_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.100</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 健康检查时间间隔</span></span>
<span class="line"><span style="color:#E1E4E8;">    delay_loop </span><span style="color:#79B8FF;">6</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 负载均衡调度算法</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_algo rr</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 负载均衡转发规则</span></span>
<span class="line"><span style="color:#E1E4E8;">    lb_kind NAT</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 设置会话保持时间protocol TCP #指定转发协议类型，有 TCP 和 UDP 两种</span></span>
<span class="line"><span style="color:#E1E4E8;">    persistence_timeout </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 配置服务器节点 </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">，需要指定 real server 的真实 IP 地址和端口</span></span>
<span class="line"><span style="color:#E1E4E8;">    real_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.128</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        # 设置权重，数字越大权重越高</span></span>
<span class="line"><span style="color:#E1E4E8;">        weight </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">        # realserver 的状态监测设置部分单位秒，用来检测它的状态</span></span>
<span class="line"><span style="color:#E1E4E8;">        TCP_CHECK {</span></span>
<span class="line"><span style="color:#E1E4E8;">            # 超时时间</span></span>
<span class="line"><span style="color:#E1E4E8;">            connect_timeout </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            # 重试间隔</span></span>
<span class="line"><span style="color:#E1E4E8;">            delay_before_retry </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">            # 监测端口</span></span>
<span class="line"><span style="color:#E1E4E8;">            connect_port </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# vim </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">keepalived.conf </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">global_defs {</span></span>
<span class="line"><span style="color:#24292E;">    # 运行 keepalived 服务器的标识，在一个网络内应该是唯一的</span></span>
<span class="line"><span style="color:#24292E;">    router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#24292E;">    enable_script_security</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">vrrp_script nginx_status_process {</span></span>
<span class="line"><span style="color:#24292E;">    # 实现当 Nginx 挂掉以后，keepalived 也挂掉</span></span>
<span class="line"><span style="color:#24292E;">    script </span><span style="color:#032F62;">&quot;/software/nginx/sbin/nginx_status_check.sh&quot;</span></span>
<span class="line"><span style="color:#24292E;">    # 用户的隔离，用户的运行权限，防止其他用户对这个脚本的执行</span></span>
<span class="line"><span style="color:#24292E;">    user root</span></span>
<span class="line"><span style="color:#24292E;">    # 检查频次</span></span>
<span class="line"><span style="color:#24292E;">    interval </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># vrrp 实例定义部分</span></span>
<span class="line"><span style="color:#24292E;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#24292E;">    # 设置 lvs 的状态，MASTER 和 BACKUP 两种，必须大写</span></span>
<span class="line"><span style="color:#24292E;">    state MASTER</span></span>
<span class="line"><span style="color:#24292E;">    # 设置对外服务的接口，网卡的地址</span></span>
<span class="line"><span style="color:#24292E;">    interface ens33</span></span>
<span class="line"><span style="color:#24292E;">    # 设置虚拟路由标示，这个标示是一个数字，同一个 vr rp 实例使用唯一标示</span></span>
<span class="line"><span style="color:#24292E;">    virtual_router_id </span><span style="color:#005CC5;">51</span></span>
<span class="line"><span style="color:#24292E;">    # 定义优先级，数字越大优先级越高，在一个 vrrp——instance 下，master 的优先级必须大于 backup</span></span>
<span class="line"><span style="color:#24292E;">    priority </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">    # 设定 master 与 backup 负载均衡器之间同步检查的时间间隔，单位是秒</span></span>
<span class="line"><span style="color:#24292E;">    advert_int </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    authentication {</span></span>
<span class="line"><span style="color:#24292E;">        # 设置验证类型和密码</span></span>
<span class="line"><span style="color:#24292E;">        auth_type PASS</span></span>
<span class="line"><span style="color:#24292E;">        # 验证密码，同一个 vrrp_instance 下 MASTER 和 BACKUP 密码必须相同</span></span>
<span class="line"><span style="color:#24292E;">        auth_pass </span><span style="color:#005CC5;">1111</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    virtual_ipaddress {</span></span>
<span class="line"><span style="color:#24292E;">        #设置虚拟 ip 地址，可以设置多个，每行一个</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#B31D28;font-style:italic;">192.168.40.100</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    track_script{</span></span>
<span class="line"><span style="color:#24292E;">        # 对应的 上边的 nginx_status_process</span></span>
<span class="line"><span style="color:#24292E;">        nginx_status_process</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># 设置虚拟服务器，需要指定虚拟 ip 和服务端口</span></span>
<span class="line"><span style="color:#24292E;">virtual_server </span><span style="color:#B31D28;font-style:italic;">192.168.40.100</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    # 健康检查时间间隔</span></span>
<span class="line"><span style="color:#24292E;">    delay_loop </span><span style="color:#005CC5;">6</span></span>
<span class="line"><span style="color:#24292E;">    # 负载均衡调度算法</span></span>
<span class="line"><span style="color:#24292E;">    lb_algo rr</span></span>
<span class="line"><span style="color:#24292E;">    # 负载均衡转发规则</span></span>
<span class="line"><span style="color:#24292E;">    lb_kind NAT</span></span>
<span class="line"><span style="color:#24292E;">    # 设置会话保持时间protocol TCP #指定转发协议类型，有 TCP 和 UDP 两种</span></span>
<span class="line"><span style="color:#24292E;">    persistence_timeout </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#24292E;">    # 配置服务器节点 </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">，需要指定 real server 的真实 IP 地址和端口</span></span>
<span class="line"><span style="color:#24292E;">    real_server </span><span style="color:#B31D28;font-style:italic;">192.168.40.128</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        # 设置权重，数字越大权重越高</span></span>
<span class="line"><span style="color:#24292E;">        weight </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">        # realserver 的状态监测设置部分单位秒，用来检测它的状态</span></span>
<span class="line"><span style="color:#24292E;">        TCP_CHECK {</span></span>
<span class="line"><span style="color:#24292E;">            # 超时时间</span></span>
<span class="line"><span style="color:#24292E;">            connect_timeout </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            # 重试间隔</span></span>
<span class="line"><span style="color:#24292E;">            delay_before_retry </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">            # 监测端口</span></span>
<span class="line"><span style="color:#24292E;">            connect_port </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><ol start="2"><li>编写 脚本。Nginx/sbin</li></ol><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# vim nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ha</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">check.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">bin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sh   #</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sh 是指此脚本使用</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sh 来执行</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">A</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">\`ps </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">C nginx </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">no</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">header </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">wc </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [ $A </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">eq </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"><span style="color:#E1E4E8;"> then</span></span>
<span class="line"><span style="color:#E1E4E8;">     echo </span><span style="color:#9ECBFF;">&#39;nginx server is died&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">     service keepalived stop</span></span>
<span class="line"><span style="color:#E1E4E8;">fi</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# vim nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ha</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">check.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">bin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sh   #</span><span style="color:#D73A49;">!</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sh 是指此脚本使用</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sh 来执行</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">A</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">\`ps </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">C nginx </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">no</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">header </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">wc </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [ $A </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">eq </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;"> then</span></span>
<span class="line"><span style="color:#24292E;">     echo </span><span style="color:#032F62;">&#39;nginx server is died&#39;</span></span>
<span class="line"><span style="color:#24292E;">     service keepalived stop</span></span>
<span class="line"><span style="color:#24292E;">fi</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="2"><li>测试脚本是否可用</li></ol><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# sh nginx_status_check.sh </span></span>
<span class="line"><span style="color:#E1E4E8;">nginx server is died</span></span>
<span class="line"><span style="color:#E1E4E8;">Stopping </span><span style="color:#B392F0;">keepalived</span><span style="color:#E1E4E8;"> (via </span><span style="color:#FFAB70;">systemctl</span><span style="color:#E1E4E8;">):                       [  确定  ]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# sh nginx_status_check.sh </span></span>
<span class="line"><span style="color:#24292E;">nginx server is died</span></span>
<span class="line"><span style="color:#24292E;">Stopping </span><span style="color:#6F42C1;">keepalived</span><span style="color:#24292E;"> (via </span><span style="color:#E36209;">systemctl</span><span style="color:#24292E;">):                       [  确定  ]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="3"><li>添加生效</li></ol><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# chmod </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">x nginx_status_check.sh</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# service keepalived restart</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s stop</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# chmod </span><span style="color:#D73A49;">+</span><span style="color:#24292E;">x nginx_status_check.sh</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# service keepalived restart</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s stop</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="4"><li></li></ol></blockquote><p><img src="`+u+`" alt="JavaGuide_Nginx_扩展_OpenRestry_keepalived_配置的几点.png"></p><p>美团的 Camel</p><h1 id="openresty" tabindex="-1">OpenResty <a class="header-anchor" href="#openresty" aria-label="Permalink to &quot;OpenResty&quot;">​</a></h1><p>Nginx + lua</p><p>​ <strong>OpenResty</strong> 是一个通过 Lua 扩展 Nginx 实现的可伸缩的 Web 平台，内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p><h2 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h2><ol><li><p>下载安装包</p><p><a href="https://openresty.org/cn/download.html" target="_blank" rel="noreferrer">https://openresty.org/cn/download.html</a></p><ul><li><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">weget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://openresty.org/download/openresty-1.13.6.2.tar.gz</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">weget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://openresty.org/download/openresty-1.13.6.2.tar.gz</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ul></li><li><p>安装软件包</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# tar </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">zxvf openresty</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">1.13.6.2.tar.gz</span><span style="color:#E1E4E8;"> cd openrestry</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">1.13.6.2</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# mkdir openresty</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# cd openresty</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">1.13.6.2</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 software]# mkdir openresty</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 openresty</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">1.13.6.2</span><span style="color:#E1E4E8;">]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">configure  </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">=/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">openresty</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 openresty</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">1.13.6.2</span><span style="color:#E1E4E8;">]# make </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> make install</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 software]# tar </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">zxvf openresty</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">1.13.6.2.tar.gz</span><span style="color:#24292E;"> cd openrestry</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">1.13.6.2</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 software]# mkdir openresty</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 software]# cd openresty</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">1.13.6.2</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 software]# mkdir openresty</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 openresty</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">1.13.6.2</span><span style="color:#24292E;">]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">configure  </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">=/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">openresty</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 openresty</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">1.13.6.2</span><span style="color:#24292E;">]# make </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> make install</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">configure [默认会安装在</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">usr</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">local</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">openresty 目录] </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> 指定路径</span></span>
<span class="line"><span style="color:#E1E4E8;">make </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> make install</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">.</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">configure [默认会安装在</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">usr</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">local</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">openresty 目录] </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> 指定路径</span></span>
<span class="line"><span style="color:#24292E;">make </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> make install</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>可能存在的错误，第三方依赖库没有安装的情况下会报错</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">yum install readline</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">devel </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> pcre</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">devel </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">openssl</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">devel</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">yum install readline</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">devel </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> pcre</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">devel </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">openssl</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">devel</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>安装过程和 Nginx 是一样的，因为他是基于 Nginx 做的扩展</p></li></ol><h3 id="helloworld" tabindex="-1">HelloWorld <a class="header-anchor" href="#helloworld" aria-label="Permalink to &quot;HelloWorld&quot;">​</a></h3><p>开始第一个程序，HelloWorld</p><p><code>openresty/nginx/conf/nginx.conf</code> 就是 nginx 的配置的东西。</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian3 software]# cd openresty</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian3 nginx]# vim conf</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx.conf</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	default_type         text</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">html;</span></span>
<span class="line"><span style="color:#E1E4E8;">	content_by_lua_block {</span></span>
<span class="line"><span style="color:#E1E4E8;">	    ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;helloworld&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian3 nginx]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian3 software]# cd openresty</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian3 nginx]# vim conf</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx.conf</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	default_type         text</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">html;</span></span>
<span class="line"><span style="color:#24292E;">	content_by_lua_block {</span></span>
<span class="line"><span style="color:#24292E;">	    ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;helloworld&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian3 nginx]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>在 sbin 目录下执行.nginx 命令就可以运行，看到 helloworld</p><p><img src="`+d+`" alt="JavaGuide_Nginx_扩展_OpenRestry_nginx_hello_world.png"></p><h3 id="建立工作空间" tabindex="-1">建立工作空间 <a class="header-anchor" href="#建立工作空间" aria-label="Permalink to &quot;建立工作空间&quot;">​</a></h3><h4 id="创建目录" tabindex="-1">创建目录 <a class="header-anchor" href="#创建目录" aria-label="Permalink to &quot;创建目录&quot;">​</a></h4><p>​ 或者为了不影响默认的安装目录，我们可以创建一个独立的空间来练习，先在安装目录下创建 demo 目录，安装目录为 <code>/data/program/openresty/demo</code></p><p><strong>mkdir demo</strong></p><p>​ 然后在 demo 目录下创建两个子目录，一个是 logs 、一个是 conf</p><h4 id="创建配置文件" tabindex="-1">创建配置文件 <a class="header-anchor" href="#创建配置文件" aria-label="Permalink to &quot;创建配置文件&quot;">​</a></h4><p>执行：<code>./nginx -p /data/program/openresty/demo</code> 【-p 主要是指明 nginx 启动时的配置目录】</p><blockquote><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 openresty]# mkdir demo</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 openresty]# cd demo</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 demo]# mkdir conf</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 demo]# mkdir logs</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 demo]# cd conf</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 conf]# vim nginx.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">worker_processes </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">error_log logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;">events {</span></span>
<span class="line"><span style="color:#E1E4E8;">   worker_connections </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">http {</span></span>
<span class="line"><span style="color:#E1E4E8;">   server {</span></span>
<span class="line"><span style="color:#E1E4E8;">       listen </span><span style="color:#79B8FF;">8888</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">       location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">           default_type text</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">html;</span></span>
<span class="line"><span style="color:#E1E4E8;">           content_by_lua_block {</span></span>
<span class="line"><span style="color:#E1E4E8;">               ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Hello world&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">           }</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 conf]# cd ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">p </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">openresty</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">demo</span><span style="color:#F97583;">/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 openresty]# mkdir demo</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 openresty]# cd demo</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 demo]# mkdir conf</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 demo]# mkdir logs</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 demo]# cd conf</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 conf]# vim nginx.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">worker_processes </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">error_log logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log;</span></span>
<span class="line"><span style="color:#24292E;">events {</span></span>
<span class="line"><span style="color:#24292E;">   worker_connections </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">http {</span></span>
<span class="line"><span style="color:#24292E;">   server {</span></span>
<span class="line"><span style="color:#24292E;">       listen </span><span style="color:#005CC5;">8888</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">       location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">           default_type text</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">html;</span></span>
<span class="line"><span style="color:#24292E;">           content_by_lua_block {</span></span>
<span class="line"><span style="color:#24292E;">               ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Hello world&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">           }</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 conf]# cd ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">p </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">openresty</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">demo</span><span style="color:#D73A49;">/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></blockquote><p><img src="`+m+'" alt="JavaGuide_Nginx_扩展_OpenRestry_sub.png"></p><p><img src="'+F+`" alt="JavaGuide_Nginx_扩展_OpenRestry_nginx_test_index.png"></p><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>​ 我们刚刚通过一个 helloworld 的简单案例来演示了 <strong>nginx + lua</strong> 的功能，其中用到了 <code>ngx.say</code> 这个表达式，通过在 <code>content_by_lua_block</code> 这个片段中进行访问；这个表达式属于 ngx_lua 模块提供的 api， 用于向客户端输出一个内容。</p><p>​ 我们配置了多个 模块，就会有固定的顺序。</p><blockquote><p>写一个完全做认证的模块</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 openresty]# cd demo</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">conf</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 conf]# mkdir lua</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 conf]# cd lua</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 lua]# vim add.lua</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">local args </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ngx.req.</span><span style="color:#B392F0;">get_uri_args</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(args.a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> args.b);</span></span>
<span class="line"><span style="color:#E1E4E8;">                     </span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 lua]# vim params.lua</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">local _M </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">function _M.</span><span style="color:#B392F0;">is_number</span><span style="color:#E1E4E8;">(...)</span></span>
<span class="line"><span style="color:#E1E4E8;">    local arg </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {...}</span></span>
<span class="line"><span style="color:#E1E4E8;">    local num;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i,v in </span><span style="color:#B392F0;">ipairs</span><span style="color:#E1E4E8;">(arg) </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        num</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">tonumber</span><span style="color:#E1E4E8;">(v);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> nil </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> num then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        end</span></span>
<span class="line"><span style="color:#E1E4E8;">    end</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> _M;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 lua]#  vim check.lua</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">local param</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;params&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">local args</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ngx.req.</span><span style="color:#B392F0;">get_uri_args</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> not args.a or not args.b or not param.</span><span style="color:#B392F0;">is_number</span><span style="color:#E1E4E8;">(args.a, args.b) then</span></span>
<span class="line"><span style="color:#E1E4E8;">    ngx.</span><span style="color:#B392F0;">exit</span><span style="color:#E1E4E8;">(ngx.HTTP_BAD_REQUEST);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 lua]# vim ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx.conf </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">worker_processes </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">error_log logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;">events {</span></span>
<span class="line"><span style="color:#E1E4E8;">    worker_connections </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">http {</span></span>
<span class="line"><span style="color:#E1E4E8;">    lua_package_path </span><span style="color:#9ECBFF;">&#39;$prefix/lua/?.lua&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    lua_code_cache off;</span></span>
<span class="line"><span style="color:#E1E4E8;">    server {</span></span>
<span class="line"><span style="color:#E1E4E8;">        listen </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        location </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">^/</span><span style="color:#E1E4E8;">api</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">_a</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">zA</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Z0_9]</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            access_by_lua_file lua</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">check.lua;</span></span>
<span class="line"><span style="color:#E1E4E8;">            content_by_lua_file lua</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">$</span><span style="color:#FDAEB7;font-style:italic;">1.lua</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 lua]# cd ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# history   </span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">p </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">openresty</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">demo</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">nginx: [alert] lua_code_cache is off; this will hurt performance in </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">software</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">openresty</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">demo</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">conf</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx.conf:</span><span style="color:#79B8FF;">11</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 openresty]# cd demo</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">conf</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 conf]# mkdir lua</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 conf]# cd lua</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 lua]# vim add.lua</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">local args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ngx.req.</span><span style="color:#6F42C1;">get_uri_args</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(args.a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> args.b);</span></span>
<span class="line"><span style="color:#24292E;">                     </span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 lua]# vim params.lua</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">local _M </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">function _M.</span><span style="color:#6F42C1;">is_number</span><span style="color:#24292E;">(...)</span></span>
<span class="line"><span style="color:#24292E;">    local arg </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {...}</span></span>
<span class="line"><span style="color:#24292E;">    local num;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i,v in </span><span style="color:#6F42C1;">ipairs</span><span style="color:#24292E;">(arg) </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        num</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">tonumber</span><span style="color:#24292E;">(v);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> nil </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> num then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        end</span></span>
<span class="line"><span style="color:#24292E;">    end</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">end</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> _M;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 lua]#  vim check.lua</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">local param</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">require</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;params&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">local args</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ngx.req.</span><span style="color:#6F42C1;">get_uri_args</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> not args.a or not args.b or not param.</span><span style="color:#6F42C1;">is_number</span><span style="color:#24292E;">(args.a, args.b) then</span></span>
<span class="line"><span style="color:#24292E;">    ngx.</span><span style="color:#6F42C1;">exit</span><span style="color:#24292E;">(ngx.HTTP_BAD_REQUEST);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 lua]# vim ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx.conf </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">worker_processes </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">error_log logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log;</span></span>
<span class="line"><span style="color:#24292E;">events {</span></span>
<span class="line"><span style="color:#24292E;">    worker_connections </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">http {</span></span>
<span class="line"><span style="color:#24292E;">    lua_package_path </span><span style="color:#032F62;">&#39;$prefix/lua/?.lua&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    lua_code_cache off;</span></span>
<span class="line"><span style="color:#24292E;">    server {</span></span>
<span class="line"><span style="color:#24292E;">        listen </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        location </span><span style="color:#D73A49;">~</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">^/</span><span style="color:#24292E;">api</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">_a</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">zA</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Z0_9]</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            access_by_lua_file lua</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">check.lua;</span></span>
<span class="line"><span style="color:#24292E;">            content_by_lua_file lua</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">$</span><span style="color:#B31D28;font-style:italic;">1.lua</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 lua]# cd ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# history   </span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">p </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">openresty</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">demo</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">nginx: [alert] lua_code_cache is off; this will hurt performance in </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">software</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">openresty</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">demo</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">conf</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx.conf:</span><span style="color:#005CC5;">11</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>​ 在 lua 里边有模块的概念，有包的概念。我可以把公共的代码放到一个文件里边。以 API 的方式去提供。可以把他作为一个方法。</p><p>​ 正常地来说，我们会有一个 lua 文件夹，按照我们的需求去写。</p><p>​ 我可以利用 lua 写一些复杂的逻辑。可以写业务代码的。</p><h4 id="注意" tabindex="-1">注意： <a class="header-anchor" href="#注意" aria-label="Permalink to &quot;注意：&quot;">​</a></h4><p><strong>lua</strong> 目录在 demo 目录下 <code>openresty/demo/lua/sub.lua</code></p><blockquote><ul><li>JS 、 shell 都叫做脚本语言。</li><li>history 查看命令的历史。</li></ul><p><img src="`+g+`" alt="JavaGuide_Nginx_扩展_OpenRestry_nginx_lua脚本.png"></p></blockquote></blockquote><h1 id="库文件使用" tabindex="-1">库文件使用 <a class="header-anchor" href="#库文件使用" aria-label="Permalink to &quot;库文件使用&quot;">​</a></h1><p>​ 通过上面的案例，我们基本上对 OpenResty 有了一个更深的认识，其中我们用到了自定义的 lua 模块。实际上 openresty 提供了很丰富的模块。让我们在实现某些场景的时候更加方便。可以在 /<code>openresty/lualib</code> 目录下看到；比如在 resty 目录下可以看到 <code>redis.lua</code>、<code>mysql.lua</code> 这样的操作 redis 和操作数据库的模块。</p><h2 id="使用-redis-模块连接-redis" tabindex="-1">使用 redis 模块连接 redis <a class="header-anchor" href="#使用-redis-模块连接-redis" aria-label="Permalink to &quot;使用 redis 模块连接 redis&quot;">​</a></h2><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">worker_processes </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">error_log           </span></span>
<span class="line"><span style="color:#E1E4E8;">logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log; events {</span></span>
<span class="line"><span style="color:#E1E4E8;">    worker_connections </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">http {</span></span>
<span class="line"><span style="color:#E1E4E8;">    lua_package_path </span><span style="color:#9ECBFF;">&#39;$prefix/lualib/?.lua;;&#39;</span><span style="color:#E1E4E8;">; # 添加”;;”表示默认路径下的lualib</span></span>
<span class="line"><span style="color:#E1E4E8;">    lua_package_cpath </span><span style="color:#9ECBFF;">&#39;$prefix/lualib/?.so;;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">server {</span></span>
<span class="line"><span style="color:#E1E4E8;">    location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">demo { </span></span>
<span class="line"><span style="color:#E1E4E8;">        content_by_lua_block {</span></span>
<span class="line"><span style="color:#E1E4E8;">            local redisModule</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">require </span><span style="color:#9ECBFF;">&quot;resty.redis&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            local redis</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">redisModule:</span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;">();   # lua 的对象实例 </span></span>
<span class="line"><span style="color:#E1E4E8;">            redis:</span><span style="color:#B392F0;">set_timeout</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">); </span></span>
<span class="line"><span style="color:#E1E4E8;">            ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;===begin connect redis server&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            local ok,err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> redis:</span><span style="color:#B392F0;">connect</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;127.0.0.1&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">6379</span><span style="color:#E1E4E8;">);   #连接 redis</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> not ok then</span></span>
<span class="line"><span style="color:#E1E4E8;">                ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;==connection redis failed,error message:&quot;</span><span style="color:#E1E4E8;">,err);</span></span>
<span class="line"><span style="color:#E1E4E8;">            end</span></span>
<span class="line"><span style="color:#E1E4E8;">                ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;==begin set key and value&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                ok,err</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">redis:</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;world&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> not ok then</span></span>
<span class="line"><span style="color:#E1E4E8;">                ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;set value failed&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            end</span></span>
<span class="line"><span style="color:#E1E4E8;">                ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;===set value result:&quot;</span><span style="color:#E1E4E8;">,ok);</span></span>
<span class="line"><span style="color:#E1E4E8;">                redis:</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">worker_processes </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">error_log           </span></span>
<span class="line"><span style="color:#24292E;">logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log; events {</span></span>
<span class="line"><span style="color:#24292E;">    worker_connections </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">http {</span></span>
<span class="line"><span style="color:#24292E;">    lua_package_path </span><span style="color:#032F62;">&#39;$prefix/lualib/?.lua;;&#39;</span><span style="color:#24292E;">; # 添加”;;”表示默认路径下的lualib</span></span>
<span class="line"><span style="color:#24292E;">    lua_package_cpath </span><span style="color:#032F62;">&#39;$prefix/lualib/?.so;;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">server {</span></span>
<span class="line"><span style="color:#24292E;">    location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">demo { </span></span>
<span class="line"><span style="color:#24292E;">        content_by_lua_block {</span></span>
<span class="line"><span style="color:#24292E;">            local redisModule</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">require </span><span style="color:#032F62;">&quot;resty.redis&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            local redis</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">redisModule:</span><span style="color:#6F42C1;">new</span><span style="color:#24292E;">();   # lua 的对象实例 </span></span>
<span class="line"><span style="color:#24292E;">            redis:</span><span style="color:#6F42C1;">set_timeout</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">); </span></span>
<span class="line"><span style="color:#24292E;">            ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;===begin connect redis server&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            local ok,err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> redis:</span><span style="color:#6F42C1;">connect</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;127.0.0.1&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">6379</span><span style="color:#24292E;">);   #连接 redis</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> not ok then</span></span>
<span class="line"><span style="color:#24292E;">                ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;==connection redis failed,error message:&quot;</span><span style="color:#24292E;">,err);</span></span>
<span class="line"><span style="color:#24292E;">            end</span></span>
<span class="line"><span style="color:#24292E;">                ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;==begin set key and value&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                ok,err</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">redis:</span><span style="color:#6F42C1;">set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;world&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> not ok then</span></span>
<span class="line"><span style="color:#24292E;">                ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;set value failed&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">            end</span></span>
<span class="line"><span style="color:#24292E;">                ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;===set value result:&quot;</span><span style="color:#24292E;">,ok);</span></span>
<span class="line"><span style="color:#24292E;">                redis:</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="演示效果" tabindex="-1">演示效果 <a class="header-anchor" href="#演示效果" aria-label="Permalink to &quot;演示效果&quot;">​</a></h3><p>到 nginx 路径下执行 ./nginx -p /data/program/openresty/redisdemo 在浏览器中输入：<a href="http://192.168.11.160/demo" target="_blank" rel="noreferrer">http://192.168.11.160/demo </a>即可看到输出内容并且连接到 redis 服务器上以后，可以看到 redis 上的结果</p><p>redis 的所有命令操作，在 lua 中都有提供相应的操作。比如 redis:get(“key”)、</p><p>redis:set()等</p><h1 id="网关" tabindex="-1">网关 <a class="header-anchor" href="#网关" aria-label="Permalink to &quot;网关&quot;">​</a></h1><p>​ 通过扩展以后，在实际过程中应该怎么去应用呢？一般的使用场景： 网关、​web 防火墙、缓存服务器（对响应内容进行缓存，减少到达后端的请求，来提升性能），接下来重点讲讲网关的概念以及如何通过 Openresty 实现网关开发。</p><h3 id="网关的概念" tabindex="-1">网关的概念 <a class="header-anchor" href="#网关的概念" aria-label="Permalink to &quot;网关的概念&quot;">​</a></h3><p>​ 从一个房间到另一个房间，必须要经过一扇门，同样，从一个网络向另一个网络发送信息，必须经过一道“关口”，这道关口就是网关。顾名思义，网关(Gateway) 就是一个网络连接到另一个网络的“关口”。</p><p>​ 那什么是 API 网关呢？</p><p>​ 在微服务流行起来之前，api 网关就一直存在，最主要的应用场景就是开放平台， 也就是 open api; 这种场景大家接触的一定比较多，比如阿里的开放平台；当微服务流行起来以后，api 网关就成了上层应用集成的标配组件。</p><blockquote><p>​ 比如说，支付包地址会有一个网关，做一个统一的路由转发。</p></blockquote><h2 id="为什么需要网关" tabindex="-1">为什么需要网关？ <a class="header-anchor" href="#为什么需要网关" aria-label="Permalink to &quot;为什么需要网关？&quot;">​</a></h2><ul><li>Kong 、Orange 、</li></ul><h3 id="对微服务组件地址进行统一抽象" tabindex="-1">对微服务组件地址进行统一抽象 <a class="header-anchor" href="#对微服务组件地址进行统一抽象" aria-label="Permalink to &quot;对微服务组件地址进行统一抽象&quot;">​</a></h3><p>​ API 网关意味着你要把 API 网关放到你的微服务的最前端，并且要让 API 网关变成由应用所发起的每个请求的入口。这样就可以简化实现客户端和微服务应用程序之间的沟通方式。</p><h3 id="backends-for-frontends" tabindex="-1">Backends for frontends <a class="header-anchor" href="#backends-for-frontends" aria-label="Permalink to &quot;Backends for frontends&quot;">​</a></h3><p><img src="`+v+'" alt="JavaGuide_Nginx_扩展_OpenRestry_多个GateWay网关服务.png"></p><p>​ 当服务越来越多以后，我们需要考虑一个问题，就是对某些服务进行安全校验以及用户身份校验。甚至包括对流量进行控制。 我们会对需要做流控、需要做身份认证的服务单独提供认证功能，但是服务越来越多以后，会发现很多组件的校验是重复的。这些东西很明显不是每个微服务组件需要去关心的事情。微服务组件只需要负责接收请求以及返回响应即可。可以把身份认证、流控都放在 API 网关层来进行控制。</p><p>​ 针对于 app 或者 web 等分别做不同的网关。不同的客户端是不同的验证、不同的方式。</p><ul><li>按照服务组件进行统一的抽象</li><li>针对不同的客户端来实现不同的 API 网关</li></ul><h2 id="网关的作用" tabindex="-1">网关的作用 <a class="header-anchor" href="#网关的作用" aria-label="Permalink to &quot;网关的作用&quot;">​</a></h2><ul><li>鉴权</li><li>限流</li><li>灰度发布</li><li>分流</li><li>日志记录</li></ul><h3 id="openresty-实现-api-网关限流及登录授权" tabindex="-1">OpenResty 实现 API 网关限流及登录授权 <a class="header-anchor" href="#openresty-实现-api-网关限流及登录授权" aria-label="Permalink to &quot;OpenResty 实现 API 网关限流及登录授权&quot;">​</a></h3><p><strong>OpenResty</strong> <strong>为什么能做网关？</strong></p><p>​ 前面我们了解到了网关的作用，通过网关，可以对 api 访问的前置操作进行统一的管理，比如鉴权、限流、负载均衡、日志收集、请求分片等。所以 API 网关的核心是所有客户端对接后端服务之前，都需要统一接入网关，通过网关层将所有非业务功能进行处理。</p><p>​ OpenResty 为什么能实现网关呢？ OpenResty 有一个非常重要的因素是，对于每一个请求，Openresty 会把请求分为不同阶段，从而可以让第三方模块通过挂载行为来实现不同阶段的自定义行为。而这样的机制能够让我们非常方便地设计 api 网关。</p><p><img src="'+_+'" alt="JavaGuide_Nginx_扩展_OpenRestry_Lua插件图解.png"></p><p>​ Nginx 本身在处理一个用户请求时，会按照不同的阶段进行处理，总共会分为 11 个阶段。而 openresty 的执行指令，就是在这 11 个步骤中挂载 lua 执行脚本实现扩展，我们分别看看每个指令的作用。</p><p><strong>initbylua</strong> : 当 Nginx master 进程加载 nginx 配置文件时会运行这段 lua 脚本，一般用来注册全局变量或者预加载 lua 模块</p><p><strong>initwokerby_lua:</strong> 每个 Nginx worker 进程启动时会执行的 lua 脚本，可以用来做健康检查</p><p><strong>setbylua</strong>:设置一个变量</p><p><strong>rewritebylua</strong>:在 rewrite 阶段执行，为每个请求执行指定的 lua 脚本</p><p><strong>accessbylua</strong>:为每个请求在访问阶段调用 lua 脚本</p><p><strong>contentbylua</strong>:前面演示过，通过 lua 脚本生成 content 输出给 http 响应</p><p><strong>balancerbylua</strong>:实现动态负载均衡，如果不是走 content<em>by</em>lua，则走 proxy_pass,再通过 upstream 进行转发</p><p><strong>headerfilterby_lua</strong>: 通过 lua 来设置 headers 或者 cookie</p><p><strong>bodyfilterby_lua</strong>:对响应数据进行过滤</p><p><strong>logbylua</strong> ： 在 log 阶段执行的脚本，一般用来做数据统计，将请求数据传输到后端进行分析</p><blockquote><p>zuul 的 filter 也是类似的实现。</p></blockquote><h2 id="灰度发布" tabindex="-1">灰度发布 <a class="header-anchor" href="#灰度发布" aria-label="Permalink to &quot;灰度发布&quot;">​</a></h2><p>​ 在单一架构中，随着代码量和业务量不断扩大，版本迭代会逐步变成一个很困难的事情，哪怕是一点小的修改，都必须要对整个应用重新部署。 但是在微服务中， 各个模块是一个独立运行的组件，版本迭代会很方便，影响面很小。</p><p>​ 同时，微服务化的组件节点，对于我们去实现灰度发布（金丝雀发布：将一部分流量引导到新的版本）来说，也会变得很简单；</p><p>​ 还可以有白名单，比如说 QQ 的升级改造计划，针对你升级。</p><p>​ 所以通过 API 网关，可以对指定调用的微服务版本，通过版本来隔离。如下图所示。</p><p><img src="'+C+`" alt="JavaGuide_Nginx_扩展_OpenRestry_nginx做灰度切换.png"></p><h3 id="灰度发布的实现" tabindex="-1">灰度发布的实现 <a class="header-anchor" href="#灰度发布的实现" aria-label="Permalink to &quot;灰度发布的实现&quot;">​</a></h3><ol><li><p>文件目录， <code>/data/program/openresty/gray [conf、logs、lua]</code></p></li><li><p>编写 Nginx 的配置文件 <code>nginx.conf</code></p></li></ol><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   [root@Darian1 openresty]# mkdir gray</span></span>
<span class="line"><span style="color:#E1E4E8;">   [root@Darian1 openresty]# cd gray</span></span>
<span class="line"><span style="color:#E1E4E8;">   [root@Darian1 gray]# mkdir lua</span></span>
<span class="line"><span style="color:#E1E4E8;">   [root@Darian1 gray]# mkdir logs</span></span>
<span class="line"><span style="color:#E1E4E8;">   [root@Darian1 gray]# mkdir conf</span></span>
<span class="line"><span style="color:#E1E4E8;">   [root@Darian1 gray]# cd conf</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   worker_processes </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   error_log      logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   events{</span></span>
<span class="line"><span style="color:#E1E4E8;">       worker_connections </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">   http{</span></span>
<span class="line"><span style="color:#E1E4E8;">       lua_package_path </span><span style="color:#9ECBFF;">&quot;$prefix/lualib/?.lua;;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">       lua_package_cpath </span><span style="color:#9ECBFF;">&quot;$prefix/lualib/?.so;;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">       upstream prod {</span></span>
<span class="line"><span style="color:#E1E4E8;">           server </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.128</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">8080</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">       upstream pre {</span></span>
<span class="line"><span style="color:#E1E4E8;">           server </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.129</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">8080</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">       server {</span></span>
<span class="line"><span style="color:#E1E4E8;">           listen  </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">           server_name localhost;</span></span>
<span class="line"><span style="color:#E1E4E8;">           location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">api {</span></span>
<span class="line"><span style="color:#E1E4E8;">               content_by_lua_file lua</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">gray.lua;</span></span>
<span class="line"><span style="color:#E1E4E8;">           }</span></span>
<span class="line"><span style="color:#E1E4E8;">           location @prod {</span></span>
<span class="line"><span style="color:#E1E4E8;">               proxy_pass http:</span><span style="color:#6A737D;">//prod;</span></span>
<span class="line"><span style="color:#E1E4E8;">           }</span></span>
<span class="line"><span style="color:#E1E4E8;">           location @pre {</span></span>
<span class="line"><span style="color:#E1E4E8;">               proxy_pass http:</span><span style="color:#6A737D;">//pre;</span></span>
<span class="line"><span style="color:#E1E4E8;">           }</span></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   [root@Darian1 conf]# cd ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lua</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">   [root@Darian1 lua]# vim gray.lua</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span>
<span class="line"><span style="color:#24292E;">   [root@Darian1 openresty]# mkdir gray</span></span>
<span class="line"><span style="color:#24292E;">   [root@Darian1 openresty]# cd gray</span></span>
<span class="line"><span style="color:#24292E;">   [root@Darian1 gray]# mkdir lua</span></span>
<span class="line"><span style="color:#24292E;">   [root@Darian1 gray]# mkdir logs</span></span>
<span class="line"><span style="color:#24292E;">   [root@Darian1 gray]# mkdir conf</span></span>
<span class="line"><span style="color:#24292E;">   [root@Darian1 gray]# cd conf</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   worker_processes </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   error_log      logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log;</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   events{</span></span>
<span class="line"><span style="color:#24292E;">       worker_connections </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">   http{</span></span>
<span class="line"><span style="color:#24292E;">       lua_package_path </span><span style="color:#032F62;">&quot;$prefix/lualib/?.lua;;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">       lua_package_cpath </span><span style="color:#032F62;">&quot;$prefix/lualib/?.so;;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">       upstream prod {</span></span>
<span class="line"><span style="color:#24292E;">           server </span><span style="color:#B31D28;font-style:italic;">192.168.40.128</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">8080</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">       upstream pre {</span></span>
<span class="line"><span style="color:#24292E;">           server </span><span style="color:#B31D28;font-style:italic;">192.168.40.129</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">8080</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">       server {</span></span>
<span class="line"><span style="color:#24292E;">           listen  </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">           server_name localhost;</span></span>
<span class="line"><span style="color:#24292E;">           location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">api {</span></span>
<span class="line"><span style="color:#24292E;">               content_by_lua_file lua</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">gray.lua;</span></span>
<span class="line"><span style="color:#24292E;">           }</span></span>
<span class="line"><span style="color:#24292E;">           location @prod {</span></span>
<span class="line"><span style="color:#24292E;">               proxy_pass http:</span><span style="color:#6A737D;">//prod;</span></span>
<span class="line"><span style="color:#24292E;">           }</span></span>
<span class="line"><span style="color:#24292E;">           location @pre {</span></span>
<span class="line"><span style="color:#24292E;">               proxy_pass http:</span><span style="color:#6A737D;">//pre;</span></span>
<span class="line"><span style="color:#24292E;">           }</span></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">       </span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   [root@Darian1 conf]# cd ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lua</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">   [root@Darian1 lua]# vim gray.lua</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><ol start="3"><li>编写 gray.lua 文件</li></ol><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   local redis</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">require </span><span style="color:#9ECBFF;">&quot;resty.redis&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   local red</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">redis:</span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">   red:</span><span style="color:#B392F0;">set_timeout</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   local ok,err</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">red:</span><span style="color:#B392F0;">connect</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;192.168.40.128&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">6379</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> not ok then</span></span>
<span class="line"><span style="color:#E1E4E8;">       ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;failed to connect redis&quot;</span><span style="color:#E1E4E8;">,err);</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   end</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   local headers</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ngx.req.</span><span style="color:#B392F0;">get_headers</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">   local local_ip</span><span style="color:#F97583;">=</span><span style="color:#FFAB70;">headers</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;X-REAL-IP&quot;</span><span style="color:#E1E4E8;">] or </span><span style="color:#FFAB70;">headers</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&quot;X_FORWARDED_FOR&quot;</span><span style="color:#E1E4E8;">] or ngx.var.remote_addr</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   local ip_lists</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">red:</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;gray&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ip_lists </span><span style="color:#F97583;">~=</span><span style="color:#E1E4E8;"> nil and  string.</span><span style="color:#B392F0;">find</span><span style="color:#E1E4E8;">(ip_lists,local_ip) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> nil then</span></span>
<span class="line"><span style="color:#E1E4E8;">       ngx.</span><span style="color:#B392F0;">exec</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;@prod&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">       ngx.</span><span style="color:#B392F0;">exec</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;@pre&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">   end</span></span>
<span class="line"><span style="color:#E1E4E8;">       local ok,err</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">red:</span><span style="color:#B392F0;">close</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span>
<span class="line"><span style="color:#24292E;">   local redis</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">require </span><span style="color:#032F62;">&quot;resty.redis&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   local red</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">redis:</span><span style="color:#6F42C1;">new</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">   red:</span><span style="color:#6F42C1;">set_timeout</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   local ok,err</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">red:</span><span style="color:#6F42C1;">connect</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;192.168.40.128&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">6379</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> not ok then</span></span>
<span class="line"><span style="color:#24292E;">       ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;failed to connect redis&quot;</span><span style="color:#24292E;">,err);</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   end</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   local headers</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ngx.req.</span><span style="color:#6F42C1;">get_headers</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">   local local_ip</span><span style="color:#D73A49;">=</span><span style="color:#E36209;">headers</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;X-REAL-IP&quot;</span><span style="color:#24292E;">] or </span><span style="color:#E36209;">headers</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&quot;X_FORWARDED_FOR&quot;</span><span style="color:#24292E;">] or ngx.var.remote_addr</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   local ip_lists</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">red:</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;gray&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ip_lists </span><span style="color:#D73A49;">~=</span><span style="color:#24292E;"> nil and  string.</span><span style="color:#6F42C1;">find</span><span style="color:#24292E;">(ip_lists,local_ip) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> nil then</span></span>
<span class="line"><span style="color:#24292E;">       ngx.</span><span style="color:#6F42C1;">exec</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;@prod&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">       ngx.</span><span style="color:#6F42C1;">exec</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;@pre&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">   end</span></span>
<span class="line"><span style="color:#24292E;">       local ok,err</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">red:</span><span style="color:#6F42C1;">close</span><span style="color:#24292E;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ol start="4"><li></li><li><p>执行命令启动 nginx: [./nginx -p /data/program/openresty/gray]</p></li><li><p>启动 redis，并设置 set gray 192.168.11.160</p></li><li><p>通过浏览器运行: <a href="http://192.168.11.160/api" target="_blank" rel="noreferrer">http://192.168.11.160/api </a>查看运行结果</p><p>修改 redis gray 的值，将客户端的 ip 存储到 redis 中 。set gray 1 再次运行结果， 即可看到访问结果已经发生了变化。</p></li></ol><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Darian1 sbin]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">p ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">gray</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 bin]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">redis</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">server ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">redis</span><span style="color:#F97583;">-</span><span style="color:#FDAEB7;font-style:italic;">3.2.8</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">redis.conf </span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Darian1 bin]# .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">redis</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">cli </span></span>
<span class="line"><span style="color:#FDAEB7;font-style:italic;">127.0.0.1</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">6379</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> set gray </span><span style="color:#FDAEB7;font-style:italic;">192.168.23.66</span></span>
<span class="line"><span style="color:#E1E4E8;">OK</span></span>
<span class="line"><span style="color:#FDAEB7;font-style:italic;">127.0.0.1</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">6379</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> set gray </span><span style="color:#FDAEB7;font-style:italic;">192.168.40.1</span></span>
<span class="line"><span style="color:#E1E4E8;">OK</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Darian1 sbin]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">p ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">gray</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 bin]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">redis</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">server ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">redis</span><span style="color:#D73A49;">-</span><span style="color:#B31D28;font-style:italic;">3.2.8</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">redis.conf </span></span>
<span class="line"><span style="color:#24292E;">[root@Darian1 bin]# .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">redis</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">cli </span></span>
<span class="line"><span style="color:#B31D28;font-style:italic;">127.0.0.1</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">6379</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> set gray </span><span style="color:#B31D28;font-style:italic;">192.168.23.66</span></span>
<span class="line"><span style="color:#24292E;">OK</span></span>
<span class="line"><span style="color:#B31D28;font-style:italic;">127.0.0.1</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">6379</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> set gray </span><span style="color:#B31D28;font-style:italic;">192.168.40.1</span></span>
<span class="line"><span style="color:#24292E;">OK</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="`+D+'" alt="JavaGuide_Nginx_扩展_OpenRestry_tomcat请求界面.png"></p><h3 id="高可用踩坑" tabindex="-1">高可用踩坑： <a class="header-anchor" href="#高可用踩坑" aria-label="Permalink to &quot;高可用踩坑：&quot;">​</a></h3><p>记得网卡配置正确。</p><p><img src="'+h+`" alt="JavaGuide_Nginx_扩展_OpenRestry_高可用配置正确.png"></p><h4 id="openresty-demo-conf-nginx-conf-的配置文件" tabindex="-1">OpenResty/Demo/conf/nginx.conf 的配置文件 <a class="header-anchor" href="#openresty-demo-conf-nginx-conf-的配置文件" aria-label="Permalink to &quot;OpenResty/Demo/conf/nginx.conf 的配置文件&quot;">​</a></h4><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">worker_processes </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">error_log logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;">events {</span></span>
<span class="line"><span style="color:#E1E4E8;">    worker_connections </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">http {</span></span>
<span class="line"><span style="color:#E1E4E8;">    server {</span></span>
<span class="line"><span style="color:#E1E4E8;">        listen </span><span style="color:#79B8FF;">8888</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            default_type text</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">html;</span></span>
<span class="line"><span style="color:#E1E4E8;">            content_by_lua_block {</span></span>
<span class="line"><span style="color:#E1E4E8;">                local args </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ngx.req.</span><span style="color:#B392F0;">get_uri_args</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Hello world&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sub {</span></span>
<span class="line"><span style="color:#E1E4E8;">            content_by_lua_block{</span></span>
<span class="line"><span style="color:#E1E4E8;">                local args </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ngx.req.</span><span style="color:#B392F0;">get_uri_args</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(args.a</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">args.b);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">worker_processes </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">error_log logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log;</span></span>
<span class="line"><span style="color:#24292E;">events {</span></span>
<span class="line"><span style="color:#24292E;">    worker_connections </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">http {</span></span>
<span class="line"><span style="color:#24292E;">    server {</span></span>
<span class="line"><span style="color:#24292E;">        listen </span><span style="color:#005CC5;">8888</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            default_type text</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">html;</span></span>
<span class="line"><span style="color:#24292E;">            content_by_lua_block {</span></span>
<span class="line"><span style="color:#24292E;">                local args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ngx.req.</span><span style="color:#6F42C1;">get_uri_args</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Hello world&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sub {</span></span>
<span class="line"><span style="color:#24292E;">            content_by_lua_block{</span></span>
<span class="line"><span style="color:#24292E;">                local args </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ngx.req.</span><span style="color:#6F42C1;">get_uri_args</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">                ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(args.a</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">args.b);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">worker_processes </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">error_log      logs</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">error.log;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">events{  </span></span>
<span class="line"><span style="color:#E1E4E8;">    worker_connections </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">http{</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 两个分号，表示默认路径下</span></span>
<span class="line"><span style="color:#E1E4E8;">    lua_package_path </span><span style="color:#9ECBFF;">&quot;$prefix/lualib/?.lua;;&quot;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">    lua_package_cpath </span><span style="color:#9ECBFF;">&quot;$prefix/lualib/?.so;;&quot;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">    upstream prod {</span></span>
<span class="line"><span style="color:#E1E4E8;">        server </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.156</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">8080</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    upstream pre {</span></span>
<span class="line"><span style="color:#E1E4E8;">        server </span><span style="color:#FDAEB7;font-style:italic;">192.168.11.156</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">8081</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    server {</span></span>
<span class="line"><span style="color:#E1E4E8;">        listen  </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        server_name localhost; </span></span>
<span class="line"><span style="color:#E1E4E8;">        location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">api {</span></span>
<span class="line"><span style="color:#E1E4E8;">            content_by_lua_file lua</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">gray.lua;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        location @prod { </span></span>
<span class="line"><span style="color:#E1E4E8;">            proxy_pass http:</span><span style="color:#6A737D;">//prod;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        location @pre { </span></span>
<span class="line"><span style="color:#E1E4E8;">            proxy_pass http:</span><span style="color:#6A737D;">//pre;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    server {</span></span>
<span class="line"><span style="color:#E1E4E8;">        listen </span><span style="color:#79B8FF;">8080</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            content_by_lua_block { </span></span>
<span class="line"><span style="color:#E1E4E8;">                ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;I&#39;m prod env&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    server {</span></span>
<span class="line"><span style="color:#E1E4E8;">        listen </span><span style="color:#79B8FF;">8081</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">        location </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            content_by_lua_block { </span></span>
<span class="line"><span style="color:#E1E4E8;">                ngx.</span><span style="color:#B392F0;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;I&#39;m pre env&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">worker_processes </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">error_log      logs</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">error.log;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">events{  </span></span>
<span class="line"><span style="color:#24292E;">    worker_connections </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">http{</span></span>
<span class="line"><span style="color:#24292E;">    # 两个分号，表示默认路径下</span></span>
<span class="line"><span style="color:#24292E;">    lua_package_path </span><span style="color:#032F62;">&quot;$prefix/lualib/?.lua;;&quot;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">    lua_package_cpath </span><span style="color:#032F62;">&quot;$prefix/lualib/?.so;;&quot;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">    upstream prod {</span></span>
<span class="line"><span style="color:#24292E;">        server </span><span style="color:#B31D28;font-style:italic;">192.168.11.156</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">8080</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    upstream pre {</span></span>
<span class="line"><span style="color:#24292E;">        server </span><span style="color:#B31D28;font-style:italic;">192.168.11.156</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">8081</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    server {</span></span>
<span class="line"><span style="color:#24292E;">        listen  </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        server_name localhost; </span></span>
<span class="line"><span style="color:#24292E;">        location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">api {</span></span>
<span class="line"><span style="color:#24292E;">            content_by_lua_file lua</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">gray.lua;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        location @prod { </span></span>
<span class="line"><span style="color:#24292E;">            proxy_pass http:</span><span style="color:#6A737D;">//prod;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        location @pre { </span></span>
<span class="line"><span style="color:#24292E;">            proxy_pass http:</span><span style="color:#6A737D;">//pre;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    server {</span></span>
<span class="line"><span style="color:#24292E;">        listen </span><span style="color:#005CC5;">8080</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            content_by_lua_block { </span></span>
<span class="line"><span style="color:#24292E;">                ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;I&#39;m prod env&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    server {</span></span>
<span class="line"><span style="color:#24292E;">        listen </span><span style="color:#005CC5;">8081</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">        location </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            content_by_lua_block { </span></span>
<span class="line"><span style="color:#24292E;">                ngx.</span><span style="color:#6F42C1;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;I&#39;m pre env&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div>`,163),f=[k];function B(x,q,w,P,R,N){return n(),a("div",null,f)}const O=s(A,[["render",B]]);export{T as __pageData,O as default};
