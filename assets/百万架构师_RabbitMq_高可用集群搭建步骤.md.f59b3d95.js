import{_ as s,o as a,h as n,Q as l}from"./chunks/framework.da611722.js";const m=JSON.parse('{"title":"高可用集群搭建步骤 | JavaGuide","description":"","frontmatter":{"head":[["link",{"rel":"canonical","href":"https://javaguide.net/百万架构师/RabbitMq/高可用集群搭建步骤.html"}],["meta",{"name":"keywords","content":"高可用集群搭建步骤 , JavaGuide , JavaGuide官网, Java面试指南, Java基础, 多线程, JVM, 虚拟机, 数据库, MySQL, Spring, Redis, MyBatis, 系统设计, 分布式, RPC, 高可用, 高并发"}],["meta",{"name":"og:url","content":"https://JavaGuide.net"}],["meta",{"name":"og:type","content":"website"}],["meta",{"name":"og:image","content":"https://javaguide.net/JavaGuide-og.png"}],["meta",{"name":"og:title","content":"高可用集群搭建步骤 | JavaGuide | Java面试指南 | JavaGuide官网"}],["meta",{"name":"og:description","content":"高可用集群搭建步骤 | JavaGuide | Java面试指南 | JavaGuide官网 | 「JavaGuide.net」一份涵盖大部分 Java 程序员所需要掌握的核心知识。准备 Java 面试，首选 JavaGuide.net ！"}],["meta",{"name":"twitter:site","content":"https://javaguide.net"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:creator","content":"nogeek.cn"}],["meta",{"name":"twitter:title","content":"高可用集群搭建步骤 | JavaGuide | Java面试指南 | JavaGuide官网"}],["meta",{"name":"twitter:description","content":"高可用集群搭建步骤 | JavaGuide | Java面试指南 | JavaGuide官网 | 「JavaGuide.net」一份涵盖大部分 Java 程序员所需要掌握的核心知识。准备 Java 面试，首选 JavaGuide.net ！"}],["meta",{"name":"twitter:image","content":"https://javaguide.net/JavaGuide-og.png"}],["meta",{"name":"sogou_site_verification","content":"fcAkazTXFd"}],["meta",{"name":"baidu-site-verification","content":"codeva-MXEPYsXKGk"}],["meta",{"name":"msvalidate.01","content":"9F2D57CFC59E8031212A166878638B15"}]]},"headers":[],"relativePath":"百万架构师/RabbitMq/高可用集群搭建步骤.md","filePath":"百万架构师/RabbitMq/高可用集群搭建步骤.md","lastUpdated":1741277271000}'),e={name:"百万架构师/RabbitMq/高可用集群搭建步骤.md"},p=l(`<h4 id="安装环境" tabindex="-1">安装环境 <a class="header-anchor" href="#安装环境" aria-label="Permalink to &quot;安装环境&quot;">​</a></h4><p>Centos-7</p><h4 id="三台虚拟机" tabindex="-1">三台虚拟机 <a class="header-anchor" href="#三台虚拟机" aria-label="Permalink to &quot;三台虚拟机&quot;">​</a></h4><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">192.168.8.150（磁盘节点）</span></span>
<span class="line"><span style="color:#B392F0;">192.168.8.45</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">（内存节点）</span></span>
<span class="line"><span style="color:#B392F0;">192.168.8.40</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">（内存节点）</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">192.168.8.150（磁盘节点）</span></span>
<span class="line"><span style="color:#6F42C1;">192.168.8.45</span><span style="color:#24292E;"> </span><span style="color:#032F62;">（内存节点）</span></span>
<span class="line"><span style="color:#6F42C1;">192.168.8.40</span><span style="color:#24292E;"> </span><span style="color:#032F62;">（内存节点）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="一、安装erlang" tabindex="-1">一、安装Erlang <a class="header-anchor" href="#一、安装erlang" aria-label="Permalink to &quot;一、安装Erlang&quot;">​</a></h4><h5 id="_1、erlang-下载地址" tabindex="-1">1、erlang 下载地址： <a class="header-anchor" href="#_1、erlang-下载地址" aria-label="Permalink to &quot;1、erlang 下载地址：&quot;">​</a></h5><p><a href="http://www.rabbitmq.com/releases/erlang/" target="_blank" rel="noreferrer">http://www.rabbitmq.com/releases/erlang/</a></p><h5 id="_2、创建目录" tabindex="-1">2、创建目录 <a class="header-anchor" href="#_2、创建目录" aria-label="Permalink to &quot;2、创建目录&quot;">​</a></h5><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# mkdir -p /usr/local/tools/rabbitmq</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# cd /usr/local/tools/rabbitmq</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# mkdir -p /usr/local/tools/rabbitmq</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# cd /usr/local/tools/rabbitmq</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="_3、下载安装包" tabindex="-1">3、下载安装包 <a class="header-anchor" href="#_3、下载安装包" aria-label="Permalink to &quot;3、下载安装包&quot;">​</a></h5><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# wget http://www.rabbitmq.com/releases/erlang/erlang-19.0.4-1.el6.x86_64.rpm</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# wget http://www.rabbitmq.com/releases/erlang/erlang-19.0.4-1.el6.x86_64.rpm</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h5 id="_4、安装" tabindex="-1">4、安装 <a class="header-anchor" href="#_4、安装" aria-label="Permalink to &quot;4、安装&quot;">​</a></h5><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# rpm -ivh erlang-19.0.4-1.el6.x86_64.rpm</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# rpm -ivh erlang-19.0.4-1.el6.x86_64.rpm</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="二、安装rabbitmq" tabindex="-1">二、安装RabbitMQ <a class="header-anchor" href="#二、安装rabbitmq" aria-label="Permalink to &quot;二、安装RabbitMQ&quot;">​</a></h3><h4 id="_1、rabbitmq-下载地址" tabindex="-1">1、rabbitMQ 下载地址 <a class="header-anchor" href="#_1、rabbitmq-下载地址" aria-label="Permalink to &quot;1、rabbitMQ 下载地址&quot;">​</a></h4><p><a href="https://dl.bintray.com/rabbitmq/rabbitmq-server-rpm/" target="_blank" rel="noreferrer">https://dl.bintray.com/rabbitmq/rabbitmq-server-rpm/</a></p><h4 id="_2、下载安装包" tabindex="-1">2、下载安装包 <a class="header-anchor" href="#_2、下载安装包" aria-label="Permalink to &quot;2、下载安装包&quot;">​</a></h4><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# wget https://dl.bintray.com/rabbitmq/rabbitmq-server-rpm/rabbitmq-server-3.6.12-1.el6.noarch.rpm</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# wget https://dl.bintray.com/rabbitmq/rabbitmq-server-rpm/rabbitmq-server-3.6.12-1.el6.noarch.rpm</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_3、安装" tabindex="-1">3、安装 <a class="header-anchor" href="#_3、安装" aria-label="Permalink to &quot;3、安装&quot;">​</a></h4><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]#  rpm -ivh rabbitmq-server-3.6.12-1.el6.noarch.rpm</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]#  rpm -ivh rabbitmq-server-3.6.12-1.el6.noarch.rpm</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="问题解决" tabindex="-1">问题解决 <a class="header-anchor" href="#问题解决" aria-label="Permalink to &quot;问题解决&quot;">​</a></h4><p>1、错误：依赖检测失败： socat 被 rabbitmq-server-3.6.12-1.el6.noarch 需要</p><h5 id="解决报错" tabindex="-1">解决报错： <a class="header-anchor" href="#解决报错" aria-label="Permalink to &quot;解决报错：&quot;">​</a></h5><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]#  wget –no-cache http://www.convirture.com/repos/definitions/rhel/6.x/convirt.repo -O /etc/yum.repos.d/convirt.repo</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]#  yum makecache -y</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]#  yum install socat -y</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]#  wget –no-cache http://www.convirture.com/repos/definitions/rhel/6.x/convirt.repo -O /etc/yum.repos.d/convirt.repo</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]#  yum makecache -y</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]#  yum install socat -y</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="_2、如果yum源有问题-无法安装-将centos的yum源更换为国内的阿里云源" tabindex="-1">2、如果yum源有问题，无法安装：将CentOS的yum源更换为国内的阿里云源 <a class="header-anchor" href="#_2、如果yum源有问题-无法安装-将centos的yum源更换为国内的阿里云源" aria-label="Permalink to &quot;2、如果yum源有问题，无法安装：将CentOS的yum源更换为国内的阿里云源&quot;">​</a></h5><p>使用yum时File contains no section headers.解决办法 <a href="http://xiaojingjing.iteye.com/blog/2393165" target="_blank" rel="noreferrer">http://xiaojingjing.iteye.com/blog/2393165</a></p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]#  rm -f /etc/yum.repos.d/</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# yum clean all</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]#  rm -f /etc/yum.repos.d/</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# yum clean all</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="三、集群配置" tabindex="-1">三、集群配置 <a class="header-anchor" href="#三、集群配置" aria-label="Permalink to &quot;三、集群配置&quot;">​</a></h2><h3 id="_1、hosts配置" tabindex="-1">1、hosts配置 <a class="header-anchor" href="#_1、hosts配置" aria-label="Permalink to &quot;1、hosts配置&quot;">​</a></h3><p>三台机器的hosts都配置</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# vim /etc/hosts</span></span>
<span class="line"><span style="color:#B392F0;">192.168.8.150</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rabbit1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">（磁盘节点）</span></span>
<span class="line"><span style="color:#B392F0;">192.168.8.45</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rabbit2（内存节点）</span></span>
<span class="line"><span style="color:#B392F0;">192.168.8.40</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rabbit3（内存节点）</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# vim /etc/hosts</span></span>
<span class="line"><span style="color:#6F42C1;">192.168.8.150</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbit1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">（磁盘节点）</span></span>
<span class="line"><span style="color:#6F42C1;">192.168.8.45</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbit2（内存节点）</span></span>
<span class="line"><span style="color:#6F42C1;">192.168.8.40</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rabbit3（内存节点）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>2、同步.erlang.cookie 保持三台机器的.erlang.cookie同步</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">rabbitmq</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">.erlang.cookie</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">rabbitmq</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">.erlang.cookie</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>在第二台机器8.45执行：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# scp .erlang.cookie root@192.168.8.45:/var/lib/rabbitmq/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# chown rabbitmq:rabbitmq .erlang.cookie</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# scp .erlang.cookie root@192.168.8.45:/var/lib/rabbitmq/</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# chown rabbitmq:rabbitmq .erlang.cookie</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在第三台机器8.40执行：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# scp .erlang.cookie root@192.168.8.40:/var/lib/rabbitmq/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# chown rabbitmq:rabbitmq .erlang.cookie</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# scp .erlang.cookie root@192.168.8.40:/var/lib/rabbitmq/</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# chown rabbitmq:rabbitmq .erlang.cookie</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>重启服务</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# systemctl stop rabbitmq-server.service</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# systemctl start rabbitmq-server.service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# systemctl stop rabbitmq-server.service</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# systemctl start rabbitmq-server.service</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>或：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# systemctl restart rabbitmq-server.service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# systemctl restart rabbitmq-server.service</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>查看服务状态：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# systemctl status rabbitmq-server.service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# systemctl status rabbitmq-server.service</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如果启动报错：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Job for rabbitmq</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">server.service failed because the control process exited </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> error code. See </span><span style="color:#9ECBFF;">&quot;systemctl status rabbitmq-server.service&quot;</span><span style="color:#E1E4E8;"> and </span><span style="color:#9ECBFF;">&quot;journalctl -xe&quot;</span><span style="color:#E1E4E8;"> for details.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Job for rabbitmq</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">server.service failed because the control process exited </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> error code. See </span><span style="color:#032F62;">&quot;systemctl status rabbitmq-server.service&quot;</span><span style="color:#24292E;"> and </span><span style="color:#032F62;">&quot;journalctl -xe&quot;</span><span style="color:#24292E;"> for details.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如果是因为服务停不掉，就要kill 端口。</p><p>3、加入集群 首先开放集群通信端口：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# firewall-cmd --permanent --add-port={</span><span style="color:#B392F0;">5672/tcp,4369/tcp,25672/tcp}</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# firewall-cmd --reload</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# setsebool -P nis_enabled 1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# firewall-cmd --permanent --add-port={</span><span style="color:#6F42C1;">5672/tcp,4369/tcp,25672/tcp}</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# firewall-cmd --reload</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# setsebool -P nis_enabled 1</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在第二台45，第三台机，40上执行：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# rabbitmqctl stop_app</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# rabbitmqctl reset</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# rabbitmqctl join_cluster rabbit@rabbit1 --ram</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# rabbitmqctl stop_app</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# rabbitmqctl reset</span></span>
<span class="line"><span style="color:#24292E;">[root@nogeek ]# rabbitmqctl join_cluster rabbit@rabbit1 --ram</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>创建用户：三台服务器都执行</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]# firewall-cmd --permanent --add-port=15672/tcp</span></span>
<span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]# firewall-cmd –-reload</span></span>
<span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]# rabbitmqctl add_user admin admin</span></span>
<span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]# rabbitmqctl set_user_tags admin administrator</span></span>
<span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]# rabbitmqctl set_permissions -p / admin </span><span style="color:#9ECBFF;">&quot;.&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;.&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;.*&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> [root@nogeek ]# firewall-cmd --permanent --add-port=15672/tcp</span></span>
<span class="line"><span style="color:#24292E;"> [root@nogeek ]# firewall-cmd –-reload</span></span>
<span class="line"><span style="color:#24292E;"> [root@nogeek ]# rabbitmqctl add_user admin admin</span></span>
<span class="line"><span style="color:#24292E;"> [root@nogeek ]# rabbitmqctl set_user_tags admin administrator</span></span>
<span class="line"><span style="color:#24292E;"> [root@nogeek ]# rabbitmqctl set_permissions -p / admin </span><span style="color:#032F62;">&quot;.&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;.*&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>4、 RabbitMQ镜像队列 可以参考： <a href="https://www.cnblogs.com/saneri/p/7798251.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/saneri/p/7798251.html</a></p><p>5、HAProxy + Keepalived 高可用方案</p><p>一、HAProxy 将5672端口映射为5673端口，15672端口映射为15673端口。</p><p>1)在两个内存节点上安装HAProxy</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]#  yum install haproxy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> [root@nogeek ]#  yum install haproxy</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>2)编辑配置文件</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]# vim /etc/haproxy/haproxy.cfg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> [root@nogeek ]# vim /etc/haproxy/haproxy.cfg</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>内容修改为：</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">global</span></span>
<span class="line"><span style="color:#E1E4E8;">    log         </span><span style="color:#FDAEB7;font-style:italic;">127.0.0.1</span><span style="color:#E1E4E8;"> local2</span></span>
<span class="line"><span style="color:#E1E4E8;">    chroot      </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">haproxy</span></span>
<span class="line"><span style="color:#E1E4E8;">    pidfile     </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">run</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">haproxy.pid</span></span>
<span class="line"><span style="color:#E1E4E8;">    maxconn     </span><span style="color:#79B8FF;">4000</span></span>
<span class="line"><span style="color:#E1E4E8;">    user        haproxy</span></span>
<span class="line"><span style="color:#E1E4E8;">    group       haproxy</span></span>
<span class="line"><span style="color:#E1E4E8;">    daemon</span></span>
<span class="line"><span style="color:#E1E4E8;">    stats socket </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">haproxy</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">stats</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span></span>
<span class="line"><span style="color:#E1E4E8;">defaults</span></span>
<span class="line"><span style="color:#E1E4E8;">    log                     global</span></span>
<span class="line"><span style="color:#E1E4E8;">    option                  dontlognull</span></span>
<span class="line"><span style="color:#E1E4E8;">    option                  redispatch</span></span>
<span class="line"><span style="color:#E1E4E8;">    retries                 </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">    timeout connect         </span><span style="color:#FDAEB7;font-style:italic;">10s</span></span>
<span class="line"><span style="color:#E1E4E8;">    timeout client          </span><span style="color:#FDAEB7;font-style:italic;">1m</span></span>
<span class="line"><span style="color:#E1E4E8;">    timeout server          </span><span style="color:#FDAEB7;font-style:italic;">1m</span></span>
<span class="line"><span style="color:#E1E4E8;">    maxconn                 </span><span style="color:#79B8FF;">3000</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span></span>
<span class="line"><span style="color:#E1E4E8;">listen http_front</span></span>
<span class="line"><span style="color:#E1E4E8;">        mode http</span></span>
<span class="line"><span style="color:#E1E4E8;">        bind </span><span style="color:#FDAEB7;font-style:italic;">0.0.0.0</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">1080</span><span style="color:#E1E4E8;">           #监听端口</span></span>
<span class="line"><span style="color:#E1E4E8;">        stats refresh </span><span style="color:#FDAEB7;font-style:italic;">30s</span><span style="color:#E1E4E8;">           #统计页面自动刷新时间</span></span>
<span class="line"><span style="color:#E1E4E8;">        stats uri </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">haproxy</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">stats    #统计页面url</span></span>
<span class="line"><span style="color:#E1E4E8;">        stats realm Haproxy Manager #统计页面密码框上提示文本</span></span>
<span class="line"><span style="color:#E1E4E8;">        stats auth admin</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">123456</span><span style="color:#E1E4E8;">     #统计页面用户名和密码设置</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span></span>
<span class="line"><span style="color:#E1E4E8;">listen rabbitmq_admin</span></span>
<span class="line"><span style="color:#E1E4E8;">    bind </span><span style="color:#FDAEB7;font-style:italic;">0.0.0.0</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">15673</span></span>
<span class="line"><span style="color:#E1E4E8;">    server node1 </span><span style="color:#FDAEB7;font-style:italic;">192.168.8.40</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">15672</span></span>
<span class="line"><span style="color:#E1E4E8;">    server node2 </span><span style="color:#FDAEB7;font-style:italic;">192.168.8.45</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">15672</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span></span>
<span class="line"><span style="color:#E1E4E8;">listen rabbitmq_cluster </span><span style="color:#FDAEB7;font-style:italic;">0.0.0.0</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">5673</span></span>
<span class="line"><span style="color:#E1E4E8;">    mode tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">    balance roundrobin</span></span>
<span class="line"><span style="color:#E1E4E8;">    timeout client </span><span style="color:#FDAEB7;font-style:italic;">3h</span></span>
<span class="line"><span style="color:#E1E4E8;">    timeout server </span><span style="color:#FDAEB7;font-style:italic;">3h</span></span>
<span class="line"><span style="color:#E1E4E8;">    timeout connect </span><span style="color:#FDAEB7;font-style:italic;">3h</span></span>
<span class="line"><span style="color:#E1E4E8;">    server   node1 </span><span style="color:#FDAEB7;font-style:italic;">192.168.8.40</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">5672</span><span style="color:#E1E4E8;"> check inter </span><span style="color:#FDAEB7;font-style:italic;">5s</span><span style="color:#E1E4E8;"> rise </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> fall </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">    server   node2 </span><span style="color:#FDAEB7;font-style:italic;">192.168.8.45</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">5672</span><span style="color:#E1E4E8;"> check inter </span><span style="color:#FDAEB7;font-style:italic;">5s</span><span style="color:#E1E4E8;"> rise </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> fall </span><span style="color:#79B8FF;">3</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">global</span></span>
<span class="line"><span style="color:#24292E;">    log         </span><span style="color:#B31D28;font-style:italic;">127.0.0.1</span><span style="color:#24292E;"> local2</span></span>
<span class="line"><span style="color:#24292E;">    chroot      </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">haproxy</span></span>
<span class="line"><span style="color:#24292E;">    pidfile     </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">run</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">haproxy.pid</span></span>
<span class="line"><span style="color:#24292E;">    maxconn     </span><span style="color:#005CC5;">4000</span></span>
<span class="line"><span style="color:#24292E;">    user        haproxy</span></span>
<span class="line"><span style="color:#24292E;">    group       haproxy</span></span>
<span class="line"><span style="color:#24292E;">    daemon</span></span>
<span class="line"><span style="color:#24292E;">    stats socket </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">haproxy</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">stats</span></span>
<span class="line"><span style="color:#24292E;">	</span></span>
<span class="line"><span style="color:#24292E;">defaults</span></span>
<span class="line"><span style="color:#24292E;">    log                     global</span></span>
<span class="line"><span style="color:#24292E;">    option                  dontlognull</span></span>
<span class="line"><span style="color:#24292E;">    option                  redispatch</span></span>
<span class="line"><span style="color:#24292E;">    retries                 </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">    timeout connect         </span><span style="color:#B31D28;font-style:italic;">10s</span></span>
<span class="line"><span style="color:#24292E;">    timeout client          </span><span style="color:#B31D28;font-style:italic;">1m</span></span>
<span class="line"><span style="color:#24292E;">    timeout server          </span><span style="color:#B31D28;font-style:italic;">1m</span></span>
<span class="line"><span style="color:#24292E;">    maxconn                 </span><span style="color:#005CC5;">3000</span></span>
<span class="line"><span style="color:#24292E;">	</span></span>
<span class="line"><span style="color:#24292E;">listen http_front</span></span>
<span class="line"><span style="color:#24292E;">        mode http</span></span>
<span class="line"><span style="color:#24292E;">        bind </span><span style="color:#B31D28;font-style:italic;">0.0.0.0</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">1080</span><span style="color:#24292E;">           #监听端口</span></span>
<span class="line"><span style="color:#24292E;">        stats refresh </span><span style="color:#B31D28;font-style:italic;">30s</span><span style="color:#24292E;">           #统计页面自动刷新时间</span></span>
<span class="line"><span style="color:#24292E;">        stats uri </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">haproxy</span><span style="color:#D73A49;">?</span><span style="color:#24292E;">stats    #统计页面url</span></span>
<span class="line"><span style="color:#24292E;">        stats realm Haproxy Manager #统计页面密码框上提示文本</span></span>
<span class="line"><span style="color:#24292E;">        stats auth admin</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">123456</span><span style="color:#24292E;">     #统计页面用户名和密码设置</span></span>
<span class="line"><span style="color:#24292E;">		</span></span>
<span class="line"><span style="color:#24292E;">listen rabbitmq_admin</span></span>
<span class="line"><span style="color:#24292E;">    bind </span><span style="color:#B31D28;font-style:italic;">0.0.0.0</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">15673</span></span>
<span class="line"><span style="color:#24292E;">    server node1 </span><span style="color:#B31D28;font-style:italic;">192.168.8.40</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">15672</span></span>
<span class="line"><span style="color:#24292E;">    server node2 </span><span style="color:#B31D28;font-style:italic;">192.168.8.45</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">15672</span></span>
<span class="line"><span style="color:#24292E;">	</span></span>
<span class="line"><span style="color:#24292E;">listen rabbitmq_cluster </span><span style="color:#B31D28;font-style:italic;">0.0.0.0</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">5673</span></span>
<span class="line"><span style="color:#24292E;">    mode tcp</span></span>
<span class="line"><span style="color:#24292E;">    balance roundrobin</span></span>
<span class="line"><span style="color:#24292E;">    timeout client </span><span style="color:#B31D28;font-style:italic;">3h</span></span>
<span class="line"><span style="color:#24292E;">    timeout server </span><span style="color:#B31D28;font-style:italic;">3h</span></span>
<span class="line"><span style="color:#24292E;">    timeout connect </span><span style="color:#B31D28;font-style:italic;">3h</span></span>
<span class="line"><span style="color:#24292E;">    server   node1 </span><span style="color:#B31D28;font-style:italic;">192.168.8.40</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">5672</span><span style="color:#24292E;"> check inter </span><span style="color:#B31D28;font-style:italic;">5s</span><span style="color:#24292E;"> rise </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> fall </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">    server   node2 </span><span style="color:#B31D28;font-style:italic;">192.168.8.45</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">5672</span><span style="color:#24292E;"> check inter </span><span style="color:#B31D28;font-style:italic;">5s</span><span style="color:#24292E;"> rise </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> fall </span><span style="color:#005CC5;">3</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>3)启动HAProxy</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]# haproxy -f /etc/haproxy/haproxy.cfg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> [root@nogeek ]# haproxy -f /etc/haproxy/haproxy.cfg</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>二、在两个内存节点上安装Keepalived VIP 为 192.168.8.201</p><p>1)安装Keepalived</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]# yum -y install keepalived</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> [root@nogeek ]# yum -y install keepalived</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>2)修改配置文件</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> [root@nogeek ]# vim /etc/keepalived/keepalived.conf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> [root@nogeek ]# vim /etc/keepalived/keepalived.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>内容改成（物理网卡和当前主机IP要修改）：</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">global_defs {</span></span>
<span class="line"><span style="color:#E1E4E8;">   notification_email {</span></span>
<span class="line"><span style="color:#E1E4E8;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">   smtp_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.1</span></span>
<span class="line"><span style="color:#E1E4E8;">   smtp_connect_timeout </span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">   router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#E1E4E8;">   # vrrp_strict    # 注释掉，不然访问不到VIP</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_garp_interval </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_gna_interval </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">global_defs {</span></span>
<span class="line"><span style="color:#E1E4E8;">   notification_email {</span></span>
<span class="line"><span style="color:#E1E4E8;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">   }</span></span>
<span class="line"><span style="color:#E1E4E8;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#E1E4E8;">   smtp_server </span><span style="color:#FDAEB7;font-style:italic;">192.168.200.1</span></span>
<span class="line"><span style="color:#E1E4E8;">   smtp_connect_timeout </span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">   router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#E1E4E8;">   # vrrp_strict    # 注释掉，不然访问不到VIP</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_garp_interval </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">   vrrp_gna_interval </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># 检测任务</span></span>
<span class="line"><span style="color:#E1E4E8;">vrrp_script check_haproxy {</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 检测HAProxy脚本</span></span>
<span class="line"><span style="color:#E1E4E8;">    script </span><span style="color:#9ECBFF;">&quot;/etc/keepalived/script/check_haproxy.sh&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 每隔两秒检测</span></span>
<span class="line"><span style="color:#E1E4E8;">    interval </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 权重</span></span>
<span class="line"><span style="color:#E1E4E8;">    weight </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># 虚拟组</span></span>
<span class="line"><span style="color:#E1E4E8;">vrrp_instance haproxy {</span></span>
<span class="line"><span style="color:#E1E4E8;">    state MASTER # 此处为\`主\`，备机是 \`BACKUP\`【此处要修改】</span></span>
<span class="line"><span style="color:#E1E4E8;">    interface ens33 # 物理网卡，根据情况而定 【此处要修改】</span></span>
<span class="line"><span style="color:#E1E4E8;">    mcast_src_ip </span><span style="color:#FDAEB7;font-style:italic;">192.168.8.40</span><span style="color:#E1E4E8;"> # 当前主机ip 【此处要修改】</span></span>
<span class="line"><span style="color:#E1E4E8;">    virtual_router_id </span><span style="color:#79B8FF;">51</span><span style="color:#E1E4E8;"> # 虚拟路由id，同一个组内需要相同</span></span>
<span class="line"><span style="color:#E1E4E8;">    priority </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> # 主机的优先权要比备机高</span></span>
<span class="line"><span style="color:#E1E4E8;">    advert_int </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> # 心跳检查频率，单位：秒</span></span>
<span class="line"><span style="color:#E1E4E8;">    authentication { # 认证，组内的要相同</span></span>
<span class="line"><span style="color:#E1E4E8;">        auth_type PASS</span></span>
<span class="line"><span style="color:#E1E4E8;">        auth_pass </span><span style="color:#79B8FF;">1111</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 调用脚本</span></span>
<span class="line"><span style="color:#E1E4E8;">    track_script {</span></span>
<span class="line"><span style="color:#E1E4E8;">        check_haproxy</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    # 虚拟ip，多个换行</span></span>
<span class="line"><span style="color:#E1E4E8;">    virtual_ipaddress {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FDAEB7;font-style:italic;">192.168.8.201</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">global_defs {</span></span>
<span class="line"><span style="color:#24292E;">   notification_email {</span></span>
<span class="line"><span style="color:#24292E;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">   smtp_server </span><span style="color:#B31D28;font-style:italic;">192.168.200.1</span></span>
<span class="line"><span style="color:#24292E;">   smtp_connect_timeout </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">   router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#24292E;">   # vrrp_strict    # 注释掉，不然访问不到VIP</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_garp_interval </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_gna_interval </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">global_defs {</span></span>
<span class="line"><span style="color:#24292E;">   notification_email {</span></span>
<span class="line"><span style="color:#24292E;">     acassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">     failover@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">     sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">   }</span></span>
<span class="line"><span style="color:#24292E;">   notification_email_from Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#24292E;">   smtp_server </span><span style="color:#B31D28;font-style:italic;">192.168.200.1</span></span>
<span class="line"><span style="color:#24292E;">   smtp_connect_timeout </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">   router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#24292E;">   # vrrp_strict    # 注释掉，不然访问不到VIP</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_garp_interval </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">   vrrp_gna_interval </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># 检测任务</span></span>
<span class="line"><span style="color:#24292E;">vrrp_script check_haproxy {</span></span>
<span class="line"><span style="color:#24292E;">    # 检测HAProxy脚本</span></span>
<span class="line"><span style="color:#24292E;">    script </span><span style="color:#032F62;">&quot;/etc/keepalived/script/check_haproxy.sh&quot;</span></span>
<span class="line"><span style="color:#24292E;">    # 每隔两秒检测</span></span>
<span class="line"><span style="color:#24292E;">    interval </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">    # 权重</span></span>
<span class="line"><span style="color:#24292E;">    weight </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># 虚拟组</span></span>
<span class="line"><span style="color:#24292E;">vrrp_instance haproxy {</span></span>
<span class="line"><span style="color:#24292E;">    state MASTER # 此处为\`主\`，备机是 \`BACKUP\`【此处要修改】</span></span>
<span class="line"><span style="color:#24292E;">    interface ens33 # 物理网卡，根据情况而定 【此处要修改】</span></span>
<span class="line"><span style="color:#24292E;">    mcast_src_ip </span><span style="color:#B31D28;font-style:italic;">192.168.8.40</span><span style="color:#24292E;"> # 当前主机ip 【此处要修改】</span></span>
<span class="line"><span style="color:#24292E;">    virtual_router_id </span><span style="color:#005CC5;">51</span><span style="color:#24292E;"> # 虚拟路由id，同一个组内需要相同</span></span>
<span class="line"><span style="color:#24292E;">    priority </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> # 主机的优先权要比备机高</span></span>
<span class="line"><span style="color:#24292E;">    advert_int </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> # 心跳检查频率，单位：秒</span></span>
<span class="line"><span style="color:#24292E;">    authentication { # 认证，组内的要相同</span></span>
<span class="line"><span style="color:#24292E;">        auth_type PASS</span></span>
<span class="line"><span style="color:#24292E;">        auth_pass </span><span style="color:#005CC5;">1111</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    # 调用脚本</span></span>
<span class="line"><span style="color:#24292E;">    track_script {</span></span>
<span class="line"><span style="color:#24292E;">        check_haproxy</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    # 虚拟ip，多个换行</span></span>
<span class="line"><span style="color:#24292E;">    virtual_ipaddress {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#B31D28;font-style:italic;">192.168.8.201</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>3)启动keepalived</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@nogeek ]# keepalived -D</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@nogeek ]# keepalived -D</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div>`,72),o=[p];function r(t,c,i,E,y,b){return a(),n("div",null,o)}const u=s(e,[["render",r]]);export{m as __pageData,u as default};
